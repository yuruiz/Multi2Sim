cscope 15 $HOME/m2s/multi2sim-4.2/src/arch/x86/timing               0000175820
	@bpred.c

21 
	~<lib/mh™dÀ/mh™dÀ.h
>

22 
	~<lib/utû/c⁄fig.h
>

23 
	~<lib/utû/debug.h
>

24 
	~<lib/utû/misc.h
>

25 
	~<lib/utû/°rög.h
>

27 
	~"b¥ed.h
"

28 
	~"thªad.h
"

29 
	~"u›.h
"

39 
	$X86ThªadInôBønchPªd
(
X86Thªad
 *
£lf
)

41 
«me
[
MAX_STRING_SIZE
];

43 
	`¢¥ötf
(
«me
, Çame, "%s.b¥ed", 
£lf
->name);

44 
£lf
->
b¥ed
 = 
	`x86_b¥ed_¸óã
(
«me
);

45 
	}
}

48 
	$X86ThªadFªeBønchPªd
(
X86Thªad
 *
£lf
)

50 
	`x86_b¥ed_‰ì
(
£lf
->
b¥ed
);

51 
	}
}

55 
	$X86ThªadLookupBønchPªd
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
)

57 
x86_b¥ed_t
 *
b¥ed
 = 
£lf
->bpred;

63 
	`as£π
(
u›
->
Êags
 & 
X86_UINST_CTRL
);

64 i‡(
u›
->
Êags
 & 
X86_UINST_UNCOND
)

66 
u›
->
¥ed
 = 1;

71 i‡(
u›
->
uö°
->
›code
 =
x86_uö°_ibønch
)

73 
u›
->
¥ed
 = 1;

78 i‡(
x86_b¥ed_köd
 =
x86_b¥ed_köd_≥r„˘
)

79 
u›
->
¥ed
 = u›->
√ù
 !u›->
eù
 + u›->
m›_size
;

82 i‡(
x86_b¥ed_köd
 =
x86_b¥ed_köd_èkí
)

83 
u›
->
¥ed
 = 1;

86 i‡(
x86_b¥ed_köd
 =
x86_b¥ed_köd_nŸèkí
)

87 
u›
->
¥ed
 = 0;

90 i‡(
x86_b¥ed_köd
 =
x86_b¥ed_köd_bimod
 || x86_b¥ed_köd =
x86_b¥ed_köd_comb
)

92 
u›
->
bimod_ödex
 = u›->
eù
 & (
x86_b¥ed_bimod_size
 - 1);

93 
u›
->
bimod_¥ed
 = 
b¥ed
->
bimod
[u›->
bimod_ödex
] > 1;

94 
u›
->
¥ed
 = u›->
bimod_¥ed
;

98 i‡(
x86_b¥ed_köd
 =
x86_b¥ed_köd_twﬁevñ
 || x86_b¥ed_köd =
x86_b¥ed_köd_comb
)

100 
u›
->
twﬁevñ_bht_ödex
 = u›->
eù
 & (
x86_b¥ed_twﬁevñ_l1size
 - 1);

101 
u›
->
twﬁevñ_pht_row
 = 
b¥ed
->
twﬁevñ_bht
[u›->
twﬁevñ_bht_ödex
];

102 
	`as£π
(
u›
->
twﬁevñ_pht_row
 < 
x86_b¥ed_twﬁevñ_l2height
);

103 
u›
->
twﬁevñ_pht_cﬁ
 = u›->
eù
 & (
x86_b¥ed_twﬁevñ_l2size
 - 1);

104 
u›
->
twﬁevñ_¥ed
 = 
b¥ed
->
twﬁevñ_pht
[u›->
twﬁevñ_pht_row
 *

105 
x86_b¥ed_twﬁevñ_l2size
 + 
u›
->
twﬁevñ_pht_cﬁ
] > 1;

106 
u›
->
¥ed
 = u›->
twﬁevñ_¥ed
;

110 i‡(
x86_b¥ed_köd
 =
x86_b¥ed_köd_comb
)

112 
u›
->
choi˚_ödex
 = u›->
eù
 & (
x86_b¥ed_choi˚_size
 - 1);

113 
u›
->
choi˚_¥ed
 = 
b¥ed
->
choi˚
[u›->
choi˚_ödex
] > 1;

114 
u›
->
¥ed
 = u›->
choi˚_¥ed
 ? u›->
twﬁevñ_¥ed
 : u›->
bimod_¥ed
;

118 
	`as£π
(!
u›
->
¥ed
 || uop->pred == 1);

119  
u›
->
¥ed
;

120 
	}
}

127 
	$X86ThªadLookupBønchPªdMu…ùÀ
(
X86Thªad
 *
£lf
, 
eù
, 
cou¡
)

129 
x86_b¥ed_t
 *
b¥ed
 = 
£lf
->bpred;

131 
i
, 
¥ed
, 
ãmp_¥ed
;

132 
bht_ödex
, 
pht_cﬁ
;

133 
bhr
;

138 
	`as£π
(
x86_b¥ed_köd
 =
x86_b¥ed_köd_twﬁevñ
);

139 
bht_ödex
 = 
eù
 & (
x86_b¥ed_twﬁevñ_l1size
 - 1);

140 
bhr
 = 
b¥ed
->
twﬁevñ_bht
[
bht_ödex
];

141 
	`as£π
(
bhr
 < 
x86_b¥ed_twﬁevñ_l2height
);

142 
pht_cﬁ
 = 
eù
 & (
x86_b¥ed_twﬁevñ_l2size
 - 1);

143 
¥ed
 = 
ãmp_¥ed
 = 
b¥ed
->
twﬁevñ_pht
[
bhr
 * 
x86_b¥ed_twﬁevñ_l2size
 + 
pht_cﬁ
] > 1;

146 
i
 = 1; i < 
cou¡
; i++)

148 
bhr
 = ((bh∏<< 1Ë| 
ãmp_¥ed
Ë& (
x86_b¥ed_twﬁevñ_l2height
 - 1);

149 
ãmp_¥ed
 = 
b¥ed
->
twﬁevñ_pht
[
bhr
 * 
x86_b¥ed_twﬁevñ_l2size
 + 
pht_cﬁ
] > 1;

150 
	`as£π
(!
ãmp_¥ed
 ||Åemp_pred == 1);

151 
¥ed
 |
ãmp_¥ed
 << 
i
;

155  
¥ed
;

156 
	}
}

159 
	$X86ThªadUpd©eBønchPªd
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
)

161 
x86_b¥ed_t
 *
b¥ed
 = 
£lf
->bpred;

162 
èkí
;

163 *
p˘r
;

164 *
pbhr
;

166 
	`as£π
(!
u›
->
•ecmode
);

167 
	`as£π
(
u›
->
Êags
 & 
X86_UINST_CTRL
);

168 
èkí
 = 
u›
->
√ù
 !u›->
eù
 + u›->
m›_size
;

171 
b¥ed
->
ac˚s£s
++;

172 i‡(
u›
->
√ù
 =u›->
¥ed_√ù
)

173 
b¥ed
->
hôs
++;

178 i‡(
x86_b¥ed_köd
 =
x86_b¥ed_köd_≥r„˘
)

180 i‡(
u›
->
Êags
 & 
X86_UINST_UNCOND
)

184 i‡(
x86_b¥ed_köd
 =
x86_b¥ed_köd_bimod
 ||

185 (
x86_b¥ed_köd
 =
x86_b¥ed_köd_comb
 && !
u›
->
choi˚_¥ed
))

187 
p˘r
 = &
b¥ed
->
bimod
[
u›
->
bimod_ödex
];

188 *
p˘r
 = 
èkí
 ? 
	`MIN
(*p˘∏+ 1, 3Ë: 
	`MAX
(*pctr - 1, 0);

192 i‡(
x86_b¥ed_köd
 =
x86_b¥ed_köd_twﬁevñ
 ||

193 (
x86_b¥ed_köd
 =
x86_b¥ed_köd_comb
 && 
u›
->
choi˚_¥ed
))

196 
pbhr
 = &
b¥ed
->
twﬁevñ_bht
[
u›
->
twﬁevñ_bht_ödex
];

197 *
pbhr
 = ((*pbh∏<< 1Ë| 
èkí
Ë& (
x86_b¥ed_twﬁevñ_l2height
 - 1);

200 
p˘r
 = &
b¥ed
->
twﬁevñ_pht
[
u›
->
twﬁevñ_pht_row
 *

201 
x86_b¥ed_twﬁevñ_l2size
 + 
u›
->
twﬁevñ_pht_cﬁ
];

202 *
p˘r
 = 
èkí
 ? 
	`MIN
(*p˘∏+ 1, 3Ë: 
	`MAX
(*pctr - 1, 0);

207 i‡(
x86_b¥ed_köd
 =
x86_b¥ed_köd_comb
 && 
u›
->
bimod_¥ed
 !u›->
twﬁevñ_¥ed
) {

208 
p˘r
 = &
b¥ed
->
choi˚
[
u›
->
choi˚_ödex
];

209 *
p˘r
 = 
u›
->
bimod_¥ed
 =
èkí
 ? 
	`MAX
(*p˘∏- 1, 0Ë: 
	`MIN
(*pctr + 1, 3);

211 
	}
}

217 
	$X86ThªadLookupBTB
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
)

219 
x86_b¥ed_t
 *
b¥ed
 = 
£lf
->bpred;

220 
x86_b¥ed_btb_íåy_t
 *
íåy
;

221 
way
, 
£t
, 
èrgë
 = 0;

222 
hô
 = 0;

224 
	`as£π
(
u›
->
Êags
 & 
X86_UINST_CTRL
);

227 i‡(
x86_b¥ed_köd
 =
x86_b¥ed_köd_≥r„˘
)

228  
u›
->
√ù
;

231 i‡(
u›
->
uö°
->
›code
 =
x86_uö°_ibønch
)

232  
u›
->
eù
;

235 
£t
 = 
u›
->
eù
 & (
x86_b¥ed_btb_£ts
 - 1);

236 
way
 = 0; way < 
x86_b¥ed_btb_assoc
; way++)

238 
íåy
 = 
	`X86_BPRED_BTB_ENTRY
(
£t
, 
way
);

239 i‡(
íåy
->
sour˚
 !
u›
->
eù
)

241 
èrgë
 = 
íåy
->target;

242 
hô
 = 1;

249 i‡(
hô
 && 
u›
->
uö°
->
›code
 =
x86_uö°_ˇŒ
 && !u›->
•ecmode
)

251 
b¥ed
->
øs
[b¥ed->
øs_ödex
] = 
u›
->
eù
 + u›->
m›_size
;

252 
b¥ed
->
øs_ödex
 = (b¥ed->øs_ödex + 1Ë% 
x86_b¥ed_øs_size
;

257 i‡(
hô
 && 
u›
->
uö°
->
›code
 =
x86_uö°_ªt
 && !u›->
•ecmode
)

259 
b¥ed
->
øs_ödex
 = (b¥ed->øs_ödex + 
x86_b¥ed_øs_size
 - 1) % x86_bpred_ras_size;

260 
èrgë
 = 
b¥ed
->
øs
[b¥ed->
øs_ödex
];

264  
èrgë
;

265 
	}
}

269 
	$X86ThªadUpd©eBTB
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
)

271 
x86_b¥ed_t
 *
b¥ed
 = 
£lf
->bpred;

272 
x86_b¥ed_btb_íåy_t
 *
íåy
, *
found
 = 
NULL
;

273 
way
, 
£t
;

276 i‡(
x86_b¥ed_köd
 =
x86_b¥ed_köd_≥r„˘
)

280 
£t
 = 
u›
->
eù
 & (
x86_b¥ed_btb_£ts
 - 1);

281 
way
 = 0; way < 
x86_b¥ed_btb_assoc
; way++)

283 
íåy
 = 
	`X86_BPRED_BTB_ENTRY
(
£t
, 
way
);

284 i‡(
íåy
->
sour˚
 =
u›
->
eù
)

286 
found
 = 
íåy
;

292 i‡(!
found
)

294 
way
 = 0; way < 
x86_b¥ed_btb_assoc
; way++)

296 
íåy
 = 
	`X86_BPRED_BTB_ENTRY
(
£t
, 
way
);

297 
íåy
->
cou¡î
--;

298 i‡(
íåy
->
cou¡î
 < 0) {

299 
íåy
->
cou¡î
 = 
x86_b¥ed_btb_assoc
 - 1;

300 
íåy
->
sour˚
 = 
u›
->
eù
;

301 
íåy
->
èrgë
 = 
u›
->
√ù
;

307 i‡(
found
)

309 
way
 = 0; way < 
x86_b¥ed_btb_assoc
; way++)

311 
íåy
 = 
	`X86_BPRED_BTB_ENTRY
(
£t
, 
way
);

312 i‡(
íåy
->
cou¡î
 > 
found
->counter)

313 
íåy
->
cou¡î
--;

315 
found
->
cou¡î
 = 
x86_b¥ed_btb_assoc
 - 1;

316 
found
->
èrgë
 = 
u›
->
√ù
;

318 
	}
}

325 
	$X86ThªadGëNextBønch
(
X86Thªad
 *
£lf
, 
eù
, 
bsize
)

327 
x86_b¥ed_t
 *
b¥ed
 = 
£lf
->bpred;

328 
x86_b¥ed_btb_íåy_t
 *
íåy
;

329 
limô
;

330 
£t
, 
way
;

332 
	`as£π
(!(
bsize
 & (bsize - 1)));

333 
limô
 = (
eù
 + 
bsize
) & ~(bsize - 1);

334 
eù
 < 
limô
)

336 
£t
 = 
eù
 & (
x86_b¥ed_btb_£ts
 - 1);

337 
way
 = 0; way < 
x86_b¥ed_btb_assoc
; way++)

339 
íåy
 = 
	`X86_BPRED_BTB_ENTRY
(
£t
, 
way
);

340 i‡(
íåy
->
sour˚
 =
eù
)

341  
eù
;

343 
eù
++;

346 
	}
}

355 
x86_b¥ed_t
 *
	$x86_b¥ed_¸óã
(*
«me
)

357 
x86_b¥ed_t
 *
b¥ed
;

359 
i
;

360 
j
;

363 
b¥ed
 = 
	`xˇŒoc
(1, (
x86_b¥ed_t
));

364 
b¥ed
->
«me
 = 
	`x°rdup
(name);

365 
b¥ed
->
øs
 = 
	`xˇŒoc
(
x86_b¥ed_øs_size
, ());

368 i‡(
x86_b¥ed_köd
 =
x86_b¥ed_köd_bimod
 || x86_b¥ed_köd =
x86_b¥ed_köd_comb
)

370 
b¥ed
->
bimod
 = 
	`xˇŒoc
(
x86_b¥ed_bimod_size
, ());

371 
i
 = 0; i < 
x86_b¥ed_bimod_size
; i++)

372 
b¥ed
->
bimod
[
i
] = 2;

376 i‡(
x86_b¥ed_köd
 =
x86_b¥ed_köd_twﬁevñ
 || x86_b¥ed_köd =
x86_b¥ed_köd_comb
)

378 
b¥ed
->
twﬁevñ_bht
 = 
	`xˇŒoc
(
x86_b¥ed_twﬁevñ_l1size
, ());

379 
b¥ed
->
twﬁevñ_pht
 = 
	`xˇŒoc
(
x86_b¥ed_twﬁevñ_l2size
 * 
x86_b¥ed_twﬁevñ_l2height
, ());

380 
i
 = 0; i < 
x86_b¥ed_twﬁevñ_l2size
 * 
x86_b¥ed_twﬁevñ_l2height
; i++)

381 
b¥ed
->
twﬁevñ_pht
[
i
] = 2;

385 i‡(
x86_b¥ed_köd
 =
x86_b¥ed_köd_comb
)

387 
b¥ed
->
choi˚
 = 
	`xˇŒoc
(
x86_b¥ed_choi˚_size
, ());

388 
i
 = 0; i < 
x86_b¥ed_choi˚_size
; i++)

389 
b¥ed
->
choi˚
[
i
] = 2;

393 
b¥ed
->
btb
 = 
	`xˇŒoc
(
x86_b¥ed_btb_£ts
 * 
x86_b¥ed_btb_assoc
, (
x86_b¥ed_btb_íåy_t
));

394 
i
 = 0; i < 
x86_b¥ed_btb_£ts
; i++)

395 
j
 = 0; j < 
x86_b¥ed_btb_assoc
; j++)

396 
	`X86_BPRED_BTB_ENTRY
(
i
, 
j
)->
cou¡î
 = j;

399  
b¥ed
;

400 
	}
}

403 
	$x86_b¥ed_‰ì
(
x86_b¥ed_t
 *
b¥ed
)

406 i‡(
x86_b¥ed_köd
 =
x86_b¥ed_köd_bimod
 || x86_b¥ed_köd =
x86_b¥ed_köd_comb
)

407 
	`‰ì
(
b¥ed
->
bimod
);

410 i‡(
x86_b¥ed_köd
 =
x86_b¥ed_köd_twﬁevñ
 || x86_b¥ed_köd =
x86_b¥ed_köd_comb
) {

411 
	`‰ì
(
b¥ed
->
twﬁevñ_bht
);

412 
	`‰ì
(
b¥ed
->
twﬁevñ_pht
);

416 i‡(
x86_b¥ed_köd
 =
x86_b¥ed_köd_comb
)

417 
	`‰ì
(
b¥ed
->
choi˚
);

420 
	`‰ì
(
b¥ed
->
«me
);

421 
	`‰ì
(
b¥ed
->
btb
);

422 
	`‰ì
(
b¥ed
->
øs
);

423 
	`‰ì
(
b¥ed
);

424 
	}
}

432 *
	gx86_b¥ed_köd_m≠
[] = { "Perfect", "Taken", "NotTaken", "Bimodal", "TwoLevel", "Combined" };

433 
x86_b¥ed_köd_t
 
	gx86_b¥ed_köd
;

434 
	gx86_b¥ed_btb_£ts
;

435 
	gx86_b¥ed_btb_assoc
;

436 
	gx86_b¥ed_øs_size
;

437 
	gx86_b¥ed_bimod_size
;

438 
	gx86_b¥ed_choi˚_size
;

440 
	gx86_b¥ed_twﬁevñ_l1size
;

441 
	gx86_b¥ed_twﬁevñ_l2size
;

442 
	gx86_b¥ed_twﬁevñ_hi°_size
;

443 
	gx86_b¥ed_twﬁevñ_l2height
;

446 
	$X86RódBønchPªdC⁄fig
(
c⁄fig_t
 *
c⁄fig
)

448 *
£˘i⁄
;

450 
£˘i⁄
 = "BranchPredictor";

452 
x86_b¥ed_köd
 = 
	`c⁄fig_ªad_íum
(
c⁄fig
, 
£˘i⁄
, "Kind",

453 
x86_b¥ed_köd_twﬁevñ
, 
x86_b¥ed_köd_m≠
, 6);

454 
x86_b¥ed_btb_£ts
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "BTB.Sets", 256);

455 
x86_b¥ed_btb_assoc
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "BTB.Assoc", 4);

456 
x86_b¥ed_bimod_size
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "Bimod.Size", 1024);

457 
x86_b¥ed_choi˚_size
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "Choice.Size", 1024);

458 
x86_b¥ed_øs_size
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "RAS.Size", 32);

459 
x86_b¥ed_twﬁevñ_l1size
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "TwoLevel.L1Size", 1);

460 
x86_b¥ed_twﬁevñ_l2size
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "TwoLevel.L2Size", 1024);

461 
x86_b¥ed_twﬁevñ_hi°_size
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "TwoLevel.HistorySize", 8);

464 
x86_b¥ed_twﬁevñ_l2height
 = 1 << 
x86_b¥ed_twﬁevñ_hi°_size
;

467 i‡(
x86_b¥ed_bimod_size
 & (x86_bpred_bimod_size - 1))

468 
	`Áèl
("number ofÉntries in bimodalÖrecitor must beáÖower of 2");

469 i‡(
x86_b¥ed_choi˚_size
 & (x86_bpred_choice_size - 1))

470 
	`Áèl
("number ofÉntries in choiceÖredictor must beÖower of 2");

471 i‡(
x86_b¥ed_btb_£ts
 & (x86_bpred_btb_sets - 1))

472 
	`Áèl
("number of BTB sets must beáÖower of 2");

473 i‡(
x86_b¥ed_btb_assoc
 & (x86_bpred_btb_assoc - 1))

474 
	`Áèl
("BTBássociativity must beáÖower of 2");

476 i‡(
x86_b¥ed_twﬁevñ_hi°_size
 < 1 || x86_bpred_twolevel_hist_size > 30)

477 
	`Áèl
("predictor history size must be >=1ánd <=30");

478 i‡(
x86_b¥ed_twﬁevñ_l1size
 & (x86_bpred_twolevel_l1size - 1))

479 
	`Áèl
("two-levelÖredictor sizes must beÖower of 2");

480 i‡(
x86_b¥ed_twﬁevñ_l2size
 & (x86_bpred_twolevel_l2size - 1))

481 
	`Áèl
("two-levelÖredictor sizes must beÖower of 2");

482 
	}
}

	@bpred.h

20 #i‚de‡
X86_ARCH_TIMING_BPRED_H


21 
	#X86_ARCH_TIMING_BPRED_H


	)

23 
	~<lib/utû/˛ass.h
>

26 
	gx86_u›_t
;

27 
	gc⁄fig_t
;

34 
X86ThªadInôBønchPªd
(
X86Thªad
 *
£lf
);

35 
X86ThªadFªeBønchPªd
(
X86Thªad
 *
£lf
);

37 
X86ThªadLookupBønchPªd
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
);

38 
X86ThªadLookupBønchPªdMu…ùÀ
(
X86Thªad
 *
£lf
, 
eù
, 
cou¡
);

39 
X86ThªadUpd©eBønchPªd
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
);

41 
X86ThªadLookupBTB
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
);

42 
X86ThªadUpd©eBTB
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
);

43 
X86ThªadGëNextBønch
(
X86Thªad
 *
£lf
, 
eù
,

44 
bsize
);

53 
	#X86_BPRED_BTB_ENTRY
(
SET
, 
WAY
) \

54 (&
b¥ed
->
btb
[(
SET
Ë* 
x86_b¥ed_btb_assoc
 + (
WAY
)])

	)

57 
	sx86_b¥ed_btb_íåy_t


59 
	msour˚
;

60 
	mèrgë
;

61 
	mcou¡î
;

66 
	sx86_b¥ed_t


68 *
	m«me
;

71 *
	møs
;

72 
	møs_ödex
;

76 
x86_b¥ed_btb_íåy_t
 *
	mbtb
;

81 *
	mbimod
;

85 *
	mtwﬁevñ_bht
;

86 *
	mtwﬁevñ_pht
;

91 *
	mchoi˚
;

94 
	mac˚s£s
;

95 
	mhôs
;

98 
x86_b¥ed_t
 *
x86_b¥ed_¸óã
(*
«me
);

99 
x86_b¥ed_‰ì
(
x86_b¥ed_t
 *
b¥ed
);

109 *
x86_b¥ed_köd_m≠
[];

110 
	ex86_b¥ed_köd_t


112 
x86_b¥ed_köd_≥r„˘
 = 0,

113 
x86_b¥ed_köd_èkí
,

114 
x86_b¥ed_köd_nŸèkí
,

115 
x86_b¥ed_köd_bimod
,

116 
x86_b¥ed_köd_twﬁevñ
,

117 
x86_b¥ed_köd_comb


118 } 
x86_b¥ed_köd
;

120 
x86_b¥ed_btb_£ts
;

121 
x86_b¥ed_btb_assoc
;

122 
x86_b¥ed_øs_size
;

123 
x86_b¥ed_bimod_size
;

124 
x86_b¥ed_choi˚_size
;

126 
x86_b¥ed_twﬁevñ_l1size
;

127 
x86_b¥ed_twﬁevñ_l2size
;

128 
x86_b¥ed_twﬁevñ_hi°_size
;

129 
x86_b¥ed_twﬁevñ_l2height
;

132 
X86RódBønchPªdC⁄fig
(
c⁄fig_t
 *
c⁄fig
);

	@commit.c

21 
	~<¨ch/x86/emu/c⁄ãxt.h
>

22 
	~<lib/esim/esim.h
>

23 
	~<lib/esim/åa˚.h
>

24 
	~<lib/utû/debug.h
>

26 
	~"b¥ed.h
"

27 
	~"commô.h
"

28 
	~"c‹e.h
"

29 
	~"˝u.h
"

30 
	~"fu.h
"

31 
	~"ªcovî.h
"

32 
	~"ªg-fûe.h
"

33 
	~"rob.h
"

34 
	~"sched.h
"

35 
	~"thªad.h
"

36 
	~"åa˚-ˇche.h
"

39 *
	gîr_commô_°Æl
 =

51 
	$X86ThªadC™Commô
(
X86Thªad
 *
£lf
)

53 
X86Cpu
 *
˝u
 = 
£lf
->cpu;

54 
X86C⁄ãxt
 *
˘x
 = 
£lf
->ctx;

55 
x86_u›_t
 *
u›
;

59 i‡(!
˘x
 || !
	`X86C⁄ãxtGëSèã
(˘x, 
X86C⁄ãxtRu¬ög
))

60 
£lf
->
œ°_commô_cy˛e
 = 
	`asTimög
(
˝u
)->
cy˛e
;

61 i‡(
	`asTimög
(
˝u
)->
cy˛e
 - 
£lf
->
œ°_commô_cy˛e
 > 1000000)

63 
	`w¨nög
("thread %s: simulationÉnded dueÅo commit stall.\n%s",

64 
£lf
->
«me
, 
îr_commô_°Æl
);

65 
esim_föish
 = 
esim_föish_°Æl
;

70 i‡(!
	`X86ThªadC™DequeueFromROB
(
£lf
))

74 
u›
 = 
	`X86ThªadGëROBHód
(
£lf
);

75 
	`as£π
(
	`x86_u›_exi°s
(
u›
));

76 
	`as£π
(
u›
->
thªad
 =
£lf
);

80 i‡(
u›
->
uö°
->
›code
 =
x86_uö°_°‹e
)

82 i‡(!
u›
->
ªady
 && 
	`X86ThªadIsU›Ródy
(
£lf
, uop))

83 
u›
->
ªady
 = 1;

84  
u›
->
ªady
;

88  
u›
->
com∂ëed
;

89 
	}
}

92 
	$X86ThªadCommô
(
X86Thªad
 *
£lf
, 
qu™t
)

94 
X86Cpu
 *
˝u
 = 
£lf
->cpu;

95 
X86C‹e
 *
c‹e
 = 
£lf
->core;

96 
X86C⁄ãxt
 *
˘x
 = 
£lf
->ctx;

98 
x86_u›_t
 *
u›
;

99 
ªcovî
 = 0;

102 
	`as£π
(
˘x
);

103 
qu™t
 && 
	`X86ThªadC™Commô
(
£lf
))

106 
u›
 = 
	`X86ThªadGëROBHód
(
£lf
);

107 
	`as£π
(
	`x86_u›_exi°s
(
u›
));

108 
	`as£π
(
u›
->
thªad
 =
£lf
);

109 
	`as£π
(!
ªcovî
);

112 i‡(
x86_˝u_ªcovî_köd
 =
x86_˝u_ªcovî_köd_commô
 &&

113 (
u›
->
Êags
 & 
X86_UINST_CTRL
Ë&& u›->
√ù
 !u›->
¥ed_√ù
)

114 
ªcovî
 = 1;

117 
	`as£π
(!
u›
->
•ecmode
);

118 
	`X86ThªadCommôU›
(
£lf
, 
u›
);

121 i‡(
u›
->
Êags
 & 
X86_UINST_CTRL
)

123 
	`X86ThªadUpd©eBønchPªd
(
£lf
, 
u›
);

124 
	`X86ThªadUpd©eBTB
(
£lf
, 
u›
);

125 
£lf
->
btb_wrôes
++;

129 i‡(
x86_åa˚_ˇche_¥e£¡
)

130 
	`X86ThªadRec‹dU›InTø˚Cache
(
£lf
, 
u›
);

133 
£lf
->
œ°_commô_cy˛e
 = 
	`asTimög
(
˝u
)->
cy˛e
;

134 
£lf
->
num_commôãd_uö°_¨øy
[
u›
->
uö°
->
›code
]++;

135 
c‹e
->
num_commôãd_uö°_¨øy
[
u›
->
uö°
->
›code
]++;

136 
˝u
->
num_commôãd_uö°_¨øy
[
u›
->
uö°
->
›code
]++;

137 
˝u
->
num_commôãd_uö°
++;

138 
˘x
->
ö°_cou¡
++;

139 i‡(
u›
->
åa˚_ˇche
)

140 
£lf
->
åa˚_ˇche
->
num_commôãd_uö°
++;

141 i‡(!
u›
->
m›_ödex
)

142 
˝u
->
num_commôãd_ö°
++;

143 i‡(
u›
->
Êags
 & 
X86_UINST_CTRL
)

145 
£lf
->
num_bønch_uö°
++;

146 
c‹e
->
num_bønch_uö°
++;

147 
˝u
->
num_bønch_uö°
++;

148 i‡(
u›
->
√ù
 !u›->
¥ed_√ù
)

150 
£lf
->
num_mi•ªd_bønch_uö°
++;

151 
c‹e
->
num_mi•ªd_bønch_uö°
++;

152 
˝u
->
num_mi•ªd_bønch_uö°
++;

157 i‡(
	`x86_åacög
())

159 
	`x86_åa˚
("x86.inst id=%lld core=%d stg=\"co\"\n",

160 
u›
->
id_ö_c‹e
, 
c‹e
->
id
);

161 
	`X86CpuAddToTø˚Li°
(
˝u
, 
u›
);

165 
	`X86ThªadRemoveROBHód
(
£lf
);

166 
c‹e
->
rob_ªads
++;

167 
£lf
->
rob_ªads
++;

168 
qu™t
--;

172 i‡(
ªcovî
)

174 
	`X86ThªadRecovî
(
£lf
);

175 
	`X86C‹eRñó£AŒFun˘i⁄ÆUnôs
(
c‹e
);

181 i‡(
˘x
->
evi˘_sig«l
 && 
	`X86ThªadIsPùñöeEm±y
(
£lf
))

182 
	`X86ThªadEvi˘C⁄ãxt
(
£lf
, 
˘x
);

183 
	}
}

192 
	$X86C‹eCommô
(
X86C‹e
 *
£lf
)

194 
∑ss
;

195 
qu™tum
;

196 
√w
;

199 
x86_˝u_commô_köd
)

202 
x86_˝u_commô_köd_sh¨ed
:

204 
∑ss
 = 
x86_˝u_num_thªads
;

205 
qu™tum
 = 
x86_˝u_commô_width
;

206 
qu™tum
 && 
∑ss
)

208 
£lf
->
commô_cuºít
 = (£lf->commô_cuºíà+ 1Ë% 
x86_˝u_num_thªads
;

209 i‡(
	`X86ThªadC™Commô
(
£lf
->
thªads
[£lf->
commô_cuºít
]))

211 
	`X86ThªadCommô
(
£lf
->
thªads
[£lf->
commô_cuºít
], 1);

212 
qu™tum
--;

213 
∑ss
 = 
x86_˝u_num_thªads
;

216 
∑ss
--;

220 
x86_˝u_commô_köd_time¶i˚
:

223 
√w
 = (
£lf
->
commô_cuºít
 + 1Ë% 
x86_˝u_num_thªads
;

224 
√w
 !
£lf
->
commô_cuºít
 &&

225 !
	`X86ThªadC™Commô
(
£lf
->
thªads
[
√w
]))

226 
√w
 = (√w + 1Ë% 
x86_˝u_num_thªads
;

229 
£lf
->
commô_cuºít
 = 
√w
;

230 
	`X86ThªadCommô
(
£lf
->
thªads
[
√w
], 
x86_˝u_commô_width
);

234 
	}
}

243 
	$X86CpuCommô
(
X86Cpu
 *
£lf
)

245 
i
;

247 
£lf
->
°age
 = "commit";

248 
i
 = 0; i < 
x86_˝u_num_c‹es
; i++)

249 
	`X86C‹eCommô
(
£lf
->
c‹es
[
i
]);

250 
	}
}

	@commit.h

20 #i‚de‡
ARCH_X86_TIMING_COMMIT_H


21 
	#ARCH_X86_TIMING_COMMIT_H


	)

23 
	~<lib/utû/˛ass.h
>

29 
X86ThªadC™Commô
(
X86Thªad
 *
£lf
);

30 
X86ThªadCommô
(
X86Thªad
 *
£lf
, 
qu™tum
);

37 
X86C‹eCommô
(
X86C‹e
 *
£lf
);

43 
X86CpuCommô
(
X86Cpu
 *
£lf
);

	@core.c

20 
	~<lib/mh™dÀ/mh™dÀ.h
>

21 
	~<lib/utû/°rög.h
>

23 
	~"c‹e.h
"

24 
	~"˝u.h
"

25 
	~"evít-queue.h
"

26 
	~"fu.h
"

27 
	~"rob.h
"

28 
	~"thªad.h
"

35 
CLASS_IMPLEMENTATION
(
X86C‹e
);

37 
	$X86C‹eCª©e
(
X86C‹e
 *
£lf
, 
X86Cpu
 *
˝u
)

39 
i
;

42 
£lf
->
˝u
 = cpu;

45 
£lf
->
thªads
 = 
	`xˇŒoc
(
x86_˝u_num_thªads
, (
X86Thªad
 *));

46 
i
 = 0; i < 
x86_˝u_num_thªads
; i++)

47 
£lf
->
thªads
[
i
] = 
	`√w
(
X86Thªad
, self);

50 
£lf
->
¥e„tch_hi°‹y
 = 
	`¥e„tch_hi°‹y_¸óã
();

53 
	`X86C‹eInôROB
(
£lf
);

54 
	`X86C‹eInôEvítQueue
(
£lf
);

55 
	`X86C‹eInôFun˘i⁄ÆUnôs
(
£lf
);

56 
	}
}

59 
	$X86C‹eDe°roy
(
X86C‹e
 *
£lf
)

61 
i
;

64 
£lf
->
«me
 = 
	`°r_‰ì
(self->name);

67 
i
 = 0; i < 
x86_˝u_num_thªads
; i++)

68 
	`dñëe
(
£lf
->
thªads
[
i
]);

69 
	`‰ì
(
£lf
->
thªads
);

72 
	`¥e„tch_hi°‹y_‰ì
(
£lf
->
¥e„tch_hi°‹y
);

75 
	`X86C‹eFªeROB
(
£lf
);

76 
	`X86C‹eFªeEvítQueue
(
£lf
);

77 
	`X86C‹eFªeFun˘i⁄ÆUnôs
(
£lf
);

78 
	}
}

81 
	$X86C‹eSëName
(
X86C‹e
 *
£lf
, *
«me
)

83 
£lf
->
«me
 = 
	`°r_£t
(self->name,Çame);

84 
	}
}

	@core.h

20 #i‚de‡
X86_ARCH_TIMING_CORE_H


21 
	#X86_ARCH_TIMING_CORE_H


	)

23 
	~<¨ch/x86/emu/uö°.h
>

24 
	~<lib/utû/˛ass.h
>

25 
	~<mem-sy°em/¥e„tch-hi°‹y.h
>

34 
	ex86_di•©ch_°Æl_t


36 
	mx86_di•©ch_°Æl_u£d
 = 0,

37 
	mx86_di•©ch_°Æl_•ec
,

38 
	mx86_di•©ch_°Æl_u›_queue
,

39 
	mx86_di•©ch_°Æl_rob
,

40 
	mx86_di•©ch_°Æl_iq
,

41 
	mx86_di•©ch_°Æl_lsq
,

42 
	mx86_di•©ch_°Æl_ª«me
,

43 
	mx86_di•©ch_°Æl_˘x
,

44 
	mx86_di•©ch_°Æl_max


48 
	$CLASS_BEGIN
(
X86C‹e
, 
Obje˘
)

51 
X86Cpu
 *
˝u
;

54 
X86Thªad
 **
thªads
;

56 *
«me
;

59 
id
;

62 
löked_li°_t
 *
evít_queue
;

63 
x86_fu_t
 *
fu
;

64 
¥e„tch_hi°‹y_t
 *
¥e„tch_hi°‹y
;

67 
u›_id_cou¡î
;

68 
di•©ch_£q
;

69 
iq_cou¡
;

70 
lsq_cou¡
;

71 
ªg_fûe_öt_cou¡
;

72 
ªg_fûe_Â_cou¡
;

73 
ªg_fûe_xmm_cou¡
;

76 
li°_t
 *
rob
;

77 
rob_cou¡
;

78 
rob_hód
;

79 
rob_èû
;

82 
„tch_cuºít
;

83 
„tch_swôch_whí
;

84 
decode_cuºít
;

85 
di•©ch_cuºít
;

86 
issue_cuºít
;

87 
commô_cuºít
;

90 
di•©ch_°Æl
[
x86_di•©ch_°Æl_max
];

91 
num_di•©ched_uö°_¨øy
[
x86_uö°_›code_cou¡
];

92 
num_issued_uö°_¨øy
[
x86_uö°_›code_cou¡
];

93 
num_commôãd_uö°_¨øy
[
x86_uö°_›code_cou¡
];

94 
num_squashed_uö°
;

95 
num_bønch_uö°
;

96 
num_mi•ªd_bønch_uö°
;

99 
rob_occu∑ncy
;

100 
rob_fuŒ
;

101 
rob_ªads
;

102 
rob_wrôes
;

104 
iq_occu∑ncy
;

105 
iq_fuŒ
;

106 
iq_ªads
;

107 
iq_wrôes
;

108 
iq_wakeup_ac˚s£s
;

110 
lsq_occu∑ncy
;

111 
lsq_fuŒ
;

112 
lsq_ªads
;

113 
lsq_wrôes
;

114 
lsq_wakeup_ac˚s£s
;

116 
ªg_fûe_öt_occu∑ncy
;

117 
ªg_fûe_öt_fuŒ
;

118 
ªg_fûe_öt_ªads
;

119 
ªg_fûe_öt_wrôes
;

121 
ªg_fûe_Â_occu∑ncy
;

122 
ªg_fûe_Â_fuŒ
;

123 
ªg_fûe_Â_ªads
;

124 
ªg_fûe_Â_wrôes
;

126 
ªg_fûe_xmm_occu∑ncy
;

127 
ªg_fûe_xmm_fuŒ
;

128 
ªg_fûe_xmm_ªads
;

129 
ªg_fûe_xmm_wrôes
;

131 
	$CLASS_END
(
X86C‹e
)

134 
	`X86C‹eCª©e
(
X86C‹e
 *
£lf
, 
X86Cpu
 *
˝u
);

135 
	`X86C‹eDe°roy
(
X86C‹e
 *
£lf
);

137 
	`X86C‹eSëName
(
X86C‹e
 *
£lf
, *
«me
);

	@cpu.c

21 
	~<¨ch/x86/emu/c⁄ãxt.h
>

22 
	~<¨ch/x86/emu/emu.h
>

23 
	~<lib/esim/esim.h
>

24 
	~<lib/esim/åa˚.h
>

25 
	~<lib/mh™dÀ/mh™dÀ.h
>

26 
	~<lib/utû/c⁄fig.h
>

27 
	~<lib/utû/debug.h
>

28 
	~<lib/utû/fûe.h
>

29 
	~<lib/utû/löked-li°.h
>

30 
	~<lib/utû/misc.h
>

31 
	~<lib/utû/°rög.h
>

32 
	~<lib/utû/timî.h
>

33 
	~<mem-sy°em/mem‹y.h
>

35 
	~"b¥ed.h
"

36 
	~"commô.h
"

37 
	~"c‹e.h
"

38 
	~"˝u.h
"

39 
	~"decode.h
"

40 
	~"di•©ch.h
"

41 
	~"„tch.h
"

42 
	~"„tch-queue.h
"

43 
	~"fu.h
"

44 
	~"ö°-queue.h
"

45 
	~"issue.h
"

46 
	~"lﬂd-°‹e-queue.h
"

47 
	~"mem-c⁄fig.h
"

48 
	~"ªg-fûe.h
"

49 
	~"rob.h
"

50 
	~"sched.h
"

51 
	~"thªad.h
"

52 
	~"åa˚-ˇche.h
"

53 
	~"u›-queue.h
"

54 
	~"wrôeback.h
"

64 *
	gx86_c⁄fig_hñp
 =

255 
	gx86_åa˚_ˇãg‹y
;

260 *
	gx86_c⁄fig_fûe_«me
 = "";

261 *
	gx86_˝u_ªp‹t_fûe_«me
 = "";

263 
	gx86_˝u_‰equícy
 = 1000;

264 
	gx86_˝u_num_c‹es
 = 1;

265 
	gx86_˝u_num_thªads
 = 1;

267 
	gx86_˝u_Á°_f‹w¨d_cou¡
;

269 
	gx86_˝u_c⁄ãxt_qu™tum
;

270 
	gx86_˝u_thªad_qu™tum
;

271 
	gx86_˝u_thªad_swôch_≥«…y
;

273 *
	gx86_˝u_ªcovî_köd_m≠
[] = { "Writeback", "Commit" };

274 
x86_˝u_ªcovî_köd_t
 
	gx86_˝u_ªcovî_köd
;

275 
	gx86_˝u_ªcovî_≥«…y
;

277 *
	gx86_˝u_„tch_köd_m≠
[] = { "Shared", "TimeSlice", "SwitchOnEvent" };

278 
x86_˝u_„tch_köd_t
 
	gx86_˝u_„tch_köd
;

280 
	gx86_˝u_decode_width
;

282 *
	gx86_˝u_di•©ch_köd_m≠
[] = { "Shared", "TimeSlice" };

283 
x86_˝u_di•©ch_köd_t
 
	gx86_˝u_di•©ch_köd
;

284 
	gx86_˝u_di•©ch_width
;

286 *
	gx86_˝u_issue_köd_m≠
[] = { "Shared", "TimeSlice" };

287 
x86_˝u_issue_köd_t
 
	gx86_˝u_issue_köd
;

288 
	gx86_˝u_issue_width
;

290 *
	gx86_˝u_commô_köd_m≠
[] = { "Shared", "TimeSlice" };

291 
x86_˝u_commô_köd_t
 
	gx86_˝u_commô_köd
;

292 
	gx86_˝u_commô_width
;

294 
	gx86_˝u_occu∑ncy_°©s
;

303 *
	gx86_˝u_îr_Á°_f‹w¨d
 =

319 
	#X86_TRACE_VERSION_MAJOR
 1

	)

320 
	#X86_TRACE_VERSION_MINOR
 671

	)

323 
	$X86CpuRódC⁄fig
()

325 
c⁄fig_t
 *
c⁄fig
;

326 *
£˘i⁄
;

329 
c⁄fig
 = 
	`c⁄fig_¸óã
(
x86_c⁄fig_fûe_«me
);

330 i‡(*
x86_c⁄fig_fûe_«me
)

331 
	`c⁄fig_lﬂd
(
c⁄fig
);

336 
£˘i⁄
 = "General";

338 
x86_˝u_‰equícy
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "Frequency", x86_cpu_frequency);

339 i‡(!
	`IN_RANGE
(
x86_˝u_‰equícy
, 1, 
ESIM_MAX_FREQUENCY
))

340 
	`Áèl
("%s: invÆid vÆuêf‹ 'Fªquícy'.", 
x86_c⁄fig_fûe_«me
);

342 
x86_˝u_num_c‹es
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "Cores", x86_cpu_num_cores);

343 
x86_˝u_num_thªads
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "Threads", x86_cpu_num_threads);

345 
x86_˝u_Á°_f‹w¨d_cou¡
 = 
	`c⁄fig_ªad_Œöt
(
c⁄fig
, 
£˘i⁄
, "FastForward", 0);

347 
x86_˝u_c⁄ãxt_qu™tum
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "ContextQuantum", 100000);

348 
x86_˝u_thªad_qu™tum
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "ThreadQuantum", 1000);

349 
x86_˝u_thªad_swôch_≥«…y
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "ThreadSwitchPenalty", 0);

351 
x86_˝u_ªcovî_köd
 = 
	`c⁄fig_ªad_íum
(
c⁄fig
, 
£˘i⁄
, "RecovîKöd", 
x86_˝u_ªcovî_köd_wrôeback
, 
x86_˝u_ªcovî_köd_m≠
, 2);

352 
x86_˝u_ªcovî_≥«…y
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "RecoverPenalty", 0);

354 
x86_emu_¥o˚ss_¥e„tch_höts
 = 
	`c⁄fig_ªad_boﬁ
(
c⁄fig
, 
£˘i⁄
, "ProcessPrefetchHints", 1);

355 
¥e„tch_hi°‹y_size
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "PrefetchHistorySize", 10);

360 
£˘i⁄
 = "Pipeline";

362 
x86_˝u_„tch_köd
 = 
	`c⁄fig_ªad_íum
(
c⁄fig
, 
£˘i⁄
, "FëchKöd", 
x86_˝u_„tch_köd_time¶i˚
, 
x86_˝u_„tch_köd_m≠
, 3);

364 
x86_˝u_decode_width
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "DecodeWidth", 4);

366 
x86_˝u_di•©ch_köd
 = 
	`c⁄fig_ªad_íum
(
c⁄fig
, 
£˘i⁄
, "Di•©chKöd", 
x86_˝u_di•©ch_köd_time¶i˚
, 
x86_˝u_di•©ch_köd_m≠
, 2);

367 
x86_˝u_di•©ch_width
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "DispatchWidth", 4);

369 
x86_˝u_issue_köd
 = 
	`c⁄fig_ªad_íum
(
c⁄fig
, 
£˘i⁄
, "IssueKöd", 
x86_˝u_issue_köd_time¶i˚
, 
x86_˝u_issue_köd_m≠
, 2);

370 
x86_˝u_issue_width
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "IssueWidth", 4);

372 
x86_˝u_commô_köd
 = 
	`c⁄fig_ªad_íum
(
c⁄fig
, 
£˘i⁄
, "CommôKöd", 
x86_˝u_commô_köd_sh¨ed
, 
x86_˝u_commô_köd_m≠
, 2);

373 
x86_˝u_commô_width
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "CommitWidth", 4);

375 
x86_˝u_occu∑ncy_°©s
 = 
	`c⁄fig_ªad_boﬁ
(
c⁄fig
, 
£˘i⁄
, "OccupancyStats", 0);

380 
£˘i⁄
 = "Queues";

382 
x86_„tch_queue_size
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "FetchQueueSize", 64);

384 
x86_u›_queue_size
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "UopQueueSize", 32);

386 
x86_rob_köd
 = 
	`c⁄fig_ªad_íum
(
c⁄fig
, 
£˘i⁄
, "RobKind",

387 
x86_rob_köd_¥iv©e
, 
x86_rob_köd_m≠
, 2);

388 
x86_rob_size
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "RobSize", 64);

390 
x86_iq_köd
 = 
	`c⁄fig_ªad_íum
(
c⁄fig
, 
£˘i⁄
, "IqKind",

391 
x86_iq_köd_¥iv©e
, 
x86_iq_köd_m≠
, 2);

392 
x86_iq_size
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "IqSize", 40);

394 
x86_lsq_köd
 = 
	`c⁄fig_ªad_íum
(
c⁄fig
, 
£˘i⁄
, "LsqKind",

395 
x86_lsq_köd_¥iv©e
, 
x86_lsq_köd_m≠
, 2);

396 
x86_lsq_size
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "LsqSize", 20);

399 
	`X86RódRegFûeC⁄fig
(
c⁄fig
);

402 
	`X86RódFun˘i⁄ÆUnôsC⁄fig
(
c⁄fig
);

405 
	`X86RódBønchPªdC⁄fig
(
c⁄fig
);

408 
	`X86RódTø˚CacheC⁄fig
(
c⁄fig
);

411 
	`c⁄fig_check
(
c⁄fig
);

412 
	`c⁄fig_‰ì
(
c⁄fig
);

413 
	}
}

416 
	$X86CpuInô
()

419 
	`CLASS_REGISTER
(
X86Cpu
);

420 
	`CLASS_REGISTER
(
X86C‹e
);

421 
	`CLASS_REGISTER
(
X86Thªad
);

424 
x86_åa˚_ˇãg‹y
 = 
	`åa˚_√w_ˇãg‹y
();

425 
	}
}

429 
	$X86CpuD⁄e
()

431 
	}
}

441 
CLASS_IMPLEMENTATION
(
X86Cpu
);

444 
	$X86CpuCª©e
(
X86Cpu
 *
£lf
, 
X86Emu
 *
emu
)

446 
X86C‹e
 *
c‹e
;

447 
X86Thªad
 *
thªad
;

449 
«me
[
MAX_STRING_SIZE
];

451 
i
;

452 
j
;

455 
	`TimögCª©e
(
	`asTimög
(
£lf
));

458 
	`asTimög
(
£lf
)->
‰equícy
 = 
x86_˝u_‰equícy
;

459 
	`asTimög
(
£lf
)->
‰equícy_domaö
 = 
	`esim_√w_domaö
(
x86_˝u_‰equícy
);

462 
£lf
->
emu
 =Ému;

463 
£lf
->
u›_åa˚_li°
 = 
	`löked_li°_¸óã
();

467 
£lf
->
c‹es
 = 
	`xˇŒoc
(
x86_˝u_num_c‹es
*2, (
X86C‹e
 *));

468 
i
 = 0; i < 
x86_˝u_num_c‹es
*2; i++)

469 
£lf
->
c‹es
[
i
] = 
	`√w
(
X86C‹e
, self);

472 
i
 = 0; i < 
x86_˝u_num_c‹es
*2; i++)

474 
c‹e
 = 
£lf
->
c‹es
[
i
];

475 
	`¢¥ötf
(
«me
, Çame, "c%d", 
i
);

476 
	`X86C‹eSëName
(
c‹e
, 
«me
);

477 
c‹e
->
id
 = 
i
;

478 
j
 = 0; j < 
x86_˝u_num_thªads
; j++)

480 
thªad
 = 
c‹e
->
thªads
[
j
];

481 
	`¢¥ötf
(
«me
, Çame, "c%dt%d", 
i
, 
j
);

482 
	`X86ThªadSëName
(
thªad
, 
«me
);

483 
thªad
->
id_ö_c‹e
 = 
j
;

484 
thªad
->
id_ö_˝u
 = 
i
 * 
x86_˝u_num_thªads
 + 
j
;

489 
	`asObje˘
(
£lf
)->
Dump
 = 
X86CpuDump
;

490 
	`asTimög
(
£lf
)->
DumpSumm¨y
 = 
X86CpuDumpSumm¨y
;

491 
	`asTimög
(
£lf
)->
Run
 = 
X86CpuRun
;

492 
	`asTimög
(
£lf
)->
MemC⁄figCheck
 = 
X86CpuMemC⁄figCheck
;

493 
	`asTimög
(
£lf
)->
MemC⁄figDeÁu…
 = 
X86CpuMemC⁄figDeÁu…
;

494 
	`asTimög
(
£lf
)->
MemC⁄figP¨£E¡ry
 = 
X86CpuMemC⁄figP¨£E¡ry
;

497 
	`x86_åa˚_hódî
("x86.init version=\"%d.%d\"Çum_cores=%dÇum_threads=%d\n",

498 
X86_TRACE_VERSION_MAJOR
, 
X86_TRACE_VERSION_MINOR
,

499 
x86_˝u_num_c‹es
, 
x86_˝u_num_thªads
);

500 
	}
}

503 
	$X86CpuDe°roy
(
X86Cpu
 *
£lf
)

505 
i
;

506 
FILE
 *
f
;

509 
f
 = 
	`fûe_›í_f‹_wrôe
(
x86_˝u_ªp‹t_fûe_«me
);

510 i‡(
f
)

512 
	`X86CpuDumpRï‹t
(
£lf
, 
f
);

513 
	`X86CpuDump
(
	`asObje˘
(
£lf
), 
f
);

514 
	`f˛o£
(
f
);

518 
	`X86CpuEm±yTø˚Li°
(
£lf
);

519 
	`löked_li°_‰ì
(
£lf
->
u›_åa˚_li°
);

522 
i
 = 0; i < 
x86_˝u_num_c‹es
*2; i++)

523 
	`dñëe
(
£lf
->
c‹es
[
i
]);

524 
	`‰ì
(
£lf
->
c‹es
);

525 
	}
}

528 
	$X86CpuDump
(
Obje˘
 *
£lf
, 
FILE
 *
f
)

530 
X86Cpu
 *
˝u
 = 
	`asX86Cpu
(
£lf
);

531 
X86C‹e
 *
c‹e
;

532 
X86Thªad
 *
thªad
;

534 
i
;

535 
j
;

538 
	`Ârötf
(
f
, "\n");

539 
	`Ârötf
(
f
, "La°Dum∞%Œd ; Cy˛êo‡œ° dump\n", 
˝u
->
œ°_dump
);

540 
	`Ârötf
(
f
, "IPCLastDump = %.4g ; IPC sinceÜast dump\n",

541 
	`asTimög
(
˝u
)->
cy˛e
 - cpu->
œ°_dump
 > 0 ?

542 (Ë(
˝u
->
num_commôãd_uö°
 - cpu->
œ°_commôãd
)

543 / (
	`asTimög
(
˝u
)->
cy˛e
 - cpu->
œ°_dump
) : 0);

544 
	`Ârötf
(
f
, "\n");

547 
i
 = 0; i < 
x86_˝u_num_c‹es
*2; i++)

549 
c‹e
 = 
˝u
->
c‹es
[
i
];

550 
	`Ârötf
(
f
, "-------\n");

551 
	`Ârötf
(
f
, "C‹ê%d\n", 
c‹e
->
id
);

552 
	`Ârötf
(
f
, "-------\n\n");

554 
	`Ârötf
(
f
, "Event Queue:\n");

555 
	`x86_u›_löked_li°_dump
(
c‹e
->
evít_queue
, 
f
);

557 
	`Ârötf
(
f
, "Reorder Buffer:\n");

558 
	`X86C‹eDumpROB
(
c‹e
, 
f
);

560 
j
 = 0; j < 
x86_˝u_num_thªads
; j++)

562 
thªad
 = 
c‹e
->
thªads
[
j
];

564 
	`Ârötf
(
f
, "----------------------\n");

565 
	`Ârötf
(
f
, "Thªad %d (ö c‹ê%d)\n", 
j
, 
i
);

566 
	`Ârötf
(
f
, "----------------------\n\n");

568 
	`Ârötf
(
f
, "Fetch queue:\n");

569 
	`x86_u›_li°_dump
(
thªad
->
„tch_queue
, 
f
);

571 
	`Ârötf
(
f
, "Uop queue:\n");

572 
	`x86_u›_li°_dump
(
thªad
->
u›_queue
, 
f
);

574 
	`Ârötf
(
f
, "Instruction Queue:\n");

575 
	`x86_u›_löked_li°_dump
(
thªad
->
iq
, 
f
);

577 
	`Ârötf
(
f
, "Load Queue:\n");

578 
	`x86_u›_löked_li°_dump
(
thªad
->
lq
, 
f
);

580 
	`Ârötf
(
f
, "Store Queue:\n");

581 
	`x86_u›_löked_li°_dump
(
thªad
->
sq
, 
f
);

583 
	`X86ThªadDumpRegFûe
(
thªad
, 
f
);

584 i‡(
thªad
->
˘x
)

585 
	`Ârötf
(
f
, "M≠≥dC⁄ãxà%d\n", 
thªad
->
˘x
->
pid
);

587 
	`Ârötf
(
f
, "\n");

592 
˝u
->
œ°_dump
 = 
	`asTimög
(˝u)->
cy˛e
;

593 
˝u
->
œ°_commôãd
 = cpu->
num_commôãd_uö°
;

596 
	`Ârötf
(
f
, "\n\n");

597 
	}
}

600 
	$X86CpuDumpSumm¨y
(
Timög
 *
£lf
, 
FILE
 *
f
)

602 
X86Cpu
 *
˝u
 = 
	`asX86Cpu
(
£lf
);

604 
ö°_≥r_cy˛e
;

605 
uö°_≥r_cy˛e
;

606 
bønch_acc
;

609 
ö°_≥r_cy˛e
 = 
	`asTimög
(
˝u
)->
cy˛e
 ? (Ë˝u->
num_commôãd_ö°


610 / 
	`asTimög
(
˝u
)->
cy˛e
 : 0.0;

611 
uö°_≥r_cy˛e
 = 
	`asTimög
(
˝u
)->
cy˛e
 ? (Ë˝u->
num_commôãd_uö°


612 / 
	`asTimög
(
˝u
)->
cy˛e
 : 0.0;

613 
bønch_acc
 = 
˝u
->
num_bønch_uö°
 ? () (cpu->num_branch_uinst -

614 
˝u
->
num_mi•ªd_bønch_uö°
Ë/ cpu->
num_bønch_uö°
 : 0.0;

617 
	`Ârötf
(
f
, "Fa°F‹w¨dIn°ru˘i⁄†%Œd\n", 
˝u
->
num_Á°_f‹w¨d_ö°
);

618 
	`Ârötf
(
f
, "CommôãdIn°ru˘i⁄†%Œd\n", 
˝u
->
num_commôãd_ö°
);

619 
	`Ârötf
(
f
, "CommôãdIn°ru˘i⁄sPîCy˛ê%.4g\n", 
ö°_≥r_cy˛e
);

620 
	`Ârötf
(
f
, "CommôãdMi¸oIn°ru˘i⁄†%Œd\n", 
˝u
->
num_commôãd_uö°
);

621 
	`Ârötf
(
f
, "CommôãdMi¸oIn°ru˘i⁄sPîCy˛ê%.4g\n", 
uö°_≥r_cy˛e
);

622 
	`Ârötf
(
f
, "BønchPªdi˘i⁄Accuøcy = %.4g\n", 
bønch_acc
);

625 
	`TimögDumpSumm¨y
(
£lf
, 
f
);

626 
	}
}

629 
	#DUMP_DISPATCH_STAT
(
NAME
) { \

630 
	`Ârötf
(
f
, "Dispatch.Stall." #NAME " = %lld\n", \

631 
c‹e
->
di•©ch_°Æl
[
x86_di•©ch_°Æl_
##
NAME
]); \

632 }

	)

634 
	#DUMP_CORE_STRUCT_STATS
(
NAME
, 
ITEM
) { \

635 
	`Ârötf
(
f
, #NAME ".Sizê%d\n", (Ë
x86_
##
ITEM
##
_size
 * 
x86_˝u_num_thªads
); \

636 i‡(
x86_˝u_occu∑ncy_°©s
) \

637 
	`Ârötf
(
f
, #NAME ".Occu∑ncy = %.2f\n", 
	`asTimög
(
£lf
)->
cy˛e
 ? \

638 (Ë
c‹e
->
ITEM
##
_occu∑ncy
 / 
	`asTimög
(
£lf
)->
cy˛e
 : 0.0); \

639 
	`Ârötf
(
f
, #NAME ".FuŒ = %Œd\n", 
c‹e
->
ITEM
##
_fuŒ
); \

640 
	`Ârötf
(
f
, #NAME ".Ród†%Œd\n", 
c‹e
->
ITEM
##
_ªads
); \

641 
	`Ârötf
(
f
, #NAME ".Wrôe†%Œd\n", 
c‹e
->
ITEM
##
_wrôes
); \

642 }

	)

644 
	#DUMP_THREAD_STRUCT_STATS
(
NAME
, 
ITEM
) { \

645 
	`Ârötf
(
f
, #NAME ".Sizê%d\n", (Ë
x86_
##
ITEM
##
_size
); \

646 i‡(
x86_˝u_occu∑ncy_°©s
) \

647 
	`Ârötf
(
f
, #NAME ".Occu∑ncy = %.2f\n", 
	`asTimög
(
£lf
)->
cy˛e
 ? \

648 (Ë
thªad
->
ITEM
##
_occu∑ncy
 / 
	`asTimög
(
£lf
)->
cy˛e
 : 0.0); \

649 
	`Ârötf
(
f
, #NAME ".FuŒ = %Œd\n", 
thªad
->
ITEM
##
_fuŒ
); \

650 
	`Ârötf
(
f
, #NAME ".Ród†%Œd\n", 
thªad
->
ITEM
##
_ªads
); \

651 
	`Ârötf
(
f
, #NAME ".Wrôe†%Œd\n", 
thªad
->
ITEM
##
_wrôes
); \

652 }

	)

656 
	$X86DumpCpuC⁄fig
(
FILE
 *
f
)

659 
	`Ârötf
(
f
, "[ Config.General ]\n");

660 
	`Ârötf
(
f
, "Fªquícy = %d\n", 
x86_˝u_‰equícy
);

661 
	`Ârötf
(
f
, "C‹e†%d\n", 
x86_˝u_num_c‹es
);

662 
	`Ârötf
(
f
, "Thªad†%d\n", 
x86_˝u_num_thªads
);

663 
	`Ârötf
(
f
, "Fa°F‹w¨d = %Œd\n", 
x86_˝u_Á°_f‹w¨d_cou¡
);

664 
	`Ârötf
(
f
, "C⁄ãxtQu™tum = %d\n", 
x86_˝u_c⁄ãxt_qu™tum
);

665 
	`Ârötf
(
f
, "ThªadQu™tum = %d\n", 
x86_˝u_thªad_qu™tum
);

666 
	`Ârötf
(
f
, "ThªadSwôchPíÆty = %d\n", 
x86_˝u_thªad_swôch_≥«…y
);

667 
	`Ârötf
(
f
, "RecovîKöd = %s\n", 
x86_˝u_ªcovî_köd_m≠
[
x86_˝u_ªcovî_köd
]);

668 
	`Ârötf
(
f
, "RecovîPíÆty = %d\n", 
x86_˝u_ªcovî_≥«…y
);

669 
	`Ârötf
(
f
, "Pro˚ssPª„tchHöt†%d\n", 
x86_emu_¥o˚ss_¥e„tch_höts
);

670 
	`Ârötf
(
f
, "Pª„tchHi°‹ySizê%d\n", 
¥e„tch_hi°‹y_size
);

671 
	`Ârötf
(
f
, "\n");

674 
	`Ârötf
(
f
, "[ Config.Pipeline ]\n");

675 
	`Ârötf
(
f
, "FëchKöd = %s\n", 
x86_˝u_„tch_köd_m≠
[
x86_˝u_„tch_köd
]);

676 
	`Ârötf
(
f
, "DecodeWidth = %d\n", 
x86_˝u_decode_width
);

677 
	`Ârötf
(
f
, "Di•©chKöd = %s\n", 
x86_˝u_di•©ch_köd_m≠
[
x86_˝u_di•©ch_köd
]);

678 
	`Ârötf
(
f
, "Di•©chWidth = %d\n", 
x86_˝u_di•©ch_width
);

679 
	`Ârötf
(
f
, "IssueKöd = %s\n", 
x86_˝u_issue_köd_m≠
[
x86_˝u_issue_köd
]);

680 
	`Ârötf
(
f
, "IssueWidth = %d\n", 
x86_˝u_issue_width
);

681 
	`Ârötf
(
f
, "CommôKöd = %s\n", 
x86_˝u_commô_köd_m≠
[
x86_˝u_commô_köd
]);

682 
	`Ârötf
(
f
, "CommôWidth = %d\n", 
x86_˝u_commô_width
);

683 
	`Ârötf
(
f
, "Occu∑ncySèt†%s\n", 
x86_˝u_occu∑ncy_°©s
 ? "True" : "False");

684 
	`Ârötf
(
f
, "\n");

687 
	`Ârötf
(
f
, "[ Config.Queues ]\n");

688 
	`Ârötf
(
f
, "FëchQueueSizê%d\n", 
x86_„tch_queue_size
);

689 
	`Ârötf
(
f
, "U›QueueSizê%d\n", 
x86_u›_queue_size
);

690 
	`Ârötf
(
f
, "RobKöd = %s\n", 
x86_rob_köd_m≠
[
x86_rob_köd
]);

691 
	`Ârötf
(
f
, "RobSizê%d\n", 
x86_rob_size
);

692 
	`Ârötf
(
f
, "IqKöd = %s\n", 
x86_iq_köd_m≠
[
x86_iq_köd
]);

693 
	`Ârötf
(
f
, "IqSizê%d\n", 
x86_iq_size
);

694 
	`Ârötf
(
f
, "LsqKöd = %s\n", 
x86_lsq_köd_m≠
[
x86_lsq_köd
]);

695 
	`Ârötf
(
f
, "LsqSizê%d\n", 
x86_lsq_size
);

696 
	`Ârötf
(
f
, "RfKöd = %s\n", 
x86_ªg_fûe_köd_m≠
[
x86_ªg_fûe_köd
]);

697 
	`Ârötf
(
f
, "RfI¡Sizê%d\n", 
x86_ªg_fûe_öt_size
);

698 
	`Ârötf
(
f
, "RfFpSizê%d\n", 
x86_ªg_fûe_Â_size
);

699 
	`Ârötf
(
f
, "\n");

702 
	`Ârötf
(
f
, "[ Config.TraceCache ]\n");

703 
	`Ârötf
(
f
, "Pª£¡ = %s\n", 
x86_åa˚_ˇche_¥e£¡
 ? "True" : "False");

704 
	`Ârötf
(
f
, "Së†%d\n", 
x86_åa˚_ˇche_num_£ts
);

705 
	`Ârötf
(
f
, "Asso¯%d\n", 
x86_åa˚_ˇche_assoc
);

706 
	`Ârötf
(
f
, "Tø˚Sizê%d\n", 
x86_åa˚_ˇche_åa˚_size
);

707 
	`Ârötf
(
f
, "BønchMax = %d\n", 
x86_åa˚_ˇche_bønch_max
);

708 
	`Ârötf
(
f
, "QueueSizê%d\n", 
x86_åa˚_ˇche_queue_size
);

709 
	`Ârötf
(
f
, "\n");

712 
	`X86DumpFun˘i⁄ÆUnôsC⁄fig
(
f
);

715 
	`Ârötf
(
f
, "[ Config.BranchPredictor ]\n");

716 
	`Ârötf
(
f
, "Köd = %s\n", 
x86_b¥ed_köd_m≠
[
x86_b¥ed_köd
]);

717 
	`Ârötf
(
f
, "BTB.Së†%d\n", 
x86_b¥ed_btb_£ts
);

718 
	`Ârötf
(
f
, "BTB.Asso¯%d\n", 
x86_b¥ed_btb_assoc
);

719 
	`Ârötf
(
f
, "Bimod.Sizê%d\n", 
x86_b¥ed_bimod_size
);

720 
	`Ârötf
(
f
, "Choi˚.Sizê%d\n", 
x86_b¥ed_choi˚_size
);

721 
	`Ârötf
(
f
, "RAS.Sizê%d\n", 
x86_b¥ed_øs_size
);

722 
	`Ârötf
(
f
, "TwoLevñ.L1Sizê%d\n", 
x86_b¥ed_twﬁevñ_l1size
);

723 
	`Ârötf
(
f
, "TwoLevñ.L2Sizê%d\n", 
x86_b¥ed_twﬁevñ_l2size
);

724 
	`Ârötf
(
f
, "TwoLevñ.Hi°‹ySizê%d\n", 
x86_b¥ed_twﬁevñ_hi°_size
);

725 
	`Ârötf
(
f
, "\n");

728 
	`Ârötf
(
f
, "\n");

730 
	}
}

733 
	$X86CpuDumpRï‹t
(
X86Cpu
 *
£lf
, 
FILE
 *
f
)

735 
X86Emu
 *
emu
 = 
£lf
->emu;

736 
X86C‹e
 *
c‹e
;

737 
X86Thªad
 *
thªad
;

739 
now
;

741 
i
;

742 
j
;

745 
now
 = 
	`m2s_timî_gë_vÆue
(
	`asEmu
(
emu
)->
timî
);

748 
	`Ârötf
(
f
, ";\n; CPU Configuration\n;\n\n");

749 
	`X86DumpCpuC⁄fig
(
f
);

752 
	`Ârötf
(
f
, ";\n; Simulation Statistics\n;\n\n");

753 
	`Ârötf
(
f
, "; Global statistics\n");

754 
	`Ârötf
(
f
, "[ Global ]\n\n");

755 
	`Ârötf
(
f
, "Cy˛e†%Œd\n", 
	`asTimög
(
£lf
)->
cy˛e
);

756 
	`Ârötf
(
f
, "Timê%.2f\n", (Ë
now
 / 1000000);

757 
	`Ârötf
(
f
, "Cy˛esPîSec⁄d = %.0f\n", 
now
 ?

758 (Ë
	`asTimög
(
£lf
)->
cy˛e
 / 
now
 * 1000000 : 0.0);

759 
	`Ârötf
(
f
, "Mem‹yU£d = %lu\n", (Ë
mem_m≠≥d_•a˚
);

760 
	`Ârötf
(
f
, "Mem‹yU£dMax = %lu\n", (Ë
mem_max_m≠≥d_•a˚
);

761 
	`Ârötf
(
f
, "\n");

764 
	`Ârötf
(
f
, "; Dispatch stage\n");

765 
	`X86CpuDumpU›Rï‹t
(
£lf
, 
f
, sñf->
num_di•©ched_uö°_¨øy
,

766 "Di•©ch", 
x86_˝u_di•©ch_width
);

769 
	`Ârötf
(
f
, "; Issue stage\n");

770 
	`X86CpuDumpU›Rï‹t
(
£lf
, 
f
, sñf->
num_issued_uö°_¨øy
,

771 "Issue", 
x86_˝u_issue_width
);

774 
	`Ârötf
(
f
, "; Commit stage\n");

775 
	`X86CpuDumpU›Rï‹t
(
£lf
, 
f
, sñf->
num_commôãd_uö°_¨øy
,

776 "Commô", 
x86_˝u_commô_width
);

779 
	`Ârötf
(
f
, "; Committed branches\n");

780 
	`Ârötf
(
f
, "; Branches - Number of committed control uops\n");

781 
	`Ârötf
(
f
, "; Squashed - Number of mispredicted uops squashed fromÅhe ROB\n");

782 
	`Ârötf
(
f
, "; Mispred - Number of mispredicted branches inÅhe correctÖath\n");

783 
	`Ârötf
(
f
, "; PredAcc - Predictionáccuracy\n");

784 
	`Ârötf
(
f
, "Commô.Bønche†%Œd\n", 
£lf
->
num_bønch_uö°
);

785 
	`Ârötf
(
f
, "Commô.Squashed = %Œd\n", 
£lf
->
num_squashed_uö°
);

786 
	`Ârötf
(
f
, "Commô.Mi•ªd = %Œd\n", 
£lf
->
num_mi•ªd_bønch_uö°
);

787 
	`Ârötf
(
f
, "Commô.PªdAc¯%.4g\n", 
£lf
->
num_bønch_uö°
 ?

788 (Ë(
£lf
->
num_bønch_uö°
 - sñf->
num_mi•ªd_bønch_uö°
) / self->num_branch_uinst : 0.0);

789 
	`Ârötf
(
f
, "\n");

792 
i
 = 0; i < 
x86_˝u_num_c‹es
; i++)

795 
c‹e
 = 
£lf
->
c‹es
[
i
];

796 
	`Ârötf
(
f
, "\n; Sèti°ic†f‹ c‹ê%d\n", 
c‹e
->
id
);

797 
	`Ârötf
(
f
, "[ c%d ]\n\n", 
c‹e
->
id
);

800 
	`X86C‹eDumpFun˘i⁄ÆUnôsRï‹t
(
c‹e
, 
f
);

803 i‡(
x86_˝u_di•©ch_köd
 =
x86_˝u_di•©ch_köd_time¶i˚
)

805 
	`Ârötf
(
f
, "; Dispatch slots usage (sum = cycles * dispatch width)\n");

806 
	`Ârötf
(
f
, "; used - dispatch slot was used byáÇon-spec uop\n");

807 
	`Ârötf
(
f
, "; spec - used byá mispeculated uop\n");

808 
	`Ârötf
(
f
, "; ctx -Ço contextállocatedÅoÅhread\n");

809 
	`Ârötf
(
f
, "; uopq,rob,iq,lsq,rename -Ço space in structure\n");

810 
	`DUMP_DISPATCH_STAT
(
u£d
);

811 
	`DUMP_DISPATCH_STAT
(
•ec
);

812 
	`DUMP_DISPATCH_STAT
(
u›_queue
);

813 
	`DUMP_DISPATCH_STAT
(
rob
);

814 
	`DUMP_DISPATCH_STAT
(
iq
);

815 
	`DUMP_DISPATCH_STAT
(
lsq
);

816 
	`DUMP_DISPATCH_STAT
(
ª«me
);

817 
	`DUMP_DISPATCH_STAT
(
˘x
);

818 
	`Ârötf
(
f
, "\n");

822 
	`Ârötf
(
f
, "; Dispatch stage\n");

823 
	`X86CpuDumpU›Rï‹t
(
£lf
, 
f
, 
c‹e
->
num_di•©ched_uö°_¨øy
,

824 "Di•©ch", 
x86_˝u_di•©ch_width
);

827 
	`Ârötf
(
f
, "; Issue stage\n");

828 
	`X86CpuDumpU›Rï‹t
(
£lf
, 
f
, 
c‹e
->
num_issued_uö°_¨øy
,

829 "Issue", 
x86_˝u_issue_width
);

832 
	`Ârötf
(
f
, "; Commit stage\n");

833 
	`X86CpuDumpU›Rï‹t
(
£lf
, 
f
, 
c‹e
->
num_commôãd_uö°_¨øy
,

834 "Commô", 
x86_˝u_commô_width
);

837 
	`Ârötf
(
f
, "; Committed branches\n");

838 
	`Ârötf
(
f
, "Commô.Bønche†%Œd\n", 
c‹e
->
num_bønch_uö°
);

839 
	`Ârötf
(
f
, "Commô.Squashed = %Œd\n", 
c‹e
->
num_squashed_uö°
);

840 
	`Ârötf
(
f
, "Commô.Mi•ªd = %Œd\n", 
c‹e
->
num_mi•ªd_bønch_uö°
);

841 
	`Ârötf
(
f
, "Commô.PªdAc¯%.4g\n", 
c‹e
->
num_bønch_uö°
 ?

842 (Ë(
c‹e
->
num_bønch_uö°
 -

843 
c‹e
->
num_mi•ªd_bønch_uö°
)

844 / 
c‹e
->
num_bønch_uö°
 : 0.0);

845 
	`Ârötf
(
f
, "\n");

848 
	`Ârötf
(
f
, "; Structure statistics (reorder buffer, instruction queue,\n");

849 
	`Ârötf
(
f
, ";Üoad-store queue,ánd integer/floating-pointÑegister file)\n");

850 
	`Ârötf
(
f
, "; Size - Available size\n");

851 
	`Ârötf
(
f
, "; Occupancy - AverageÇumber of occupiedÉntries\n");

852 
	`Ârötf
(
f
, "; Full - Number of cycles whenÅhe structure was full\n");

853 
	`Ârötf
(
f
, "; Reads, Writes - AccessesÅoÅhe structure\n");

854 i‡(
x86_rob_köd
 =
x86_rob_köd_sh¨ed
)

855 
	`DUMP_CORE_STRUCT_STATS
(
ROB
, 
rob
);

856 i‡(
x86_iq_köd
 =
x86_iq_köd_sh¨ed
)

858 
	`DUMP_CORE_STRUCT_STATS
(
IQ
, 
iq
);

859 
	`Ârötf
(
f
, "IQ.WakeupAc˚s£†%Œd\n", 
c‹e
->
iq_wakeup_ac˚s£s
);

861 i‡(
x86_lsq_köd
 =
x86_lsq_köd_sh¨ed
)

862 
	`DUMP_CORE_STRUCT_STATS
(
LSQ
, 
lsq
);

863 i‡(
x86_ªg_fûe_köd
 =
x86_ªg_fûe_köd_sh¨ed
)

865 
	`DUMP_CORE_STRUCT_STATS
(
RF_I¡
, 
ªg_fûe_öt
);

866 
	`DUMP_CORE_STRUCT_STATS
(
RF_Fp
, 
ªg_fûe_Â
);

868 
	`Ârötf
(
f
, "\n");

871 
j
 = 0; j < 
x86_˝u_num_thªads
; j++)

873 
thªad
 = 
c‹e
->
thªads
[
j
];

874 
	`Ârötf
(
f
, "\n; Statistics for core %d -Åhread %d\n",

875 
c‹e
->
id
, 
thªad
->
id_ö_c‹e
);

876 
	`Ârötf
(
f
, "[ %†]\n\n", 
thªad
->
«me
);

879 
	`Ârötf
(
f
, "; Dispatch stage\n");

880 
	`X86CpuDumpU›Rï‹t
(
£lf
, 
f
, 
thªad
->
num_di•©ched_uö°_¨øy
,

881 "Di•©ch", 
x86_˝u_di•©ch_width
);

884 
	`Ârötf
(
f
, "; Issue stage\n");

885 
	`X86CpuDumpU›Rï‹t
(
£lf
, 
f
, 
thªad
->
num_issued_uö°_¨øy
,

886 "Issue", 
x86_˝u_issue_width
);

889 
	`Ârötf
(
f
, "; Commit stage\n");

890 
	`X86CpuDumpU›Rï‹t
(
£lf
, 
f
, 
thªad
->
num_commôãd_uö°_¨øy
,

891 "Commô", 
x86_˝u_commô_width
);

894 
	`Ârötf
(
f
, "; Committed branches\n");

895 
	`Ârötf
(
f
, "Commô.Bønche†%Œd\n", 
thªad
->
num_bønch_uö°
);

896 
	`Ârötf
(
f
, "Commô.Squashed = %Œd\n", 
thªad
->
num_squashed_uö°
);

897 
	`Ârötf
(
f
, "Commô.Mi•ªd = %Œd\n", 
thªad
->
num_mi•ªd_bønch_uö°
);

898 
	`Ârötf
(
f
, "Commô.PªdAc¯%.4g\n", 
thªad
->
num_bønch_uö°
 ?

899 (Ë(
thªad
->
num_bønch_uö°
 -Åhªad->
num_mi•ªd_bønch_uö°
) /Åhread->num_branch_uinst : 0.0);

900 
	`Ârötf
(
f
, "\n");

903 
	`Ârötf
(
f
, "; Structure statistics (reorder buffer, instruction queue,Üoad-store queue,\n");

904 
	`Ârötf
(
f
, "; integer/floating-pointÑegister file,ándÑenamingÅable)\n");

905 i‡(
x86_rob_köd
 =
x86_rob_köd_¥iv©e
)

906 
	`DUMP_THREAD_STRUCT_STATS
(
ROB
, 
rob
);

907 i‡(
x86_iq_köd
 =
x86_iq_köd_¥iv©e
)

909 
	`DUMP_THREAD_STRUCT_STATS
(
IQ
, 
iq
);

910 
	`Ârötf
(
f
, "IQ.WakeupAc˚s£†%Œd\n", 
thªad
->
iq_wakeup_ac˚s£s
);

912 i‡(
x86_lsq_köd
 =
x86_lsq_köd_¥iv©e
)

913 
	`DUMP_THREAD_STRUCT_STATS
(
LSQ
, 
lsq
);

914 i‡(
x86_ªg_fûe_köd
 =
x86_ªg_fûe_köd_¥iv©e
)

916 
	`DUMP_THREAD_STRUCT_STATS
(
RF_I¡
, 
ªg_fûe_öt
);

917 
	`DUMP_THREAD_STRUCT_STATS
(
RF_Fp
, 
ªg_fûe_Â
);

919 
	`Ârötf
(
f
, "RAT.I¡Ród†%Œd\n", 
thªad
->
øt_öt_ªads
);

920 
	`Ârötf
(
f
, "RAT.I¡Wrôe†%Œd\n", 
thªad
->
øt_öt_wrôes
);

921 
	`Ârötf
(
f
, "RAT.FpRód†%Œd\n", 
thªad
->
øt_Â_ªads
);

922 
	`Ârötf
(
f
, "RAT.FpWrôe†%Œd\n", 
thªad
->
øt_Â_wrôes
);

923 
	`Ârötf
(
f
, "BTB.Ród†%Œd\n", 
thªad
->
btb_ªads
);

924 
	`Ârötf
(
f
, "BTB.Wrôe†%Œd\n", 
thªad
->
btb_wrôes
);

925 
	`Ârötf
(
f
, "\n");

928 i‡(
thªad
->
åa˚_ˇche
)

929 
	`X86ThªadDumpTø˚CacheRï‹t
(
thªad
, 
f
);

932 
	}
}

935 
	$X86CpuDumpU›Rï‹t
(
X86Cpu
 *
£lf
, 
FILE
 *
f
, *
u›_°©s
,

936 *
¥efix
, 
≥ak_ùc
)

938 
uö°_öt_cou¡
 = 0;

939 
uö°_logic_cou¡
 = 0;

940 
uö°_Â_cou¡
 = 0;

941 
uö°_mem_cou¡
 = 0;

942 
uö°_˘æ_cou¡
 = 0;

943 
uö°_tŸÆ
 = 0;

945 *
«me
;

946 
x86_uö°_Êag_t
 
Êags
;

947 
i
;

949 
i
 = 0; i < 
x86_uö°_›code_cou¡
; i++)

951 
«me
 = 
x86_uö°_öfo
[
i
].name;

952 
Êags
 = 
x86_uö°_öfo
[
i
].flags;

954 
	`Ârötf
(
f
, "%s.U›.%†%Œd\n", 
¥efix
, 
«me
, 
u›_°©s
[
i
]);

955 i‡(
Êags
 & 
X86_UINST_INT
)

956 
uö°_öt_cou¡
 +
u›_°©s
[
i
];

957 i‡(
Êags
 & 
X86_UINST_LOGIC
)

958 
uö°_logic_cou¡
 +
u›_°©s
[
i
];

959 i‡(
Êags
 & 
X86_UINST_FP
)

960 
uö°_Â_cou¡
 +
u›_°©s
[
i
];

961 i‡(
Êags
 & 
X86_UINST_MEM
)

962 
uö°_mem_cou¡
 +
u›_°©s
[
i
];

963 i‡(
Êags
 & 
X86_UINST_CTRL
)

964 
uö°_˘æ_cou¡
 +
u›_°©s
[
i
];

965 
uö°_tŸÆ
 +
u›_°©s
[
i
];

967 
	`Ârötf
(
f
, "%s.I¡egî = %Œd\n", 
¥efix
, 
uö°_öt_cou¡
);

968 
	`Ârötf
(
f
, "%s.Logi¯%Œd\n", 
¥efix
, 
uö°_logic_cou¡
);

969 
	`Ârötf
(
f
, "%s.FlﬂtögPoöà%Œd\n", 
¥efix
, 
uö°_Â_cou¡
);

970 
	`Ârötf
(
f
, "%s.Mem‹y = %Œd\n", 
¥efix
, 
uö°_mem_cou¡
);

971 
	`Ârötf
(
f
, "%s.Cå»%Œd\n", 
¥efix
, 
uö°_˘æ_cou¡
);

972 
	`Ârötf
(
f
, "%s.WndSwôch = %Œd\n", 
¥efix
,

973 
u›_°©s
[
x86_uö°_ˇŒ
] + u›_°©s[
x86_uö°_ªt
]);

974 
	`Ârötf
(
f
, "%s.TŸÆ = %Œd\n", 
¥efix
, 
uö°_tŸÆ
);

975 
	`Ârötf
(
f
, "%s.IPC = %.4g\n", 
¥efix
, 
	`asTimög
(
£lf
)->
cy˛e
 ?

976 (Ë
uö°_tŸÆ
 / 
	`asTimög
(
£lf
)->
cy˛e
 : 0.0);

977 
	`Ârötf
(
f
, "%s.DutyCy˛ê%.4g\n", 
¥efix
,

978 
	`asTimög
(
£lf
)->
cy˛e
 && 
≥ak_ùc
 ?

979 (Ë
uö°_tŸÆ
 / 
	`asTimög
(
£lf
)->
cy˛e
 / 
≥ak_ùc
 : 0.0);

980 
	`Ârötf
(
f
, "\n");

981 
	}
}

984 
	$X86CpuRun
(
Timög
 *
£lf
)

986 
X86Cpu
 *
˝u
 = 
	`asX86Cpu
(
£lf
);

987 
X86Emu
 *
emu
 = 
˝u
->emu;

990 i‡(
emu
->
föished_li°_cou¡
 >emu->
c⁄ãxt_li°_cou¡
)

991  
FALSE
;

994 i‡(
x86_˝u_Á°_f‹w¨d_cou¡
 && 
	`asEmu
(
emu
)->
ö°ru˘i⁄s


995 < 
x86_˝u_Á°_f‹w¨d_cou¡
)

996 
	`X86CpuFa°F‹w¨d
(
˝u
);

999 i‡(
x86_emu_max_ö°
 && 
˝u
->
num_commôãd_ö°
 >=

1000 
x86_emu_max_ö°
 - 
x86_˝u_Á°_f‹w¨d_cou¡
)

1001 
esim_föish
 = 
esim_föish_x86_max_ö°
;

1004 i‡(
x86_emu_max_cy˛es
 && 
£lf
->
cy˛e
 >= x86_emu_max_cycles)

1005 
esim_föish
 = 
esim_föish_x86_max_cy˛es
;

1008 i‡(
esim_föish
)

1009  
TRUE
;

1012 
£lf
->
cy˛e
++;

1016 
	`X86CpuEm±yTø˚Li°
(
˝u
);

1019 
	`X86CpuRunSèges
(
˝u
);

1022 
	`X86EmuPro˚ssEvíts
(
emu
);

1025  
TRUE
;

1026 
	}
}

1029 
	$X86CpuRunSèges
(
X86Cpu
 *
£lf
)

1032 
	`X86CpuScheduÀ
(
£lf
);

1035 
	`X86CpuCommô
(
£lf
);

1036 
	`X86CpuWrôeback
(
£lf
);

1037 
	`X86CpuIssue
(
£lf
);

1038 
	`X86CpuDi•©ch
(
£lf
);

1039 
	`X86CpuDecode
(
£lf
);

1040 
	`X86CpuFëch
(
£lf
);

1043 i‡(
x86_˝u_occu∑ncy_°©s
)

1044 
	`X86CpuUpd©eOccu∑ncySèts
(
£lf
);

1045 
	}
}

1049 
	$X86CpuFa°F‹w¨d
(
X86Cpu
 *
£lf
)

1051 
X86Emu
 *
emu
 = 
£lf
->emu;

1055 
	`asEmu
(
emu
)->
ö°ru˘i⁄s
 < 
x86_˝u_Á°_f‹w¨d_cou¡
 && !
esim_föish
)

1056 
	`X86EmuRun
(
	`asEmu
(
emu
));

1059 
£lf
->
num_Á°_f‹w¨d_ö°
 = 
	`asEmu
(
emu
)->
ö°ru˘i⁄s
;

1062 i‡(
esim_föish
)

1063 
	`w¨nög
("x86 fast-forwarding finished simulation.\n%s",

1064 
x86_˝u_îr_Á°_f‹w¨d
);

1065 
	}
}

1068 
	$X86CpuAddToTø˚Li°
(
X86Cpu
 *
£lf
, 
x86_u›_t
 *
u›
)

1070 
	`as£π
(
	`x86_åacög
());

1071 
	`as£π
(!
u›
->
ö_u›_åa˚_li°
);

1073 
u›
->
ö_u›_åa˚_li°
 = 1;

1074 
	`löked_li°_add
(
£lf
->
u›_åa˚_li°
, 
u›
);

1075 
	}
}

1078 
	$X86CpuEm±yTø˚Li°
(
X86Cpu
 *
£lf
)

1080 
X86Thªad
 *
thªad
;

1081 
X86C‹e
 *
c‹e
;

1082 
löked_li°_t
 *
u›_åa˚_li°
;

1083 
x86_u›_t
 *
u›
;

1085 
u›_åa˚_li°
 = 
£lf
->uop_trace_list;

1086 
u›_åa˚_li°
->
cou¡
)

1089 
	`löked_li°_hód
(
u›_åa˚_li°
);

1090 
u›
 = 
	`löked_li°_gë
(
u›_åa˚_li°
);

1091 
thªad
 = 
u›
->thread;

1092 
c‹e
 = 
thªad
->core;

1093 
	`löked_li°_ªmove
(
u›_åa˚_li°
);

1094 
	`as£π
(
u›
->
ö_u›_åa˚_li°
);

1097 
	`x86_åa˚
("x86.end_inst id=%lld core=%d\n",

1098 
u›
->
id_ö_c‹e
, 
c‹e
->
id
);

1101 
u›
->
ö_u›_åa˚_li°
 = 0;

1102 
	`x86_u›_‰ì_if_nŸ_queued
(
u›
);

1104 
	}
}

1107 
	#UPDATE_THREAD_OCCUPANCY_STATS
(
ITEM
) { \

1108 
thªad
->
ITEM
##
_occu∑ncy
 +thªad->ITEM##
_cou¡
; \

1109 i‡(
thªad
->
ITEM
##
_cou¡
 =
x86_
##ITEM##
_size
) \

1110 
thªad
->
ITEM
##
_fuŒ
++; \

1111 }

	)

1114 
	#UPDATE_CORE_OCCUPANCY_STATS
(
ITEM
) { \

1115 
c‹e
->
ITEM
##
_occu∑ncy
 +c‹e->ITEM##
_cou¡
; \

1116 i‡(
c‹e
->
ITEM
##
_cou¡
 =
x86_
##ITEM##
_size
 * 
x86_˝u_num_thªads
) \

1117 
c‹e
->
ITEM
##
_fuŒ
++; \

1118 }

	)

1121 
	$X86CpuUpd©eOccu∑ncySèts
(
X86Cpu
 *
£lf
)

1123 
X86C‹e
 *
c‹e
;

1124 
X86Thªad
 *
thªad
;

1126 
i
;

1127 
j
;

1129 
i
 = 0; i < 
x86_˝u_num_c‹es
; i++)

1131 
c‹e
 = 
£lf
->
c‹es
[
i
];

1134 i‡(
x86_rob_köd
 =
x86_rob_köd_sh¨ed
)

1135 
	`UPDATE_CORE_OCCUPANCY_STATS
(
rob
);

1136 i‡(
x86_iq_köd
 =
x86_iq_köd_sh¨ed
)

1137 
	`UPDATE_CORE_OCCUPANCY_STATS
(
iq
);

1138 i‡(
x86_lsq_köd
 =
x86_lsq_köd_sh¨ed
)

1139 
	`UPDATE_CORE_OCCUPANCY_STATS
(
lsq
);

1140 i‡(
x86_ªg_fûe_köd
 =
x86_ªg_fûe_köd_sh¨ed
)

1142 
	`UPDATE_CORE_OCCUPANCY_STATS
(
ªg_fûe_öt
);

1143 
	`UPDATE_CORE_OCCUPANCY_STATS
(
ªg_fûe_Â
);

1147 
j
 = 0; j < 
x86_˝u_num_thªads
; j++)

1149 
thªad
 = 
c‹e
->
thªads
[
j
];

1150 i‡(
x86_rob_köd
 =
x86_rob_köd_¥iv©e
)

1151 
	`UPDATE_THREAD_OCCUPANCY_STATS
(
rob
);

1152 i‡(
x86_iq_köd
 =
x86_iq_köd_¥iv©e
)

1153 
	`UPDATE_THREAD_OCCUPANCY_STATS
(
iq
);

1154 i‡(
x86_lsq_köd
 =
x86_lsq_köd_¥iv©e
)

1155 
	`UPDATE_THREAD_OCCUPANCY_STATS
(
lsq
);

1156 i‡(
x86_ªg_fûe_köd
 =
x86_ªg_fûe_köd_¥iv©e
)

1158 
	`UPDATE_THREAD_OCCUPANCY_STATS
(
ªg_fûe_öt
);

1159 
	`UPDATE_THREAD_OCCUPANCY_STATS
(
ªg_fûe_Â
);

1163 
	}
}

	@cpu.h

20 #i‚de‡
X86_ARCH_TIMING_CPU_H


21 
	#X86_ARCH_TIMING_CPU_H


	)

23 
	~<¨ch/comm⁄/timög.h
>

24 
	~<¨ch/x86/emu/uö°.h
>

25 
	~<lib/utû/˛ass.h
>

29 
	gx86_u›_t
;

38 
	$CLASS_BEGIN
(
X86Cpu
, 
Timög
)

41 
X86Emu
 *
emu
;

44 
X86C‹e
 **
c‹es
;

47 
u›_id_cou¡î
;

48 *
°age
;

55 
mö_Æloc_cy˛e
;

58 
löked_li°_t
 *
u›_åa˚_li°
;

61 
num_Á°_f‹w¨d_ö°
;

62 
num_„tched_uö°
;

63 
num_di•©ched_uö°_¨øy
[
x86_uö°_›code_cou¡
];

64 
num_issued_uö°_¨øy
[
x86_uö°_›code_cou¡
];

65 
num_commôãd_uö°_¨øy
[
x86_uö°_›code_cou¡
];

66 
num_commôãd_uö°
;

67 
num_commôãd_ö°
;

68 
num_squashed_uö°
;

69 
num_bønch_uö°
;

70 
num_mi•ªd_bønch_uö°
;

71 
time
;

74 
œ°_commôãd
;

75 
œ°_dump
;

77 
	$CLASS_END
(
X86Cpu
)

80 
	`X86CpuCª©e
(
X86Cpu
 *
£lf
, 
X86Emu
 *
emu
);

81 
	`X86CpuDe°roy
(
X86Cpu
 *
£lf
);

83 
	`X86CpuDump
(
Obje˘
 *
£lf
, 
FILE
 *
f
);

84 
	`X86CpuDumpSumm¨y
(
Timög
 *
£lf
, 
FILE
 *
f
);

85 
	`X86CpuDumpRï‹t
(
X86Cpu
 *
£lf
, 
FILE
 *
f
);

86 
	`X86CpuDumpU›Rï‹t
(
X86Cpu
 *
£lf
, 
FILE
 *
f
, *
u›_°©s
,

87 *
¥efix
, 
≥ak_ùc
);

89 
	`X86CpuRun
(
Timög
 *
£lf
);

90 
	`X86CpuRunSèges
(
X86Cpu
 *
£lf
);

91 
	`X86CpuFa°F‹w¨d
(
X86Cpu
 *
£lf
);

93 
	`X86CpuAddToTø˚Li°
(
X86Cpu
 *
£lf
, 
x86_u›_t
 *
u›
);

94 
	`X86CpuEm±yTø˚Li°
(
X86Cpu
 *
£lf
);

96 
	`X86CpuUpd©eOccu∑ncySèts
(
X86Cpu
 *
£lf
);

105 
	#x86_˝u_îr‹_debug
(...Ë
	`debug
(
x86_˝u_îr‹_debug_ˇãg‹y
, 
__VA_ARGS__
)

	)

106 
x86_˝u_îr‹_debug_ˇãg‹y
;

108 *
x86_c⁄fig_hñp
;

110 *
x86_c⁄fig_fûe_«me
;

111 *
x86_˝u_ªp‹t_fûe_«me
;

113 
x86_˝u_num_c‹es
;

114 
x86_˝u_num_thªads
;

116 
x86_˝u_c⁄ãxt_qu™tum
;

118 
x86_˝u_thªad_qu™tum
;

119 
x86_˝u_thªad_swôch_≥«…y
;

122 *
x86_˝u_ªcovî_köd_m≠
[];

123 
	ex86_˝u_ªcovî_köd_t


125 
x86_˝u_ªcovî_köd_wrôeback
 = 0,

126 
x86_˝u_ªcovî_köd_commô


127 } 
x86_˝u_ªcovî_köd
;

128 
x86_˝u_ªcovî_≥«…y
;

131 *
x86_˝u_„tch_köd_m≠
[];

132 
	ex86_˝u_„tch_köd_t


134 
x86_˝u_„tch_köd_sh¨ed
 = 0,

135 
x86_˝u_„tch_köd_time¶i˚
,

136 
x86_˝u_„tch_köd_swôch⁄evít


137 } 
x86_˝u_„tch_köd
;

140 
x86_˝u_decode_width
;

143 *
x86_˝u_di•©ch_köd_m≠
[];

144 
	ex86_˝u_di•©ch_köd_t


146 
x86_˝u_di•©ch_köd_sh¨ed
 = 0,

147 
x86_˝u_di•©ch_köd_time¶i˚
,

148 } 
x86_˝u_di•©ch_köd
;

149 
x86_˝u_di•©ch_width
;

152 *
x86_˝u_issue_köd_m≠
[];

153 
	ex86_˝u_issue_köd_t


155 
x86_˝u_issue_köd_sh¨ed
 = 0,

156 
x86_˝u_issue_köd_time¶i˚
,

157 } 
x86_˝u_issue_köd
;

158 
x86_˝u_issue_width
;

161 *
x86_˝u_commô_köd_m≠
[];

162 
	ex86_˝u_commô_köd_t


164 
x86_˝u_commô_köd_sh¨ed
 = 0,

165 
x86_˝u_commô_köd_time¶i˚


166 } 
x86_˝u_commô_köd
;

167 
x86_˝u_commô_width
;

171 
	#x86_åacög
(Ë
	`åa˚_°©us
(
x86_åa˚_ˇãg‹y
)

	)

172 
	#x86_åa˚
(...Ë
	`åa˚
(
x86_åa˚_ˇãg‹y
, 
__VA_ARGS__
)

	)

173 
	#x86_åa˚_hódî
(...Ë
	`åa˚_hódî
(
x86_åa˚_ˇãg‹y
, 
__VA_ARGS__
)

	)

174 
x86_åa˚_ˇãg‹y
;

177 
	`X86CpuRódC⁄fig
();

178 
	`X86CpuInô
();

179 
	`X86CpuD⁄e
();

	@decode.c

21 
	~<lib/esim/åa˚.h
>

22 
	~<lib/utû/li°.h
>

23 
	~<mem-sy°em/moduÀ.h
>

25 
	~"c‹e.h
"

26 
	~"˝u.h
"

27 
	~"decode.h
"

28 
	~"„tch-queue.h
"

29 
	~"thªad.h
"

30 
	~"u›.h
"

31 
	~"u›-queue.h
"

39 
	$X86ThªadDecode
(
X86Thªad
 *
£lf
)

41 
X86C‹e
 *
c‹e
 = 
£lf
->core;

43 
li°_t
 *
„tchq
 = 
£lf
->
„tch_queue
;

44 
li°_t
 *
u›q
 = 
£lf
->
u›_queue
;

45 
x86_u›_t
 *
u›
;

46 
i
;

48 
i
 = 0; i < 
x86_˝u_decode_width
; i++)

51 i‡(!
	`li°_cou¡
(
„tchq
))

53 i‡(
	`li°_cou¡
(
u›q
Ë>
x86_u›_queue_size
)

55 
u›
 = 
	`li°_gë
(
„tchq
, 0);

56 
	`as£π
(
	`x86_u›_exi°s
(
u›
));

61 i‡(
u›
->
åa˚_ˇche
)

65 
	`X86ThªadRemoveFromFëchQueue
(
£lf
, 0);

66 
	`li°_add
(
u›q
, 
u›
);

67 
u›
->
ö_u›_queue
 = 1;

68 
u›
 = 
	`li°_gë
(
„tchq
, 0);

69 } 
u›
 && u›->
åa˚_ˇche
);

75 
	`as£π
(!
u›
->
m›_ödex
);

76 i‡(!
	`mod_ö_Êight_ac˚ss
(
£lf
->
ö°_mod
, 
u›
->
„tch_ac˚ss
, u›->
„tch_addªss
))

81 
	`X86ThªadRemoveFromFëchQueue
(
£lf
, 0);

82 
	`li°_add
(
u›q
, 
u›
);

83 
u›
->
ö_u›_queue
 = 1;

86 
	`x86_åa˚
("x86.inst id=%lld core=%d stg=\"dec\"\n",

87 
u›
->
id_ö_c‹e
, 
c‹e
->
id
);

90 
u›
 = 
	`li°_gë
(
„tchq
, 0);

92 } 
u›
 && u›->
m›_ödex
);

95 
	}
}

104 
	$X86CpuDecode
(
X86Cpu
 *
£lf
)

106 
i
;

107 
j
;

109 
£lf
->
°age
 = "decode";

110 
i
 = 0; i < 
x86_˝u_num_c‹es
; i++)

111 
j
 = 0; j < 
x86_˝u_num_thªads
; j++)

112 
	`X86ThªadDecode
(
£lf
->
c‹es
[
i
]->
thªads
[
j
]);

113 
	}
}

	@decode.h

20 #i‚de‡
ARCH_X86_TIMING_DECODE_H


21 
	#ARCH_X86_TIMING_DECODE_H


	)

23 
	~<lib/utû/˛ass.h
>

29 
X86CpuDecode
(
X86Cpu
 *
£lf
);

	@dispatch.c

21 
	~<¨ch/x86/emu/c⁄ãxt.h
>

22 
	~<lib/esim/åa˚.h
>

23 
	~<lib/utû/li°.h
>

25 
	~"c‹e.h
"

26 
	~"˝u.h
"

27 
	~"di•©ch.h
"

28 
	~"ö°-queue.h
"

29 
	~"lﬂd-°‹e-queue.h
"

30 
	~"ªg-fûe.h
"

31 
	~"rob.h
"

32 
	~"thªad.h
"

33 
	~"åa˚-ˇche.h
"

38 
x86_di•©ch_°Æl_t
 
	$X86ThªadC™Di•©ch
(
X86Thªad
 *
£lf
)

40 
X86C‹e
 *
c‹e
 = 
£lf
->core;

41 
li°_t
 *
u›q
 = 
£lf
->
u›_queue
;

42 
x86_u›_t
 *
u›
;

45 
u›
 = 
	`li°_gë
(
u›q
, 0);

46 i‡(!
u›
)

47  !
£lf
->
˘x
 || !
	`X86C⁄ãxtGëSèã
(£lf->˘x, 
X86C⁄ãxtRu¬ög
) ?

48 
x86_di•©ch_°Æl_˘x
 : 
x86_di•©ch_°Æl_u›_queue
;

51 i‡(!
	`X86C‹eC™EnqueueInROB
(
c‹e
, 
u›
))

52  
x86_di•©ch_°Æl_rob
;

53 i‡(!(
u›
->
Êags
 & 
X86_UINST_MEM
Ë&& !
	`X86ThªadC™In£πInIQ
(
£lf
, uop))

54  
x86_di•©ch_°Æl_iq
;

55 i‡((
u›
->
Êags
 & 
X86_UINST_MEM
Ë&& !
	`X86ThªadC™In£πInLSQ
(
£lf
, uop))

56  
x86_di•©ch_°Æl_lsq
;

57 i‡(!
	`X86ThªadC™RíameU›
(
£lf
, 
u›
))

58  
x86_di•©ch_°Æl_ª«me
;

60  
x86_di•©ch_°Æl_u£d
;

61 
	}
}

64 
	$X86ThªadDi•©ch
(
X86Thªad
 *
£lf
, 
qu™tum
)

66 
X86C‹e
 *
c‹e
 = 
£lf
->core;

67 
X86Cpu
 *
˝u
 = 
£lf
->cpu;

69 
x86_u›_t
 *
u›
;

70 
x86_di•©ch_°Æl_t
 
°Æl
;

72 
qu™tum
)

75 
°Æl
 = 
	`X86ThªadC™Di•©ch
(
£lf
);

76 i‡(
°Æl
 !
x86_di•©ch_°Æl_u£d
)

78 
c‹e
->
di•©ch_°Æl
[
°Æl
] +
qu™tum
;

83 
u›
 = 
	`li°_ªmove_©
(
£lf
->
u›_queue
, 0);

84 
	`as£π
(
	`x86_u›_exi°s
(
u›
));

85 
u›
->
ö_u›_queue
 = 0;

88 
	`X86ThªadRíameU›
(
£lf
, 
u›
);

91 
	`X86C‹eEnqueueInROB
(
c‹e
, 
u›
);

92 
c‹e
->
rob_wrôes
++;

93 
£lf
->
rob_wrôes
++;

96 i‡(!(
u›
->
Êags
 & 
X86_UINST_MEM
))

98 
	`X86ThªadIn£πInIQ
(
£lf
, 
u›
);

99 
c‹e
->
iq_wrôes
++;

100 
£lf
->
iq_wrôes
++;

104 i‡(
u›
->
Êags
 & 
X86_UINST_MEM
)

106 
	`X86ThªadIn£πInLSQ
(
£lf
, 
u›
);

107 
c‹e
->
lsq_wrôes
++;

108 
£lf
->
lsq_wrôes
++;

112 
c‹e
->
di•©ch_°Æl
[
u›
->
•ecmode
 ? 
x86_di•©ch_°Æl_•ec
 : 
x86_di•©ch_°Æl_u£d
]++;

113 
£lf
->
num_di•©ched_uö°_¨øy
[
u›
->
uö°
->
›code
]++;

114 
c‹e
->
num_di•©ched_uö°_¨øy
[
u›
->
uö°
->
›code
]++;

115 
˝u
->
num_di•©ched_uö°_¨øy
[
u›
->
uö°
->
›code
]++;

116 i‡(
u›
->
åa˚_ˇche
)

117 
£lf
->
åa˚_ˇche
->
num_di•©ched_uö°
++;

120 
qu™tum
--;

123 
	`x86_åa˚
("x86.inst id=%lld core=%d stg=\"di\"\n",

124 
u›
->
id_ö_c‹e
, 
c‹e
->
id
);

128  
qu™tum
;

129 
	}
}

132 
	$X86C‹eDi•©ch
(
X86C‹e
 *
£lf
)

134 
X86Thªad
 *
thªad
;

136 
skù
 = 
x86_˝u_num_thªads
;

137 
qu™tum
 = 
x86_˝u_di•©ch_width
;

138 
ªmaö
;

140 
x86_˝u_di•©ch_köd
)

143 
x86_˝u_di•©ch_köd_sh¨ed
:

147 
£lf
->
di•©ch_cuºít
 = (£lf->di•©ch_cuºíà+ 1Ë% 
x86_˝u_num_thªads
;

148 
thªad
 = 
£lf
->
thªads
[£lf->
di•©ch_cuºít
];

149 
ªmaö
 = 
	`X86ThªadDi•©ch
(
thªad
, 1);

150 
skù
 = 
ªmaö
 ? skù - 1 : 
x86_˝u_num_thªads
;

151 
qu™tum
 = 
ªmaö
 ? quantum : quantum - 1;

152 } 
qu™tum
 && 
skù
);

155 
x86_˝u_di•©ch_köd_time¶i˚
:

159 
£lf
->
di•©ch_cuºít
 = (£lf->di•©ch_cuºíà+ 1Ë% 
x86_˝u_num_thªads
;

160 
thªad
 = 
£lf
->
thªads
[£lf->
di•©ch_cuºít
];

161 
skù
--;

162 } 
skù
 && 
	`X86ThªadC™Di•©ch
(
thªad
Ë!
x86_di•©ch_°Æl_u£d
);

163 
	`X86ThªadDi•©ch
(
thªad
, 
qu™tum
);

166 
	}
}

169 
	$X86CpuDi•©ch
(
X86Cpu
 *
£lf
)

171 
i
;

173 
£lf
->
°age
 = "dispatch";

174 
i
 = 0; i < 
x86_˝u_num_c‹es
; i++)

175 
	`X86C‹eDi•©ch
(
£lf
->
c‹es
[
i
]);

176 
	}
}

	@dispatch.h

20 #i‚de‡
ARCH_X86_TIMING_DISPATCH_H


21 
	#ARCH_X86_TIMING_DISPATCH_H


	)

23 
	~<lib/utû/˛ass.h
>

30 
X86CpuDi•©ch
(
X86Cpu
 *
£lf
);

	@event-queue.c

21 
	~<lib/utû/löked-li°.h
>

22 
	~<lib/esim/åa˚.h
>

24 
	~"c‹e.h
"

25 
	~"˝u.h
"

26 
	~"evít-queue.h
"

27 
	~"thªad.h
"

28 
	~"u›.h
"

36 
	$X86C‹eInôEvítQueue
(
X86C‹e
 *
£lf
)

38 
£lf
->
evít_queue
 = 
	`löked_li°_¸óã
();

39 
	}
}

42 
	$X86C‹eFªeEvítQueue
(
X86C‹e
 *
£lf
)

44 
x86_u›_t
 *
u›
;

46 
	`löked_li°_cou¡
(
£lf
->
evít_queue
))

48 
u›
 = 
	`X86C‹eExåa˘FromEvítQueue
(
£lf
);

49 
	`x86_u›_‰ì_if_nŸ_queued
(
u›
);

51 
	`löked_li°_‰ì
(
£lf
->
evít_queue
);

52 
	}
}

55 
	$evítq_com∑ª
(c⁄° *
ôem1
, c⁄° *
ôem2
)

57 c⁄° 
x86_u›_t
 *
u›1
 = 
ôem1
;

58 c⁄° 
x86_u›_t
 *
u›2
 = 
ôem2
;

59  
u›1
->
whí
 !
u›2
->when ? uop1->when - uop2->when

60 : 
u›1
->
id
 - 
u›2
->id;

61 
	}
}

64 
	$X86C‹eIn£πInEvítQueue
(
X86C‹e
 *
£lf
, 
x86_u›_t
 *
u›
)

66 
löked_li°_t
 *
evít_queue
 = 
£lf
->event_queue;

67 
x86_u›_t
 *
ôem
;

69 
	`as£π
(!
u›
->
ö_evít_queue
);

70 
	`löked_li°_hód
(
evít_queue
);

73 
ôem
 = 
	`löked_li°_gë
(
evít_queue
);

74 i‡(!
ôem
 || 
	`evítq_com∑ª
(
u›
, item) < 0)

76 
	`löked_li°_√xt
(
evít_queue
);

78 
	`löked_li°_ö£π
(
evít_queue
, 
u›
);

79 
u›
->
ö_evít_queue
 = 1;

80 
	}
}

83 
x86_u›_t
 *
	$X86C‹eExåa˘FromEvítQueue
(
X86C‹e
 *
£lf
)

85 
löked_li°_t
 *
evít_queue
 = 
£lf
->event_queue;

86 
x86_u›_t
 *
u›
;

88 i‡(!
	`löked_li°_cou¡
(
evít_queue
))

89  
NULL
;

91 
	`löked_li°_hód
(
evít_queue
);

92 
u›
 = 
	`löked_li°_gë
(
evít_queue
);

93 
	`as£π
(
	`x86_u›_exi°s
(
u›
));

94 
	`as£π
(
u›
->
ö_evít_queue
);

95 
	`löked_li°_ªmove
(
evít_queue
);

96 
u›
->
ö_evít_queue
 = 0;

97  
u›
;

98 
	}
}

100 
	$X86ThªadIPªdi˘‹CacheMissEvítUpd©e
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
)

102 
x86_ö°_¥ed_t
 *
¥ed
 = &(
£lf
->
ùªd
);

103 
cuº_∑âîn_öd
 = 
¥ed
->
cuº_∑âîn_ödex
;

104 
x86_ö°_∑âîn_t
 *
∑âîn
 = &
¥ed
->
∑âîn_hi°‹y
[
cuº_∑âîn_öd
];

105 
x86_uö°_Êag_t
 
Êags
 = 
u›
->flags;

106 
avg_ö°_cou¡
 = 0;

107 
tŸÆ_ö°_cou¡
 = 0;

109 
¥ev_∑âîn_öd
 = 
cuº_∑âîn_öd
 - 1;

110 i‡(
¥ev_∑âîn_öd
 < 0)

112 i‡(
¥ed
->
tŸÆ_∑âîn_¥o˚s£d
 > 
MAX_PATTERN_ITER_COUNT
)

114 
¥ev_∑âîn_öd
 = 
MAX_PATTERN_ITER_COUNT
;

117 
x86_ö°_∑âîn_t
 *
¥ev_∑âîn
 = &
¥ed
->
∑âîn_hi°‹y
[
¥ev_∑âîn_öd
>=0?prev_pattern_ind:0];

119 
∑âîn
->
ˇche_miss
++;

120 i‡(
	`x86_åacög
())

122 
	`x86_åa˚
("PallaviÅhread[%s]- update on cache missÉvent : %d, %lld,%lld,%lld,%lld,%lld,%lld, %lld, %d, %lld, %lld, %f\n",

123 
£lf
->
«me
,

124 
cuº_∑âîn_öd
,

125 
∑âîn
->
uö°_tŸÆ
,

126 
∑âîn
->
uö°_öt_cou¡
,

127 
∑âîn
->
uö°_logic_cou¡
,

128 
∑âîn
->
uö°_Â_cou¡
,

129 
∑âîn
->
uö°_mem_cou¡
,

130 
∑âîn
->
uö°_˘æ_cou¡
,

131 
∑âîn
->
ˇche_miss
,

132 
£lf
->
ùªd
.
√xt_¥ed_mem_ö°_di°™˚
,

133 
¥ed
->
tŸÆ_∑âîn_¥o˚s£d
,

134 
tŸÆ_ö°_cou¡
,

135 
avg_ö°_cou¡


139 
	}
}

141 
	$X86ThªadIPªdi˘‹LLEvítUpd©e
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
)

143 
x86_ö°_¥ed_t
 *
¥ed
 = &(
£lf
->
ùªd
);

144 
cuº_∑âîn_öd
 = 
¥ed
->
cuº_∑âîn_ödex
;

145 
x86_ö°_∑âîn_t
 *
∑âîn
 = &
¥ed
->
∑âîn_hi°‹y
[
cuº_∑âîn_öd
];

146 
x86_uö°_Êag_t
 
Êags
 = 
u›
->flags;

147 
avg_ö°_cou¡
 = 0;

148 
tŸÆ_ö°_cou¡
 = 0;

150 
¥ev_∑âîn_öd
 = 
cuº_∑âîn_öd
 - 1;

151 i‡(
¥ev_∑âîn_öd
 < 0)

153 i‡(
¥ed
->
tŸÆ_∑âîn_¥o˚s£d
 > 
MAX_PATTERN_ITER_COUNT
)

155 
¥ev_∑âîn_öd
 = 
MAX_PATTERN_ITER_COUNT
;

158 
x86_ö°_∑âîn_t
 *
¥ev_∑âîn
 = &
¥ed
->
∑âîn_hi°‹y
[
¥ev_∑âîn_öd
>=0?prev_pattern_ind:0];

161 
tŸÆ_ö°_cou¡
 +
£lf
->
ùªd
.
∑âîn_hi°‹y
[
cuº_∑âîn_öd
].
uö°_tŸÆ
;

162 
¥ed
->
tŸÆ_∑âîn_¥o˚s£d
++;

165 i‡(
¥ed
->
tŸÆ_∑âîn_¥o˚s£d
 > 
THESHOLD_PATTERN_ITER_COUNT
)

168 
tŸÆ_ö°_cou¡
 +
£lf
->
ùªd
.
∑âîn_hi°‹y
[
cuº_∑âîn_öd
].
uö°_tŸÆ
;

169 
avg_ö°_cou¡
 = ()
tŸÆ_ö°_cou¡
/()
¥ed
->
tŸÆ_∑âîn_¥o˚s£d
;

170 
¥ed
->
ru¬ög_avg_ö°_≥r_∑âîn
 = 
avg_ö°_cou¡
;

172 
di°™˚
 = 
avg_ö°_cou¡
 - 
∑âîn
->
uö°_tŸÆ
;

173 
¥ed
->
√xt_¥ed_mem_ö°_di°™˚
 = 
di°™˚
;

176 i‡(
	`x86_åacög
())

178 
	`x86_åa˚
("PallaviÅhread[%s]- update onÜonglatencyÉvent dist: %d, %lld,%lld,%lld,%lld,%lld,%lld, %d, %lld, %lld, %f\n",

179 
£lf
->
«me
,

180 
cuº_∑âîn_öd
,

181 
∑âîn
->
uö°_tŸÆ
,

182 
∑âîn
->
uö°_öt_cou¡
,

183 
∑âîn
->
uö°_logic_cou¡
,

184 
∑âîn
->
uö°_Â_cou¡
,

185 
∑âîn
->
uö°_mem_cou¡
,

186 
∑âîn
->
uö°_˘æ_cou¡
,

187 
£lf
->
ùªd
.
√xt_¥ed_mem_ö°_di°™˚
,

188 
¥ed
->
tŸÆ_∑âîn_¥o˚s£d
,

189 
tŸÆ_ö°_cou¡
,

190 
avg_ö°_cou¡


193 i‡(
¥ev_∑âîn_öd
 >= 0)

195 
	`x86_åa˚
("PallaviÅhread[%s]- distance onÜonglatencyÉvent:"

197 
£lf
->
«me
,

198 
cuº_∑âîn_öd
 - 
¥ev_∑âîn_öd
,

199 
∑âîn
->
uö°_tŸÆ
 - 
¥ev_∑âîn
->uinst_total,

200 
∑âîn
->
uö°_öt_cou¡
 - 
¥ev_∑âîn
->uinst_int_count,

201 
∑âîn
->
uö°_logic_cou¡
 - 
¥ev_∑âîn
->uinst_logic_count,

202 
∑âîn
->
uö°_Â_cou¡
 - 
¥ev_∑âîn
->uinst_fp_count,

203 
∑âîn
->
uö°_mem_cou¡
 - 
¥ev_∑âîn
->uinst_mem_count,

204 
∑âîn
->
uö°_˘æ_cou¡
 - 
¥ev_∑âîn
->uinst_ctrl_count,

205 
∑âîn
->
ˇche_miss
 - 
¥ev_∑âîn
->cache_miss,

206 
∑âîn
->
ˇche_miss
,

207 
£lf
->
ùªd
.
√xt_¥ed_mem_ö°_di°™˚
,

208 
¥ed
->
tŸÆ_∑âîn_¥o˚s£d
,

209 
tŸÆ_ö°_cou¡
,

210 
avg_ö°_cou¡


217 
cuº_∑âîn_öd
 = (cuº_∑âîn_öd + 1Ë% 
MAX_PATTERN_ITER_COUNT
;

218 
¥ed
->
cuº_∑âîn_ödex
 = 
cuº_∑âîn_öd
;

220 
∑âîn
 = &(
¥ed
->
∑âîn_hi°‹y
[¥ed->
cuº_∑âîn_ödex
]);

221 
∑âîn
->
uö°_öt_cou¡
=0;

222 
∑âîn
->
uö°_logic_cou¡
=0;

223 
∑âîn
->
uö°_Â_cou¡
=0;

224 
∑âîn
->
uö°_mem_cou¡
=0;

225 
∑âîn
->
uö°_˘æ_cou¡
=0;

226 
∑âîn
->
uö°_tŸÆ
=0;

229 
	}
}

236 
	$X86ThªadL⁄gL©ícyInEvítQueue
(
X86Thªad
 *
£lf
)

238 
X86Cpu
 *
˝u
 = 
£lf
->cpu;

239 
X86C‹e
 *
c‹e
 = 
£lf
->core;

241 
löked_li°_t
 *
evít_queue
 = 
c‹e
->event_queue;

242 
x86_u›_t
 *
u›
;

244 
	`LINKED_LIST_FOR_EACH
(
evít_queue
)

246 
u›
 = 
	`löked_li°_gë
(
evít_queue
);

247 i‡(
u›
->
thªad
 !
£lf
)

254 i‡(
£lf
->
ùªd
.
√xt_¥ed_mem_ö°_di°™˚
 >=0)

256 i‡(
	`x86_åacög
())

258 
	`x86_åa˚
("Pallavi -Öredicted memoryÉvent dist: %d\n",

259 
£lf
->
ùªd
.
√xt_¥ed_mem_ö°_di°™˚
);

263 
x86_uö°_Êag_t
 
Êags
 = 
u›
->flags;

264 i‡((
Êags
 & 
X86_UINST_MEM
Ë&& (
	`asTimög
(
˝u
)->
cy˛e
 - 
u›
->
issue_whí
 > 9))

266 
	`X86ThªadIPªdi˘‹CacheMissEvítUpd©e
(
£lf
, 
u›
);

267 i‡(
	`x86_åacög
())

269 
	`x86_åa˚
("Pallavi -Cahce Miss Event:: ipred memoryÖred dist: %d\n",

270 
£lf
->
ùªd
.
√xt_¥ed_mem_ö°_di°™˚
);

274 i‡(
	`asTimög
(
˝u
)->
cy˛e
 - 
u›
->
issue_whí
 > 20)

276 
	`X86ThªadIPªdi˘‹LLEvítUpd©e
(
£lf
, 
u›
);

277 i‡(
	`x86_åacög
())

279 
	`x86_åa˚
("Pallavi -LLEvent:: ipred memoryÖred dist: %d\n",

280 
£lf
->
ùªd
.
√xt_¥ed_mem_ö°_di°™˚
);

286 
	}
}

289 
	$X86ThªadCacheMissInEvítQueue
(
X86Thªad
 *
£lf
)

291 
X86Cpu
 *
˝u
 = 
£lf
->cpu;

292 
X86C‹e
 *
c‹e
 = 
£lf
->core;

294 
löked_li°_t
 *
evít_queue
 = 
c‹e
->event_queue;

295 
x86_u›_t
 *
u›
;

297 
	`LINKED_LIST_FOR_EACH
(
evít_queue
)

299 
u›
 = 
	`löked_li°_gë
(
evít_queue
);

300 i‡(
u›
->
thªad
 !
£lf
 || u›->
uö°
->
›code
 !
x86_uö°_lﬂd
)

302 i‡(
	`asTimög
(
˝u
)->
cy˛e
 - 
u›
->
issue_whí
 > 5)

306 
	}
}

309 
	$X86ThªadRecovîEvítQueue
(
X86Thªad
 *
£lf
)

311 
X86C‹e
 *
c‹e
 = 
£lf
->core;

313 
löked_li°_t
 *
evít_queue
 = 
c‹e
->event_queue;

314 
x86_u›_t
 *
u›
;

316 
	`löked_li°_hód
(
evít_queue
);

317 !
	`löked_li°_is_íd
(
evít_queue
))

319 
u›
 = 
	`löked_li°_gë
(
evít_queue
);

320 i‡(
u›
->
thªad
 =
£lf
 && u›->
•ecmode
)

322 
	`löked_li°_ªmove
(
evít_queue
);

323 
u›
->
ö_evít_queue
 = 0;

324 
	`x86_u›_‰ì_if_nŸ_queued
(
u›
);

327 
	`löked_li°_√xt
(
evít_queue
);

329 
	}
}

	@event-queue.h

20 #i‚de‡
X86_ARCH_TIMING_EVENT_QUEUE_H


21 
	#X86_ARCH_TIMING_EVENT_QUEUE_H


	)

28 
X86C‹eInôEvítQueue
(
X86C‹e
 *
£lf
);

29 
X86C‹eFªeEvítQueue
(
X86C‹e
 *
£lf
);

31 
X86C‹eIn£πInEvítQueue
(
X86C‹e
 *
£lf
, 
x86_u›_t
 *
u›
);

32 
x86_u›_t
 *
X86C‹eExåa˘FromEvítQueue
(
X86C‹e
 *
£lf
);

40 
X86ThªadL⁄gL©ícyInEvítQueue
(
X86Thªad
 *
£lf
);

41 
X86ThªadCacheMissInEvítQueue
(
X86Thªad
 *
£lf
);

42 
X86ThªadRecovîEvítQueue
(
X86Thªad
 *
£lf
);

	@fetch-queue.c

21 
	~<lib/esim/åa˚.h
>

22 
	~<lib/utû/li°.h
>

24 
	~"c‹e.h
"

25 
	~"˝u.h
"

26 
	~"„tch-queue.h
"

27 
	~"u›.h
"

28 
	~"thªad.h
"

31 
	$X86ThªadInôFëchQueue
(
X86Thªad
 *
£lf
)

33 
£lf
->
„tch_queue
 = 
	`li°_¸óã_wôh_size
(
x86_„tch_queue_size
);

34 
	}
}

37 
	$X86ThªadFªeFëchQueue
(
X86Thªad
 *
£lf
)

39 
li°_t
 *
„tchq
;

40 
x86_u›_t
 *
u›
;

42 
„tchq
 = 
£lf
->
„tch_queue
;

43 
	`li°_cou¡
(
„tchq
)) {

44 
u›
 = 
	`li°_ªmove_©
(
„tchq
, 0);

45 
u›
->
ö_„tch_queue
 = 0;

46 
	`x86_u›_‰ì_if_nŸ_queued
(
u›
);

48 
	`li°_‰ì
(
„tchq
);

49 
	}
}

52 
x86_u›_t
 *
	$X86ThªadRemoveFromFëchQueue
(
X86Thªad
 *
£lf
, 
ödex
)

54 
li°_t
 *
„tchq
 = 
£lf
->
„tch_queue
;

55 
x86_u›_t
 *
u›
;

56 
	`as£π
(
ödex
 >0 && index < 
	`li°_cou¡
(
„tchq
));

57 
u›
 = 
	`li°_ªmove_©
(
„tchq
, 
ödex
);

58 
u›
->
ö_„tch_queue
 = 0;

59 i‡(!
u›
->
åa˚_ˇche
 && !u›->
m›_ödex
)

61 
£lf
->
„tchq_occ
 -
u›
->
m›_size
;

62 
	`as£π
(
£lf
->
„tchq_occ
 >= 0);

64 i‡(
u›
->
åa˚_ˇche
)

66 
£lf
->
åa˚_ˇche_queue_occ
--;

67 
	`as£π
(
£lf
->
åa˚_ˇche_queue_occ
 >= 0);

69 i‡(!
	`li°_cou¡
(
„tchq
))

71 
	`as£π
(!
£lf
->
„tchq_occ
);

72 
	`as£π
(!
£lf
->
åa˚_ˇche_queue_occ
);

74  
u›
;

75 
	}
}

78 
	$X86ThªadRecovîFëchQueue
(
X86Thªad
 *
£lf
)

80 
X86C‹e
 *
c‹e
 = 
£lf
->core;

81 
X86Cpu
 *
˝u
 = 
£lf
->cpu;

83 
li°_t
 *
„tchq
 = 
£lf
->
„tch_queue
;

84 
x86_u›_t
 *
u›
;

86 
	`li°_cou¡
(
„tchq
))

88 
u›
 = 
	`li°_gë
(
„tchq
, 
	`li°_cou¡
(fetchq) - 1);

89 
	`as£π
(
u›
->
thªad
 =
£lf
);

90 i‡(!
u›
->
•ecmode
)

92 
u›
 = 
	`X86ThªadRemoveFromFëchQueue
(
£lf
, 
	`li°_cou¡
(
„tchq
) - 1);

95 i‡(
	`x86_åacög
())

97 
	`x86_åa˚
("x86.inst id=%lld core=%d stg=\"sq\"\n",

98 
u›
->
id_ö_c‹e
, 
c‹e
->
id
);

99 
	`X86CpuAddToTø˚Li°
(
˝u
, 
u›
);

103 
	`x86_u›_‰ì_if_nŸ_queued
(
u›
);

105 
	}
}

114 
	gx86_„tch_queue_size
;

	@fetch-queue.h

20 #i‚de‡
X86_ARCH_TIMING_FETCH_QUEUE_H


21 
	#X86_ARCH_TIMING_FETCH_QUEUE_H


	)

28 
X86ThªadInôFëchQueue
(
X86Thªad
 *
£lf
);

29 
X86ThªadFªeFëchQueue
(
X86Thªad
 *
£lf
);

31 
X86ThªadRecovîFëchQueue
(
X86Thªad
 *
£lf
);

32 
x86_u›_t
 *
X86ThªadRemoveFromFëchQueue
(
X86Thªad
 *
£lf
, 
ödex
);

40 
x86_„tch_queue_size
;

	@fetch.c

21 
	~<¨ch/x86/emu/c⁄ãxt.h
>

22 
	~<¨ch/x86/emu/ªgs.h
>

23 
	~<lib/esim/åa˚.h
>

24 
	~<lib/utû/debug.h
>

25 
	~<lib/utû/li°.h
>

26 
	~<lib/utû/°rög.h
>

27 
	~<mem-sy°em/mmu.h
>

28 
	~<mem-sy°em/moduÀ.h
>

30 
	~"b¥ed.h
"

31 
	~"c‹e.h
"

32 
	~"˝u.h
"

33 
	~"evít-queue.h
"

34 
	~"„tch.h
"

35 
	~"„tch-queue.h
"

36 
	~"thªad.h
"

37 
	~"åa˚-ˇche.h
"

38 
	~"u›.h
"

47 
	$X86ThªadC™Fëch
(
X86Thªad
 *
£lf
)

49 
X86Cpu
 *
˝u
 = 
£lf
->cpu;

50 
X86C⁄ãxt
 *
˘x
 = 
£lf
->ctx;

52 
phy_addr
;

53 
block
;

56 i‡(!
˘x
 || !
	`X86C⁄ãxtGëSèã
(˘x, 
X86C⁄ãxtRu¬ög
))

60 i‡(
£lf
->
„tch_°Æl_u¡û
 >
	`asTimög
(
˝u
)->
cy˛e
 || 
˘x
->
evi˘_sig«l
)

65 i‡(
£lf
->
„tchq_occ
 >
x86_„tch_queue_size
)

70 
block
 = 
£lf
->
„tch_√ù
 & ~(£lf->
ö°_mod
->
block_size
 - 1);

71 i‡(
block
 !
£lf
->
„tch_block
)

73 
phy_addr
 = 
	`mmu_å™¶©e
(
£lf
->
˘x
->
addªss_•a˚_ödex
,

74 
£lf
->
„tch_√ù
);

75 i‡(!
	`mod_ˇn_ac˚ss
(
£lf
->
ö°_mod
, 
phy_addr
))

81 
	}
}

86 
	$X86ThªadIPªdi˘‹Pro˚ss
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
)

88 
x86_ö°_¥ed_t
 *
¥ed
 = &(
£lf
->
ùªd
);

89 
cuº_∑âîn_öd
 = 
¥ed
->
cuº_∑âîn_ödex
;

90 
x86_ö°_∑âîn_t
 *
∑âîn
 = &
¥ed
->
∑âîn_hi°‹y
[
cuº_∑âîn_öd
];

92 
x86_uö°_Êag_t
 
Êags
 = 
u›
->flags;

94 i‡(
Êags
 & 
X86_UINST_INT
)

95 
∑âîn
->
uö°_öt_cou¡
 ++;

96 i‡(
Êags
 & 
X86_UINST_LOGIC
)

97 
∑âîn
->
uö°_logic_cou¡
 ++;

98 i‡(
Êags
 & 
X86_UINST_FP
)

99 
∑âîn
->
uö°_Â_cou¡
 ++;

100 i‡(
Êags
 & 
X86_UINST_MEM
)

101 
∑âîn
->
uö°_mem_cou¡
 ++;

102 i‡(
Êags
 & 
X86_UINST_CTRL
)

103 
∑âîn
->
uö°_˘æ_cou¡
 ++;

105 
∑âîn
->
uö°_tŸÆ
 ++;

108 i‡(
Êags
 & 
X86_UINST_MEM
)

110 
cuº_∑âîn_öd
 = (cuº_∑âîn_öd + 1Ë% 
MAX_PATTERN_ITER_COUNT
;

111 
¥ed
->
cuº_∑âîn_ödex
 = 
cuº_∑âîn_öd
;

112 
¥ed
->
tŸÆ_∑âîn_¥o˚s£d
++;

114 
∑âîn
 = &
¥ed
->
∑âîn_hi°‹y
[¥ed->
cuº_∑âîn_ödex
];

115 
∑âîn
->
uö°_öt_cou¡
=0;

116 
∑âîn
->
uö°_logic_cou¡
=0;

117 
∑âîn
->
uö°_Â_cou¡
=0;

118 
∑âîn
->
uö°_mem_cou¡
=0;

119 
∑âîn
->
uö°_˘æ_cou¡
=0;

120 
∑âîn
->
uö°_tŸÆ
=0;

124 i‡(
¥ed
->
tŸÆ_∑âîn_¥o˚s£d
 < 
THESHOLD_PATTERN_ITER_COUNT
)

130 
tŸÆ_ö°_cou¡
 = 0;

131 
avg_ö°_cou¡
 = 0;

132 
i
=0; i <
cuº_∑âîn_öd
; i++)

134 
tŸÆ_ö°_cou¡
 +
£lf
->
ùªd
.
∑âîn_hi°‹y
[
i
].
uö°_tŸÆ
;

136 i‡(
cuº_∑âîn_öd
)

137 
avg_ö°_cou¡
 = 
tŸÆ_ö°_cou¡
/
cuº_∑âîn_öd
;

139 
di°™˚
 = 
avg_ö°_cou¡
 - 
∑âîn
->
uö°_tŸÆ
;

142 i‡(
	`x86_åacög
())

144 
	`x86_åa˚
("Pallavi - X86ThreadIPredictorProcess: %d,%d,%d,%d,%f,%lld,%lld\n",

145 
£lf
->
ùªd
.
√xt_¥ed_mem_ö°_di°™˚
,

146 
£lf
->
ùªd
.
cuº_∑âîn_ödex
,

147 
cuº_∑âîn_öd
,

148 
tŸÆ_ö°_cou¡
,

149 
avg_ö°_cou¡
,

150 
∑âîn
->
uö°_tŸÆ
,

151 
£lf
->
ùªd
.
tŸÆ_∑âîn_¥o˚s£d


155 
	}
}

160 
x86_u›_t
 *
	$X86ThªadFëchIn°
(
X86Thªad
 *
£lf
, 
„tch_åa˚_ˇche
)

162 
X86Cpu
 *
˝u
 = 
£lf
->cpu;

163 
X86C‹e
 *
c‹e
 = 
£lf
->core;

164 
X86C⁄ãxt
 *
˘x
 = 
£lf
->ctx;

166 
x86_u›_t
 *
u›
;

167 
x86_u›_t
 *
ªt_u›
;

169 
x86_uö°_t
 *
uö°
;

170 
uö°_cou¡
;

171 
uö°_ödex
;

174 
£lf
->
„tch_eù
 = sñf->
„tch_√ù
;

175 
	`X86C⁄ãxtSëEù
(
˘x
, 
£lf
->
„tch_eù
);

176 
	`X86C⁄ãxtExecuã
(
˘x
);

177 
£lf
->
„tch_√ù
 = sñf->
„tch_eù
 + 
˘x
->
ö°
.
size
;

184 i‡(!
x86_uö°_li°
->
cou¡
)

185 
	`x86_uö°_√w
(
˘x
, 
x86_uö°_n›
, 0, 0, 0, 0, 0, 0, 0);

189 
uö°_cou¡
 = 
	`li°_cou¡
(
x86_uö°_li°
);

190 
uö°_ödex
 = 0;

191 
ªt_u›
 = 
NULL
;

192 
	`li°_cou¡
(
x86_uö°_li°
))

195 
uö°
 = 
	`li°_ªmove_©
(
x86_uö°_li°
, 0);

198 
u›
 = 
	`x86_u›_¸óã
();

199 
u›
->
uö°
 = uinst;

200 
	`as£π
(
uö°
->
›code
 >0 && uö°->›codê< 
x86_uö°_›code_cou¡
);

201 
u›
->
Êags
 = 
x86_uö°_öfo
[
uö°
->
›code
].flags;

202 
u›
->
id
 = 
˝u
->
u›_id_cou¡î
++;

203 
u›
->
id_ö_c‹e
 = 
c‹e
->
u›_id_cou¡î
++;

205 
u›
->
˘x
 = ctx;

206 
u›
->
thªad
 = 
£lf
;

208 
u›
->
m›_cou¡
 = 
uö°_cou¡
;

209 
u›
->
m›_size
 = 
˘x
->
ö°
.
size
;

210 
u›
->
m›_id
 = u›->
id
 - 
uö°_ödex
;

211 
u›
->
m›_ödex
 = 
uö°_ödex
;

213 
u›
->
eù
 = 
£lf
->
„tch_eù
;

214 
u›
->
ö_„tch_queue
 = 1;

215 
u›
->
åa˚_ˇche
 = 
„tch_åa˚_ˇche
;

216 
u›
->
•ecmode
 = 
	`X86C⁄ãxtGëSèã
(
˘x
, 
X86C⁄ãxtS≥cMode
);

217 
u›
->
„tch_addªss
 = 
£lf
->fetch_address;

218 
u›
->
„tch_ac˚ss
 = 
£lf
->fetch_access;

219 
u›
->
√ù
 = 
˘x
->
ªgs
->
eù
;

220 
u›
->
¥ed_√ù
 = 
£lf
->
„tch_√ù
;

221 
u›
->
èrgë_√ù
 = 
˘x
->
èrgë_eù
;

225 
	`x86_u›_cou¡_dïs
(
u›
);

228 i‡(
u›
->
Êags
 & 
X86_UINST_MEM
)

229 
u›
->
phy_addr
 = 
	`mmu_å™¶©e
(
£lf
->
˘x
->
addªss_•a˚_ödex
,

230 
uö°
->
addªss
);

233 i‡(
	`x86_åacög
())

235 
°r
[
MAX_STRING_SIZE
];

236 
ö°_«me
[
MAX_STRING_SIZE
];

237 
uö°_«me
[
MAX_STRING_SIZE
];

239 *
°r_±r
;

241 
°r_size
;

243 
°r_±r
 = 
°r
;

244 
°r_size
 =  
°r
;

247 
	`°r_¥ötf
(&
°r_±r
, &
°r_size
, "x86.new_inst id=%lld core=%d",

248 
u›
->
id_ö_c‹e
, 
c‹e
->
id
);

251 i‡(
u›
->
•ecmode
)

252 
	`°r_¥ötf
(&
°r_±r
, &
°r_size
, " spec=\"t\"");

255 i‡(!
uö°_ödex
)

257 
	`x86_ö°_dump_buf
(&
˘x
->
ö°
, 
ö°_«me
,  inst_name);

258 
	`°r_¥ötf
(&
°r_±r
, &
°r_size
, "ásm=\"%s\"", 
ö°_«me
);

262 
	`x86_uö°_dump_buf
(
uö°
, 
uö°_«me
,  uinst_name);

263 
	`°r_¥ötf
(&
°r_±r
, &
°r_size
, " uasm=\"%s\" stg=\"„\"", 
uö°_«me
);

266 
	`x86_åa˚
("%s\n", 
°r
);

270 i‡(!
ªt_u›
 || (
u›
->
Êags
 & 
X86_UINST_CTRL
))

271 
ªt_u›
 = 
u›
;

274 
	`li°_add
(
£lf
->
„tch_queue
, 
u›
);

277 
	`X86ThªadIPªdi˘‹Pro˚ss
(
£lf
, 
u›
);

279 i‡(
„tch_åa˚_ˇche
)

280 
£lf
->
åa˚_ˇche_queue_occ
++;

283 
˝u
->
num_„tched_uö°
++;

284 
£lf
->
num_„tched_uö°
++;

285 i‡(
„tch_åa˚_ˇche
)

286 
£lf
->
åa˚_ˇche
->
num_„tched_uö°
++;

289 
uö°_ödex
++;

294 i‡(
ªt_u›
 && !
„tch_åa˚_ˇche
)

295 
£lf
->
„tchq_occ
 +
ªt_u›
->
m›_size
;

296  
ªt_u›
;

297 
	}
}

302 
	$X86ThªadFëchTø˚Cache
(
X86Thªad
 *
£lf
)

304 
x86_u›_t
 *
u›
;

306 
m¥ed
;

307 
hô
;

308 
m›_cou¡
;

309 
i
;

311 
eù_bønch
;

312 *
m›_¨øy
;

313 
√ù
;

316 
	`as£π
(
x86_åa˚_ˇche_¥e£¡
);

317 i‡(
£lf
->
åa˚_ˇche_queue_occ
 >
x86_åa˚_ˇche_queue_size
)

321 
eù_bønch
 = 
	`X86ThªadGëNextBønch
(
£lf
,

322 
£lf
->
„tch_√ù
, sñf->
ö°_mod
->
block_size
);

323 
m¥ed
 = 
eù_bønch
 ? 
	`X86ThªadLookupBønchPªdMu…ùÀ
(
£lf
,

324 
eù_bønch
, 
x86_åa˚_ˇche_bønch_max
) : 0;

325 
hô
 = 
	`X86ThªadLookupTø˚Cache
(
£lf
, sñf->
„tch_√ù
, 
m¥ed
,

326 &
m›_cou¡
, &
m›_¨øy
, &
√ù
);

327 i‡(!
hô
)

331 
i
 = 0; i < 
m›_cou¡
; i++)

334 i‡(!
	`X86C⁄ãxtGëSèã
(
£lf
->
˘x
, 
X86C⁄ãxtRu¬ög
))

340 
£lf
->
„tch_√ù
 = 
m›_¨øy
[
i
];

341 
u›
 = 
	`X86ThªadFëchIn°
(
£lf
, 1);

342 i‡(!
u›
)

347 i‡(
u›
->
Êags
 & 
X86_UINST_CTRL
)

349 
	`X86ThªadLookupBønchPªd
(
£lf
, 
u›
);

350 
u›
->
¥ed_√ù
 = 
i
 =
m›_cou¡
 - 1 ? 
√ù
 :

351 
m›_¨øy
[
i
 + 1];

356 
£lf
->
„tch_√ù
 = 
√ù
;

358 
	}
}

361 
	$X86ThªadFëch
(
X86Thªad
 *
£lf
)

363 
X86C⁄ãxt
 *
˘x
 = 
£lf
->ctx;

364 
x86_u›_t
 *
u›
;

366 
phy_addr
;

367 
block
;

368 
èrgë
;

370 
èkí
;

373 i‡(
x86_åa˚_ˇche_¥e£¡
 && 
	`X86ThªadFëchTø˚Cache
(
£lf
))

378 
block
 = 
£lf
->
„tch_√ù
 & ~(£lf->
ö°_mod
->
block_size
 - 1);

379 i‡(
block
 !
£lf
->
„tch_block
)

381 
phy_addr
 = 
	`mmu_å™¶©e
(
£lf
->
˘x
->
addªss_•a˚_ödex
, sñf->
„tch_√ù
);

382 
£lf
->
„tch_block
 = 
block
;

383 
£lf
->
„tch_addªss
 = 
phy_addr
;

384 
£lf
->
„tch_ac˚ss
 = 
	`mod_ac˚ss
(£lf->
ö°_mod
,

385 
mod_ac˚ss_lﬂd
, 
phy_addr
, 
NULL
, NULL, NULL, NULL);

386 
£lf
->
btb_ªads
++;

389 i‡(*
mmu_ªp‹t_fûe_«me
)

390 
	`mmu_ac˚ss_∑ge
(
phy_addr
, 
mmu_ac˚ss_execuã
);

394 (
£lf
->
„tch_√ù
 & ~(£lf->
ö°_mod
->
block_size
 - 1)Ë=
block
)

397 i‡(!
	`X86C⁄ãxtGëSèã
(
˘x
, 
X86C⁄ãxtRu¬ög
))

401 i‡(
£lf
->
„tchq_occ
 >
x86_„tch_queue_size
)

408 
u›
 = 
	`X86ThªadFëchIn°
(
£lf
, 0);

409 i‡(!
˘x
->
ö°
.
size
)

411 i‡(!
u›
)

417 i‡(
u›
->
Êags
 & 
X86_UINST_CTRL
)

419 
èrgë
 = 
	`X86ThªadLookupBTB
(
£lf
, 
u›
);

420 
èkí
 = 
èrgë
 && 
	`X86ThªadLookupBønchPªd
(
£lf
, 
u›
);

421 i‡(
èkí
)

423 
£lf
->
„tch_√ù
 = 
èrgë
;

424 
u›
->
¥ed_√ù
 = 
èrgë
;

429 
	}
}

438 
	$X86C‹eFëch
(
X86C‹e
 *
£lf
)

440 
X86Cpu
 *
˝u
 = 
£lf
->cpu;

441 
X86Thªad
 *
thªad
;

443 
i
;

445 
x86_˝u_„tch_köd
)

448 
x86_˝u_„tch_köd_sh¨ed
:

451 
i
 = 0; i < 
x86_˝u_num_thªads
; i++)

452 i‡(
	`X86ThªadC™Fëch
(
£lf
->
thªads
[
i
]))

453 
	`X86ThªadFëch
(
£lf
->
thªads
[
i
]);

457 
x86_˝u_„tch_köd_time¶i˚
:

460 
i
 = 0; i < 
x86_˝u_num_thªads
; i++)

462 
£lf
->
„tch_cuºít
 = (£lf->„tch_cuºíà+ 1Ë% 
x86_˝u_num_thªads
;

463 
thªad
 = 
£lf
->
thªads
[£lf->
„tch_cuºít
];

464 i‡(
	`X86ThªadC™Fëch
(
thªad
))

466 
	`X86ThªadFëch
(
thªad
);

473 
x86_˝u_„tch_köd_swôch⁄evít
:

475 
mu°_swôch
;

476 
mu°_swôch_Œ
;

477 
√w_ödex
;

479 
X86Thªad
 *
√w_thªad
;

483 
thªad
 = 
£lf
->
thªads
[£lf->
„tch_cuºít
];

484 i‡(
thªad
->
„tch_°Æl_u¡û
 >
	`asTimög
(
˝u
)->
cy˛e
)

490 
mu°_swôch
 = !
	`X86ThªadC™Fëch
(
thªad
);

491 
mu°_swôch
 = mu°_swôch || 
	`asTimög
(
˝u
)->
cy˛e
 - 
£lf
->
„tch_swôch_whí
 >

492 
x86_˝u_thªad_qu™tum
 + 
x86_˝u_thªad_swôch_≥«…y
;

497 
mu°_swôch_Œ
 = 
	`X86ThªadL⁄gL©ícyInEvítQueue
(
thªad
);

498 i‡(
mu°_swôch_Œ
)

502 
mu°_swôch
 = mu°_swôch || 
mu°_swôch_Œ
;

505 i‡(
mu°_swôch
)

508 
√w_ödex
 = (
thªad
->
id_ö_c‹e
 + 1Ë% 
x86_˝u_num_thªads
;

509 
√w_ödex
 !
thªad
->
id_ö_c‹e
;

510 
√w_ödex
 = (√w_ödex + 1Ë% 
x86_˝u_num_thªads
)

513 
√w_thªad
 = 
£lf
->
thªads
[
√w_ödex
];

514 i‡(!
	`X86ThªadC™Fëch
(
√w_thªad
))

518 i‡(
mu°_swôch
)

522 i‡(
√w_thªad
->
num_commôãd_uö°_¨øy
 >

523 
thªad
->
num_commôãd_uö°_¨øy
 + 100000)

527 i‡(!
	`X86ThªadL⁄gL©ícyInEvítQueue
(
√w_thªad
))

532 i‡(
√w_ödex
 !
thªad
->
id_ö_c‹e
)

534 i‡(
	`x86_åacög
())

536 
	`x86_åa˚
("Pallavi -Åhread is switched: \n");

538 
£lf
->
„tch_cuºít
 = 
√w_ödex
;

539 
£lf
->
„tch_swôch_whí
 = 
	`asTimög
(
˝u
)->
cy˛e
;

540 
√w_thªad
->
„tch_°Æl_u¡û
 = 
	`asTimög
(
˝u
)->
cy˛e
 +

541 
x86_˝u_thªad_swôch_≥«…y
 - 1;

546 
thªad
 = 
£lf
->
thªads
[£lf->
„tch_cuºít
];

547 i‡(
	`X86ThªadC™Fëch
(
thªad
))

548 
	`X86ThªadFëch
(
thªad
);

554 
	`∑nic
("%s: wr⁄g fëchÖﬁicy", 
__FUNCTION__
);

556 
	}
}

565 
	$X86CpuFëch
(
X86Cpu
 *
£lf
)

567 
i
;

569 
£lf
->
°age
 = "fetch";

570 
i
 = 0; i < 
x86_˝u_num_c‹es
; i++)

571 
	`X86C‹eFëch
(
£lf
->
c‹es
[
i
]);

572 
	}
}

	@fetch.h

20 #i‚de‡
ARCH_X86_TIMING_FETCH_H


21 
	#ARCH_X86_TIMING_FETCH_H


	)

23 
	~<lib/utû/˛ass.h
>

30 
X86CpuFëch
(
X86Cpu
 *
£lf
);

	@fu.c

21 
	~<lib/mh™dÀ/mh™dÀ.h
>

22 
	~<lib/utû/c⁄fig.h
>

23 
	~<lib/utû/°rög.h
>

25 
	~"c‹e.h
"

26 
	~"˝u.h
"

27 
	~"fu.h
"

37 
	$X86C‹eInôFun˘i⁄ÆUnôs
(
X86C‹e
 *
£lf
)

39 
£lf
->
fu
 = 
	`xˇŒoc
(1, (
x86_fu_t
));

40 
	}
}

43 
	$X86C‹eFªeFun˘i⁄ÆUnôs
(
X86C‹e
 *
£lf
)

45 
	`‰ì
(
£lf
->
fu
);

46 
	}
}

49 
	$X86C‹eDumpFun˘i⁄ÆUnôsRï‹t
(
X86C‹e
 *
£lf
, 
FILE
 *
f
)

51 
x86_fu_t
 *
fu
 = 
£lf
->fu;

52 
i
;

54 
	`Ârötf
(
f
, "; Functional unitÖool\n");

55 
	`Ârötf
(
f
, "; Accesses - Number of uops issuedÅoá f.u.\n");

56 
	`Ârötf
(
f
, "; Denied - Number ofÑequests denied dueÅo busy f.u.\n");

57 
	`Ârötf
(
f
, "; WaitingTime - AverageÇumber of waiting cyclesÅoÑeserve f.u.\n");

59 
i
 = 1; i < 
x86_fu_cou¡
; i++)

61 
	`Ârötf
(
f
, "fu.%s.Ac˚s£†%Œd\n", 
x86_fu_«me
[
i
], 
fu
->
ac˚s£s
[i]);

62 
	`Ârötf
(
f
, "fu.%s.Díõd = %Œd\n", 
x86_fu_«me
[
i
], 
fu
->
ac˚s£s
[i]);

63 
	`Ârötf
(
f
, "fu.%s.WaôögTimê%.4g\n", 
x86_fu_«me
[
i
], 
fu
->
ac˚s£s
[i] ?

64 (Ë
fu
->
waôög_time
[
i
] / fu->
ac˚s£s
[i] : 0.0);

68 
	`Ârötf
(
f
, "\n");

69 
	}
}

75 
	$X86C‹eRe£rveFun˘i⁄ÆUnô
(
X86C‹e
 *
£lf
, 
x86_u›_t
 *
u›
)

77 
X86Cpu
 *
˝u
 = 
£lf
->cpu;

79 
x86_fu_˛ass_t
 
fu_˛ass
;

80 
x86_fu_t
 *
fu
 = 
£lf
->fu;

82 
i
;

87 
fu_˛ass
 = 
x86_fu_˛ass_èbÀ
[
u›
->
uö°
->
›code
];

88 i‡(!
fu_˛ass
)

92 i‡(!
u›
->
issue_åy_whí
)

93 
u›
->
issue_åy_whí
 = 
	`asTimög
(
˝u
)->
cy˛e
;

96 
	`as£π
(
fu_˛ass
 > 
x86_fu_n⁄e
 && fu_˛as†< 
x86_fu_cou¡
);

97 
	`as£π
(
x86_fu_ªs_poﬁ
[
fu_˛ass
].
cou¡
 <
X86_FU_RES_MAX
);

98 
i
 = 0; i < 
x86_fu_ªs_poﬁ
[
fu_˛ass
].
cou¡
; i++)

100 i‡(
fu
->
cy˛e_whí_‰ì
[
fu_˛ass
][
i
] <
	`asTimög
(
˝u
)->
cy˛e
)

102 
	`as£π
(
x86_fu_ªs_poﬁ
[
fu_˛ass
].
issuñ©
 > 0);

103 
	`as£π
(
x86_fu_ªs_poﬁ
[
fu_˛ass
].
›œt
 > 0);

104 
fu
->
cy˛e_whí_‰ì
[
fu_˛ass
][
i
] = 
	`asTimög
(
˝u
)->
cy˛e


105 + 
x86_fu_ªs_poﬁ
[
fu_˛ass
].
issuñ©
;

106 
fu
->
ac˚s£s
[
fu_˛ass
]++;

107 
fu
->
waôög_time
[
fu_˛ass
] +
	`asTimög
(
˝u
)->
cy˛e
 - 
u›
->
issue_åy_whí
;

108  
x86_fu_ªs_poﬁ
[
fu_˛ass
].
›œt
;

113 
fu
->
díõd
[
fu_˛ass
]++;

115 
	}
}

119 
	$X86C‹eRñó£AŒFun˘i⁄ÆUnôs
(
X86C‹e
 *
£lf
)

121 
i
;

122 
j
;

124 
i
 = 0; i < 
x86_fu_cou¡
; i++)

125 
j
 = 0; j < 
x86_fu_ªs_poﬁ
[
i
].
cou¡
; j++)

126 
£lf
->
fu
->
cy˛e_whí_‰ì
[
i
][
j
] = 0;

127 
	}
}

141 
x86_fu_ªs_t
 
	gx86_fu_ªs_poﬁ
[
x86_fu_cou¡
] =

173 *
	gx86_fu_«me
[
x86_fu_cou¡
] =

208 
x86_fu_˛ass_t
 
	gx86_fu_˛ass_èbÀ
[
x86_uö°_›code_cou¡
] =

210 
x86_fu_n⁄e
,

212 
x86_fu_n⁄e
,

213 
x86_fu_öt_add
,

214 
x86_fu_öt_add
,

215 
x86_fu_öt_mu…
,

216 
x86_fu_öt_div
,

217 
x86_fu_efÁddr
,

219 
x86_fu_logic
,

220 
x86_fu_logic
,

221 
x86_fu_logic
,

222 
x86_fu_logic
,

223 
x86_fu_logic
,

224 
x86_fu_logic
,

226 
x86_fu_n⁄e
,

227 
x86_fu_Êﬂt_sim∂e
,

228 
x86_fu_Êﬂt_sim∂e
,

230 
x86_fu_Êﬂt_add
,

231 
x86_fu_Êﬂt_add
,

232 
x86_fu_Êﬂt_comp
,

233 
x86_fu_Êﬂt_mu…
,

234 
x86_fu_Êﬂt_div
,

236 
x86_fu_Êﬂt_com∂ex
,

237 
x86_fu_Êﬂt_com∂ex
,

238 
x86_fu_Êﬂt_com∂ex
,

239 
x86_fu_Êﬂt_com∂ex
,

240 
x86_fu_Êﬂt_com∂ex
,

241 
x86_fu_Êﬂt_com∂ex
,

242 
x86_fu_Êﬂt_com∂ex
,

243 
x86_fu_Êﬂt_com∂ex
,

245 
x86_fu_n⁄e
,

246 
x86_fu_n⁄e
,

248 
x86_fu_xmm_logic
,

249 
x86_fu_xmm_logic
,

250 
x86_fu_xmm_logic
,

251 
x86_fu_xmm_logic
,

252 
x86_fu_xmm_logic
,

253 
x86_fu_xmm_logic
,

254 
x86_fu_xmm_logic
,

256 
x86_fu_xmm_öt_add
,

257 
x86_fu_xmm_öt_add
,

258 
x86_fu_xmm_öt_add
,

259 
x86_fu_xmm_öt_mu…
,

260 
x86_fu_xmm_öt_div
,

262 
x86_fu_xmm_Êﬂt_add
,

263 
x86_fu_xmm_Êﬂt_add
,

264 
x86_fu_xmm_Êﬂt_comp
,

265 
x86_fu_xmm_Êﬂt_mu…
,

266 
x86_fu_xmm_Êﬂt_div
,

268 
x86_fu_xmm_Êﬂt_com∂ex
,

270 
x86_fu_xmm_logic
,

271 
x86_fu_xmm_logic
,

272 
x86_fu_xmm_Êﬂt_c⁄v
,

274 
x86_fu_n⁄e
,

275 
x86_fu_n⁄e
,

276 
x86_fu_n⁄e
,

278 
x86_fu_n⁄e
,

279 
x86_fu_n⁄e
,

280 
x86_fu_n⁄e
,

281 
x86_fu_n⁄e
,

282 
x86_fu_n⁄e
,

284 
x86_fu_n⁄e


288 
	$X86RódFun˘i⁄ÆUnôsC⁄fig
(
c⁄fig_t
 *
c⁄fig
)

290 
x86_fu_ªs_t
 *
fu_ªs
;

292 
buf
[
MAX_STRING_SIZE
];

293 *
£˘i⁄
;

295 
i
;

297 
£˘i⁄
 = "FunctionalUnits";

298 
i
 = 1; i < 
x86_fu_cou¡
; i++)

300 
fu_ªs
 = &
x86_fu_ªs_poﬁ
[
i
];

302 
	`¢¥ötf
(
buf
,  buf, "%s.Cou¡", 
x86_fu_«me
[
i
]);

303 
fu_ªs
->
cou¡
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, 
buf
, fu_res->count);

305 
	`¢¥ötf
(
buf
,  buf, "%s.OpL©", 
x86_fu_«me
[
i
]);

306 
fu_ªs
->
›œt
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, 
buf
, fu_res->oplat);

308 
	`¢¥ötf
(
buf
,  buf, "%s.IssueL©", 
x86_fu_«me
[
i
]);

309 
fu_ªs
->
issuñ©
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, 
buf
, fu_res->issuelat);

311 
	}
}

314 
	$X86DumpFun˘i⁄ÆUnôsC⁄fig
(
FILE
 *
f
)

316 
x86_fu_ªs_t
 *
fu_ªs
;

317 
i
;

319 
	`Ârötf
(
f
, "[ Config.FunctionalUnits ]\n");

320 
i
 = 1; i < 
x86_fu_cou¡
; i++)

322 
fu_ªs
 = &
x86_fu_ªs_poﬁ
[
i
];

323 
	`Ârötf
(
f
, "%s.Cou¡ = %d\n", 
x86_fu_«me
[
i
], 
fu_ªs
->
cou¡
);

324 
	`Ârötf
(
f
, "%s.OpL© = %d\n", 
x86_fu_«me
[
i
], 
fu_ªs
->
›œt
);

325 
	`Ârötf
(
f
, "%s.IssueL© = %d\n", 
x86_fu_«me
[
i
], 
fu_ªs
->
issuñ©
);

328 
	`Ârötf
(
f
, "\n");

329 
	}
}

	@fu.h

20 #i‚de‡
X86_ARCH_TIMING_FU_H


21 
	#X86_ARCH_TIMING_FU_H


	)

23 
	~<lib/utû/˛ass.h
>

25 
	~"u›.h
"

29 
	gc⁄fig_t
;

36 
X86C‹eInôFun˘i⁄ÆUnôs
(
X86C‹e
 *
£lf
);

37 
X86C‹eFªeFun˘i⁄ÆUnôs
(
X86C‹e
 *
£lf
);

39 
X86C‹eDumpFun˘i⁄ÆUnôsRï‹t
(
X86C‹e
 *
£lf
, 
FILE
 *
f
);

41 
X86C‹eRe£rveFun˘i⁄ÆUnô
(
X86C‹e
 *
£lf
, 
x86_u›_t
 *
u›
);

42 
X86C‹eRñó£AŒFun˘i⁄ÆUnôs
(
X86C‹e
 *
£lf
);

51 
	#X86_FU_RES_MAX
 10

	)

57 
	ex86_fu_˛ass_t


59 
	mx86_fu_n⁄e
 = 0,

61 
	mx86_fu_öt_add
,

62 
	mx86_fu_öt_mu…
,

63 
	mx86_fu_öt_div
,

65 
	mx86_fu_efÁddr
,

66 
	mx86_fu_logic
,

68 
	mx86_fu_Êﬂt_sim∂e
,

69 
	mx86_fu_Êﬂt_add
,

70 
	mx86_fu_Êﬂt_comp
,

71 
	mx86_fu_Êﬂt_mu…
,

72 
	mx86_fu_Êﬂt_div
,

73 
	mx86_fu_Êﬂt_com∂ex
,

75 
	mx86_fu_xmm_öt_add
,

76 
	mx86_fu_xmm_öt_mu…
,

77 
	mx86_fu_xmm_öt_div
,

79 
	mx86_fu_xmm_logic
,

81 
	mx86_fu_xmm_Êﬂt_add
,

82 
	mx86_fu_xmm_Êﬂt_comp
,

83 
	mx86_fu_xmm_Êﬂt_mu…
,

84 
	mx86_fu_xmm_Êﬂt_div
,

85 
	mx86_fu_xmm_Êﬂt_c⁄v
,

86 
	mx86_fu_xmm_Êﬂt_com∂ex
,

88 
	mx86_fu_cou¡


91 
	sx86_fu_t


93 
	mcy˛e_whí_‰ì
[
x86_fu_cou¡
][
X86_FU_RES_MAX
];

94 
	mac˚s£s
[
x86_fu_cou¡
];

95 
	mdíõd
[
x86_fu_cou¡
];

96 
	mwaôög_time
[
x86_fu_cou¡
];

99 
	sx86_fu_ªs_t


101 
	mcou¡
;

102 
	m›œt
;

103 
	missuñ©
;

106 *
x86_fu_«me
[
x86_fu_cou¡
];

107 
x86_fu_ªs_t
 
x86_fu_ªs_poﬁ
[
x86_fu_cou¡
];

108 
x86_fu_˛ass_t
 
x86_fu_˛ass_èbÀ
[
x86_uö°_›code_cou¡
];

110 
X86RódFun˘i⁄ÆUnôsC⁄fig
(
c⁄fig_t
 *
c⁄fig
);

111 
X86DumpFun˘i⁄ÆUnôsC⁄fig
(
FILE
 *
f
);

	@inst-queue.c

21 
	~<lib/utû/löked-li°.h
>

23 
	~"c‹e.h
"

24 
	~"˝u.h
"

25 
	~"ö°-queue.h
"

26 
	~"thªad.h
"

29 *
	gx86_iq_köd_m≠
[] = { "Shared", "Private" };

30 
x86_iq_köd_t
 
	gx86_iq_köd
;

31 
	gx86_iq_size
;

34 
	$X86ThªadInôIQ
(
X86Thªad
 *
£lf
)

36 
£lf
->
iq
 = 
	`löked_li°_¸óã
();

37 
	}
}

40 
	$X86ThªadFªeIQ
(
X86Thªad
 *
£lf
)

42 
löked_li°_t
 *
iq
;

43 
x86_u›_t
 *
u›
;

45 
iq
 = 
£lf
->iq;

46 
	`löked_li°_hód
(
iq
);

47 
	`löked_li°_cou¡
(
iq
))

49 
u›
 = 
	`löked_li°_gë
(
iq
);

50 
u›
->
ö_iq
 = 0;

51 
	`löked_li°_ªmove
(
iq
);

52 
	`x86_u›_‰ì_if_nŸ_queued
(
u›
);

54 
	`löked_li°_‰ì
(
iq
);

55 
	}
}

58 
	$X86ThªadC™In£πInIQ
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
)

60 
X86C‹e
 *
c‹e
 = 
£lf
->core;

62 
cou¡
;

63 
size
;

65 
size
 = 
x86_iq_köd
 =
x86_iq_köd_¥iv©e
 ? 
x86_iq_size
 : x86_iq_sizê* 
x86_˝u_num_thªads
;

66 
cou¡
 = 
x86_iq_köd
 =
x86_iq_köd_¥iv©e
 ? 
£lf
->
iq_cou¡
 : 
c‹e
->iq_count;

67  
cou¡
 < 
size
;

68 
	}
}

73 
	$X86ThªadIn£πInIQ
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
)

75 
X86C‹e
 *
c‹e
 = 
£lf
->core;

76 
löked_li°_t
 *
iq
 = 
£lf
->iq;

78 
	`as£π
(!
u›
->
ö_iq
);

79 
	`löked_li°_out
(
iq
);

80 
	`löked_li°_ö£π
(
iq
, 
u›
);

81 
u›
->
ö_iq
 = 1;

83 
c‹e
->
iq_cou¡
++;

84 
£lf
->
iq_cou¡
++;

85 
	}
}

90 
	$X86ThªadRemoveFromIQ
(
X86Thªad
 *
£lf
)

92 
X86C‹e
 *
c‹e
 = 
£lf
->core;

93 
löked_li°_t
 *
iq
 = 
£lf
->iq;

94 
x86_u›_t
 *
u›
;

96 
u›
 = 
	`löked_li°_gë
(
iq
);

97 
	`as£π
(
	`x86_u›_exi°s
(
u›
));

98 
	`löked_li°_ªmove
(
iq
);

99 
u›
->
ö_iq
 = 0;

101 
	`as£π
(
c‹e
->
iq_cou¡
 && 
£lf
->iq_count);

102 
c‹e
->
iq_cou¡
--;

103 
£lf
->
iq_cou¡
--;

104 
	}
}

108 
	$X86ThªadRecovîIQ
(
X86Thªad
 *
£lf
)

110 
löked_li°_t
 *
iq
 = 
£lf
->iq;

111 
x86_u›_t
 *
u›
;

113 
	`löked_li°_hód
(
iq
);

114 !
	`löked_li°_is_íd
(
iq
))

116 
u›
 = 
	`löked_li°_gë
(
iq
);

117 i‡(
u›
->
•ecmode
) {

118 
	`X86ThªadRemoveFromIQ
(
£lf
);

119 
	`x86_u›_‰ì_if_nŸ_queued
(
u›
);

122 
	`löked_li°_√xt
(
iq
);

124 
	}
}

	@inst-queue.h

20 #i‚de‡
X86_ARCH_TIMING_INST_QUEUE_H


21 
	#X86_ARCH_TIMING_INST_QUEUE_H


	)

23 
	~"u›.h
"

30 *
x86_iq_köd_m≠
[];

31 
	ex86_iq_köd_t


33 
x86_iq_köd_sh¨ed
 = 0,

34 
x86_iq_köd_¥iv©e


35 } 
x86_iq_köd
;

36 
x86_iq_size
;

43 
X86ThªadInôIQ
(
X86Thªad
 *
£lf
);

44 
X86ThªadFªeIQ
(
X86Thªad
 *
£lf
);

46 
X86ThªadC™In£πInIQ
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
);

47 
X86ThªadIn£πInIQ
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
);

48 
X86ThªadRemoveFromIQ
(
X86Thªad
 *
£lf
);

49 
X86ThªadRecovîIQ
(
X86Thªad
 *
£lf
);

	@issue.c

21 
	~<lib/esim/åa˚.h
>

22 
	~<lib/utû/debug.h
>

23 
	~<lib/utû/löked-li°.h
>

24 
	~<mem-sy°em/mmu.h
>

25 
	~<mem-sy°em/moduÀ.h
>

27 
	~"c‹e.h
"

28 
	~"˝u.h
"

29 
	~"evít-queue.h
"

30 
	~"fu.h
"

31 
	~"ö°-queue.h
"

32 
	~"issue.h
"

33 
	~"lﬂd-°‹e-queue.h
"

34 
	~"ªg-fûe.h
"

35 
	~"thªad.h
"

36 
	~"åa˚-ˇche.h
"

43 
	$X86ThªadIssueSQ
(
X86Thªad
 *
£lf
, 
qu™tum
)

45 
X86Cpu
 *
˝u
 = 
£lf
->cpu;

46 
X86C‹e
 *
c‹e
 = 
£lf
->core;

48 
x86_u›_t
 *
°‹e
;

49 
löked_li°_t
 *
sq
 = 
£lf
->sq;

50 
mod_˛õ¡_öfo_t
 *
˛õ¡_öfo
;

53 
	`löked_li°_hód
(
sq
);

54 !
	`löked_li°_is_íd
(
sq
Ë&& 
qu™tum
)

57 
°‹e
 = 
	`löked_li°_gë
(
sq
);

58 
	`as£π
(
°‹e
->
uö°
->
›code
 =
x86_uö°_°‹e
);

61 i‡(
°‹e
->
ö_rob
)

65 i‡(!
	`mod_ˇn_ac˚ss
(
£lf
->
d©a_mod
, 
°‹e
->
phy_addr
))

69 
	`X86ThªadRemoveFromSQ
(
£lf
);

72 
˛õ¡_öfo
 = 
	`mod_˛õ¡_öfo_¸óã
(
£lf
->
d©a_mod
);

73 
˛õ¡_öfo
->
¥e„tchî_eù
 = 
°‹e
->
eù
;

76 
	`mod_ac˚ss
(
£lf
->
d©a_mod
, 
mod_ac˚ss_°‹e
,

77 
°‹e
->
phy_addr
, 
NULL
, 
c‹e
->
evít_queue
, st‹e, 
˛õ¡_öfo
);

82 
°‹e
->
ö_evít_queue
 = 1;

83 
°‹e
->
issued
 = 1;

84 
°‹e
->
issue_whí
 = 
	`asTimög
(
˝u
)->
cy˛e
;

87 
c‹e
->
num_issued_uö°_¨øy
[
°‹e
->
uö°
->
›code
]++;

88 
c‹e
->
lsq_ªads
++;

89 
c‹e
->
ªg_fûe_öt_ªads
 +
°‹e
->
ph_öt_idï_cou¡
;

90 
c‹e
->
ªg_fûe_Â_ªads
 +
°‹e
->
ph_Â_idï_cou¡
;

91 
£lf
->
num_issued_uö°_¨øy
[
°‹e
->
uö°
->
›code
]++;

92 
£lf
->
lsq_ªads
++;

93 
£lf
->
ªg_fûe_öt_ªads
 +
°‹e
->
ph_öt_idï_cou¡
;

94 
£lf
->
ªg_fûe_Â_ªads
 +
°‹e
->
ph_Â_idï_cou¡
;

95 
˝u
->
num_issued_uö°_¨øy
[
°‹e
->
uö°
->
›code
]++;

96 i‡(
°‹e
->
åa˚_ˇche
)

97 
£lf
->
åa˚_ˇche
->
num_issued_uö°
++;

100 
qu™tum
--;

103 i‡(*
mmu_ªp‹t_fûe_«me
)

104 
	`mmu_ac˚ss_∑ge
(
°‹e
->
phy_addr
, 
mmu_ac˚ss_wrôe
);

106  
qu™tum
;

107 
	}
}

110 
	$X86ThªadIssueLQ
(
X86Thªad
 *
£lf
, 
qu™t
)

112 
X86C‹e
 *
c‹e
 = 
£lf
->core;

113 
X86Cpu
 *
˝u
 = 
£lf
->cpu;

115 
löked_li°_t
 *
lq
 = 
£lf
->lq;

116 
x86_u›_t
 *
lﬂd
;

117 
mod_˛õ¡_öfo_t
 *
˛õ¡_öfo
;

120 
	`löked_li°_hód
(
lq
);

121 !
	`löked_li°_is_íd
(
lq
Ë&& 
qu™t
)

124 
lﬂd
 = 
	`löked_li°_gë
(
lq
);

125 i‡(!
lﬂd
->
ªady
 && !
	`X86ThªadIsU›Ródy
(
£lf
,Üoad))

127 
	`löked_li°_√xt
(
lq
);

130 
lﬂd
->
ªady
 = 1;

133 i‡(!
	`mod_ˇn_ac˚ss
(
£lf
->
d©a_mod
, 
lﬂd
->
phy_addr
))

135 
	`löked_li°_√xt
(
lq
);

140 
	`as£π
(
lﬂd
->
uö°
->
›code
 =
x86_uö°_lﬂd
);

141 
	`X86ThªadRemoveFromLQ
(
£lf
);

144 
˛õ¡_öfo
 = 
	`mod_˛õ¡_öfo_¸óã
(
£lf
->
d©a_mod
);

145 
˛õ¡_öfo
->
¥e„tchî_eù
 = 
lﬂd
->
eù
;

148 
	`mod_ac˚ss
(
£lf
->
d©a_mod
, 
mod_ac˚ss_lﬂd
,

149 
lﬂd
->
phy_addr
, 
NULL
, 
c‹e
->
evít_queue
,Üﬂd, 
˛õ¡_öfo
);

154 
lﬂd
->
ö_evít_queue
 = 1;

155 
lﬂd
->
issued
 = 1;

156 
lﬂd
->
issue_whí
 = 
	`asTimög
(
˝u
)->
cy˛e
;

159 
c‹e
->
num_issued_uö°_¨øy
[
lﬂd
->
uö°
->
›code
]++;

160 
c‹e
->
lsq_ªads
++;

161 
c‹e
->
ªg_fûe_öt_ªads
 +
lﬂd
->
ph_öt_idï_cou¡
;

162 
c‹e
->
ªg_fûe_Â_ªads
 +
lﬂd
->
ph_Â_idï_cou¡
;

163 
£lf
->
num_issued_uö°_¨øy
[
lﬂd
->
uö°
->
›code
]++;

164 
£lf
->
lsq_ªads
++;

165 
£lf
->
ªg_fûe_öt_ªads
 +
lﬂd
->
ph_öt_idï_cou¡
;

166 
£lf
->
ªg_fûe_Â_ªads
 +
lﬂd
->
ph_Â_idï_cou¡
;

167 
˝u
->
num_issued_uö°_¨øy
[
lﬂd
->
uö°
->
›code
]++;

168 i‡(
lﬂd
->
åa˚_ˇche
)

169 
£lf
->
åa˚_ˇche
->
num_issued_uö°
++;

172 
qu™t
--;

175 i‡(*
mmu_ªp‹t_fûe_«me
)

176 
	`mmu_ac˚ss_∑ge
(
lﬂd
->
phy_addr
, 
mmu_ac˚ss_ªad
);

179 
	`x86_åa˚
("x86.inst id=%lld core=%d stg=\"i\"\n",

180 
lﬂd
->
id_ö_c‹e
, 
c‹e
->
id
);

183  
qu™t
;

184 
	}
}

187 
	$X86ThªadIssuePªQ
(
X86Thªad
 *
£lf
, 
qu™tum
)

189 
X86C‹e
 *
c‹e
 = 
£lf
->core;

190 
X86Cpu
 *
˝u
 = 
£lf
->cpu;

192 
löked_li°_t
 *
¥eq
 = 
£lf
->preq;

193 
x86_u›_t
 *
¥e„tch
;

196 
	`löked_li°_hód
(
¥eq
);

197 !
	`löked_li°_is_íd
(
¥eq
Ë&& 
qu™tum
)

200 
¥e„tch
 = 
	`löked_li°_gë
(
¥eq
);

201 i‡(!
¥e„tch
->
ªady
 && !
	`X86ThªadIsU›Ródy
(
£lf
,Örefetch))

203 
	`löked_li°_√xt
(
¥eq
);

212 i‡(
	`¥e„tch_hi°‹y_is_ªdund™t
(
c‹e
->
¥e„tch_hi°‹y
,

213 
£lf
->
d©a_mod
, 
¥e„tch
->
phy_addr
))

216 
	`as£π
(
¥e„tch
->
uö°
->
›code
 =
x86_uö°_¥e„tch
);

217 
	`X86ThªadRemovePªQ
(
£lf
);

218 
¥e„tch
->
com∂ëed
 = 1;

219 
	`x86_u›_‰ì_if_nŸ_queued
(
¥e„tch
);

223 
¥e„tch
->
ªady
 = 1;

226 i‡(!
	`mod_ˇn_ac˚ss
(
£lf
->
d©a_mod
, 
¥e„tch
->
phy_addr
))

228 
	`löked_li°_√xt
(
¥eq
);

233 
	`as£π
(
¥e„tch
->
uö°
->
›code
 =
x86_uö°_¥e„tch
);

234 
	`X86ThªadRemovePªQ
(
£lf
);

237 
	`mod_ac˚ss
(
£lf
->
d©a_mod
, 
mod_ac˚ss_¥e„tch
,

238 
¥e„tch
->
phy_addr
, 
NULL
, 
c‹e
->
evít_queue
,Örefetch, NULL);

241 
	`¥e„tch_hi°‹y_ªc‹d
(
c‹e
->
¥e„tch_hi°‹y
, 
¥e„tch
->
phy_addr
);

246 
¥e„tch
->
ö_evít_queue
 = 1;

247 
¥e„tch
->
issued
 = 1;

248 
¥e„tch
->
issue_whí
 = 
	`asTimög
(
˝u
)->
cy˛e
;

251 
c‹e
->
num_issued_uö°_¨øy
[
¥e„tch
->
uö°
->
›code
]++;

252 
c‹e
->
lsq_ªads
++;

253 
c‹e
->
ªg_fûe_öt_ªads
 +
¥e„tch
->
ph_öt_idï_cou¡
;

254 
c‹e
->
ªg_fûe_Â_ªads
 +
¥e„tch
->
ph_Â_idï_cou¡
;

255 
£lf
->
num_issued_uö°_¨øy
[
¥e„tch
->
uö°
->
›code
]++;

256 
£lf
->
lsq_ªads
++;

257 
£lf
->
ªg_fûe_öt_ªads
 +
¥e„tch
->
ph_öt_idï_cou¡
;

258 
£lf
->
ªg_fûe_Â_ªads
 +
¥e„tch
->
ph_Â_idï_cou¡
;

259 
˝u
->
num_issued_uö°_¨øy
[
¥e„tch
->
uö°
->
›code
]++;

260 i‡(
¥e„tch
->
åa˚_ˇche
)

261 
£lf
->
åa˚_ˇche
->
num_issued_uö°
++;

264 
qu™tum
--;

267 i‡(*
mmu_ªp‹t_fûe_«me
)

268 
	`mmu_ac˚ss_∑ge
(
¥e„tch
->
phy_addr
, 
mmu_ac˚ss_ªad
);

271 
	`x86_åa˚
("x86.inst id=%lld core=%d stg=\"i\"\n",

272 
¥e„tch
->
id_ö_c‹e
, 
c‹e
->
id
);

275  
qu™tum
;

276 
	}
}

279 
	$X86ThªadIssueIQ
(
X86Thªad
 *
£lf
, 
qu™t
)

281 
X86Cpu
 *
˝u
 = 
£lf
->cpu;

282 
X86C‹e
 *
c‹e
 = 
£lf
->core;

284 
löked_li°_t
 *
iq
 = 
£lf
->iq;

285 
x86_u›_t
 *
u›
;

286 
œt
;

289 
	`löked_li°_hód
(
iq
);

290 !
	`löked_li°_is_íd
(
iq
Ë&& 
qu™t
)

293 
u›
 = 
	`löked_li°_gë
(
iq
);

294 
	`as£π
(
	`x86_u›_exi°s
(
u›
));

295 
	`as£π
(!(
u›
->
Êags
 & 
X86_UINST_MEM
));

296 i‡(!
u›
->
ªady
 && !
	`X86ThªadIsU›Ródy
(
£lf
, uop))

298 
	`löked_li°_√xt
(
iq
);

301 
u›
->
ªady
 = 1;

307 
œt
 = 
	`X86C‹eRe£rveFun˘i⁄ÆUnô
(
c‹e
, 
u›
);

308 i‡(!
œt
)

310 
	`löked_li°_√xt
(
iq
);

316 
	`X86ThªadRemoveFromIQ
(
£lf
);

319 
	`as£π
(!
u›
->
ö_evít_queue
);

320 
	`as£π
(
œt
 > 0);

321 
u›
->
issued
 = 1;

322 
u›
->
issue_whí
 = 
	`asTimög
(
˝u
)->
cy˛e
;

323 
u›
->
whí
 = 
	`asTimög
(
˝u
)->
cy˛e
 + 
œt
;

324 
	`X86C‹eIn£πInEvítQueue
(
c‹e
, 
u›
);

327 
c‹e
->
num_issued_uö°_¨øy
[
u›
->
uö°
->
›code
]++;

328 
c‹e
->
iq_ªads
++;

329 
c‹e
->
ªg_fûe_öt_ªads
 +
u›
->
ph_öt_idï_cou¡
;

330 
c‹e
->
ªg_fûe_Â_ªads
 +
u›
->
ph_Â_idï_cou¡
;

331 
£lf
->
num_issued_uö°_¨øy
[
u›
->
uö°
->
›code
]++;

332 
£lf
->
iq_ªads
++;

333 
£lf
->
ªg_fûe_öt_ªads
 +
u›
->
ph_öt_idï_cou¡
;

334 
£lf
->
ªg_fûe_Â_ªads
 +
u›
->
ph_Â_idï_cou¡
;

335 
˝u
->
num_issued_uö°_¨øy
[
u›
->
uö°
->
›code
]++;

336 i‡(
u›
->
åa˚_ˇche
)

337 
£lf
->
åa˚_ˇche
->
num_issued_uö°
++;

340 
qu™t
--;

343 
	`x86_åa˚
("x86.inst id=%lld core=%d stg=\"i\"\n",

344 
u›
->
id_ö_c‹e
, 
c‹e
->
id
);

347  
qu™t
;

348 
	}
}

351 
	$X86ThªadIssueLSQ
(
X86Thªad
 *
£lf
, 
qu™tum
)

353 
qu™tum
 = 
	`X86ThªadIssueLQ
(
£lf
, quantum);

354 
qu™tum
 = 
	`X86ThªadIssueSQ
(
£lf
, quantum);

355 
qu™tum
 = 
	`X86ThªadIssuePªQ
(
£lf
, quantum);

357  
qu™tum
;

358 
	}
}

368 
	$X86C‹eIssue
(
X86C‹e
 *
£lf
)

370 
X86Thªad
 *
thªad
;

372 
skù
;

373 
qu™tum
;

375 
x86_˝u_issue_köd
)

378 
x86_˝u_issue_köd_sh¨ed
:

381 
qu™tum
 = 
x86_˝u_issue_width
;

382 
skù
 = 
x86_˝u_num_thªads
;

385 
£lf
->
issue_cuºít
 = (£lf->issue_cuºíà+ 1Ë% 
x86_˝u_num_thªads
;

386 
thªad
 = 
£lf
->
thªads
[£lf->
issue_cuºít
];

387 
qu™tum
 = 
	`X86ThªadIssueLSQ
(
thªad
, quantum);

388 
skù
--;

389 } 
skù
 && 
qu™tum
);

392 
qu™tum
 = 
x86_˝u_issue_width
;

393 
skù
 = 
x86_˝u_num_thªads
;

396 
£lf
->
issue_cuºít
 = (£lf->issue_cuºíà+ 1Ë% 
x86_˝u_num_thªads
;

397 
thªad
 = 
£lf
->
thªads
[£lf->
issue_cuºít
];

398 
qu™tum
 = 
	`X86ThªadIssueIQ
(
thªad
, quantum);

399 
skù
--;

400 } 
skù
 && 
qu™tum
);

405 
x86_˝u_issue_köd_time¶i˚
:

408 
qu™tum
 = 
x86_˝u_issue_width
;

409 
skù
 = 
x86_˝u_num_thªads
;

412 
£lf
->
issue_cuºít
 = (£lf->issue_cuºíà+ 1Ë% 
x86_˝u_num_thªads
;

413 
thªad
 = 
£lf
->
thªads
[£lf->
issue_cuºít
];

414 
qu™tum
 = 
	`X86ThªadIssueLSQ
(
thªad
, quantum);

415 
skù
--;

416 } 
skù
 && 
qu™tum
 =
x86_˝u_issue_width
);

419 
qu™tum
 = 
x86_˝u_issue_width
;

420 
skù
 = 
x86_˝u_num_thªads
;

423 
£lf
->
issue_cuºít
 = (£lf->issue_cuºíà+ 1Ë% 
x86_˝u_num_thªads
;

424 
thªad
 = 
£lf
->
thªads
[£lf->
issue_cuºít
];

425 
qu™tum
 = 
	`X86ThªadIssueIQ
(
thªad
, quantum);

426 
skù
--;

427 } 
skù
 && 
qu™tum
 =
x86_˝u_issue_width
);

433 
	`∑nic
("%s: invÆid issuêköd", 
__FUNCTION__
);

435 
	}
}

444 
	$X86CpuIssue
(
X86Cpu
 *
£lf
)

446 
i
;

448 
£lf
->
°age
 = "issue";

449 
i
 = 0; i < 
x86_˝u_num_c‹es
; i++)

450 
	`X86C‹eIssue
(
£lf
->
c‹es
[
i
]);

451 
	}
}

	@issue.h

20 #i‚de‡
ARCH_X86_TIMING_ISSUE_H


21 
	#ARCH_X86_TIMING_ISSUE_H


	)

23 
	~<lib/utû/˛ass.h
>

30 
X86CpuIssue
(
X86Cpu
 *
£lf
);

	@load-store-queue.c

21 
	~<lib/utû/löked-li°.h
>

23 
	~"c‹e.h
"

24 
	~"˝u.h
"

25 
	~"lﬂd-°‹e-queue.h
"

26 
	~"u›.h
"

27 
	~"thªad.h
"

30 *
	gx86_lsq_köd_m≠
[] = { "Shared", "Private" };

31 
x86_lsq_köd_t
 
	gx86_lsq_köd
;

32 
	gx86_lsq_size
;

40 
	$X86ThªadInôLSQ
(
X86Thªad
 *
£lf
)

42 
£lf
->
lq
 = 
	`löked_li°_¸óã
();

43 
£lf
->
sq
 = 
	`löked_li°_¸óã
();

44 
£lf
->
¥eq
 = 
	`löked_li°_¸óã
();

45 
	}
}

48 
	$X86ThªadFªeLSQ
(
X86Thªad
 *
£lf
)

50 
löked_li°_t
 *
lq
;

51 
löked_li°_t
 *
sq
;

52 
löked_li°_t
 *
¥eq
;

53 
x86_u›_t
 *
u›
;

56 
lq
 = 
£lf
->lq;

57 
	`löked_li°_hód
(
lq
);

58 
	`löked_li°_cou¡
(
lq
))

60 
u›
 = 
	`löked_li°_gë
(
lq
);

61 
u›
->
ö_lq
 = 0;

62 
	`löked_li°_ªmove
(
lq
);

63 
	`x86_u›_‰ì_if_nŸ_queued
(
u›
);

65 
	`löked_li°_‰ì
(
lq
);

68 
sq
 = 
£lf
->sq;

69 
	`löked_li°_hód
(
sq
);

70 
	`löked_li°_cou¡
(
sq
))

72 
u›
 = 
	`löked_li°_gë
(
sq
);

73 
u›
->
ö_sq
 = 0;

74 
	`löked_li°_ªmove
(
sq
);

75 
	`x86_u›_‰ì_if_nŸ_queued
(
u›
);

77 
	`löked_li°_‰ì
(
sq
);

80 
¥eq
 = 
£lf
->preq;

81 
	`löked_li°_hód
(
¥eq
);

82 
	`löked_li°_cou¡
(
¥eq
))

84 
u›
 = 
	`löked_li°_gë
(
¥eq
);

85 
u›
->
ö_¥eq
 = 0;

86 
	`löked_li°_ªmove
(
¥eq
);

87 
	`x86_u›_‰ì_if_nŸ_queued
(
u›
);

89 
	`löked_li°_‰ì
(
¥eq
);

90 
	}
}

93 
	$X86ThªadC™In£πInLSQ
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
)

95 
X86C‹e
 *
c‹e
 = 
£lf
->core;

97 
cou¡
;

98 
size
;

100 
	`as£π
(
u›
->
thªad
 =
£lf
);

101 
size
 = 
x86_lsq_köd
 =
x86_lsq_köd_¥iv©e
 ? 
x86_lsq_size
 : x86_lsq_sizê* 
x86_˝u_num_thªads
;

102 
cou¡
 = 
x86_lsq_köd
 =
x86_lsq_köd_¥iv©e
 ? 
£lf
->
lsq_cou¡
 : 
c‹e
->lsq_count;

103  
cou¡
 < 
size
;

104 
	}
}

108 
	$X86ThªadIn£πInLSQ
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
)

110 
X86C‹e
 *
c‹e
 = 
£lf
->core;

112 
löked_li°_t
 *
lq
 = 
£lf
->lq;

113 
löked_li°_t
 *
sq
 = 
£lf
->sq;

114 
löked_li°_t
 *
¥eq
 = 
£lf
->preq;

116 
	`as£π
(!
u›
->
ö_lq
 && !u›->
ö_sq
);

117 
	`as£π
(
u›
->
uö°
->
›code
 =
x86_uö°_lﬂd
 || u›->uö°->›codê=
x86_uö°_°‹e
 ||

118 
u›
->
uö°
->
›code
 =
x86_uö°_¥e„tch
);

120 i‡(
u›
->
uö°
->
›code
 =
x86_uö°_lﬂd
)

122 
	`löked_li°_out
(
lq
);

123 
	`löked_li°_ö£π
(
lq
, 
u›
);

124 
u›
->
ö_lq
 = 1;

126 i‡(
u›
->
uö°
->
›code
 =
x86_uö°_°‹e
)

128 
	`löked_li°_out
(
sq
);

129 
	`löked_li°_ö£π
(
sq
, 
u›
);

130 
u›
->
ö_sq
 = 1;

134 
	`löked_li°_out
(
¥eq
);

135 
	`löked_li°_ö£π
(
¥eq
, 
u›
);

136 
u›
->
ö_¥eq
 = 1;

138 
c‹e
->
lsq_cou¡
++;

139 
£lf
->
lsq_cou¡
++;

140 
	}
}

145 
	$X86ThªadRecovîLSQ
(
X86Thªad
 *
£lf
)

147 
löked_li°_t
 *
lq
 = 
£lf
->lq;

148 
löked_li°_t
 *
sq
 = 
£lf
->sq;

149 
x86_u›_t
 *
u›
;

152 
	`löked_li°_hód
(
lq
);

153 !
	`löked_li°_is_íd
(
lq
))

155 
u›
 = 
	`löked_li°_gë
(
lq
);

156 i‡(
u›
->
•ecmode
)

158 
	`X86ThªadRemoveFromLQ
(
£lf
);

159 
	`x86_u›_‰ì_if_nŸ_queued
(
u›
);

162 
	`löked_li°_√xt
(
lq
);

166 
	`löked_li°_hód
(
sq
);

167 !
	`löked_li°_is_íd
(
sq
))

169 
u›
 = 
	`löked_li°_gë
(
sq
);

170 i‡(
u›
->
•ecmode
)

172 
	`X86ThªadRemoveFromSQ
(
£lf
);

173 
	`x86_u›_‰ì_if_nŸ_queued
(
u›
);

176 
	`löked_li°_√xt
(
sq
);

178 
	}
}

183 
	$X86ThªadRemoveFromLQ
(
X86Thªad
 *
£lf
)

185 
X86C‹e
 *
c‹e
 = 
£lf
->core;

187 
löked_li°_t
 *
lq
 = 
£lf
->lq;

188 
x86_u›_t
 *
u›
;

190 
u›
 = 
	`löked_li°_gë
(
lq
);

191 
	`as£π
(
	`x86_u›_exi°s
(
u›
));

192 
	`löked_li°_ªmove
(
lq
);

193 
u›
->
ö_lq
 = 0;

195 
	`as£π
(
c‹e
->
lsq_cou¡
 && 
£lf
->lsq_count);

196 
c‹e
->
lsq_cou¡
--;

197 
£lf
->
lsq_cou¡
--;

198 
	}
}

202 
	$X86ThªadRemoveFromSQ
(
X86Thªad
 *
£lf
)

204 
X86C‹e
 *
c‹e
 = 
£lf
->core;

206 
löked_li°_t
 *
sq
 = 
£lf
->sq;

207 
x86_u›_t
 *
u›
;

209 
u›
 = 
	`löked_li°_gë
(
sq
);

210 
	`as£π
(
	`x86_u›_exi°s
(
u›
));

211 
	`as£π
(
u›
->
ö_sq
);

212 
	`löked_li°_ªmove
(
sq
);

213 
u›
->
ö_sq
 = 0;

215 
	`as£π
(
c‹e
->
lsq_cou¡
 && 
£lf
->lsq_count);

216 
c‹e
->
lsq_cou¡
--;

217 
£lf
->
lsq_cou¡
--;

218 
	}
}

221 
	$X86ThªadRemovePªQ
(
X86Thªad
 *
£lf
)

223 
X86C‹e
 *
c‹e
 = 
£lf
->core;

225 
löked_li°_t
 *
¥eq
 = 
£lf
->preq;

226 
x86_u›_t
 *
u›
;

228 
u›
 = 
	`löked_li°_gë
(
¥eq
);

229 
	`as£π
(
	`x86_u›_exi°s
(
u›
));

230 
	`as£π
(
u›
->
ö_¥eq
);

231 
	`löked_li°_ªmove
(
¥eq
);

232 
u›
->
ö_¥eq
 = 0;

234 
	`as£π
(
c‹e
->
lsq_cou¡
 && 
£lf
->lsq_count);

235 
c‹e
->
lsq_cou¡
--;

236 
£lf
->
lsq_cou¡
--;

237 
	}
}

	@load-store-queue.h

20 #i‚de‡
X86_ARCH_TIMING_LOAD_STORE_QUEUE_H


21 
	#X86_ARCH_TIMING_LOAD_STORE_QUEUE_H


	)

28 *
x86_lsq_köd_m≠
[];

29 
	ex86_lsq_köd_t


31 
x86_lsq_köd_sh¨ed
 = 0,

32 
x86_lsq_köd_¥iv©e


33 } 
x86_lsq_köd
;

34 
x86_lsq_size
;

42 
X86ThªadInôLSQ
(
X86Thªad
 *
£lf
);

43 
X86ThªadFªeLSQ
(
X86Thªad
 *
£lf
);

45 
X86ThªadC™In£πInLSQ
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
);

46 
X86ThªadIn£πInLSQ
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
);

47 
X86ThªadRecovîLSQ
(
X86Thªad
 *
£lf
);

49 
X86ThªadRemoveFromLQ
(
X86Thªad
 *
£lf
);

50 
X86ThªadRemoveFromSQ
(
X86Thªad
 *
£lf
);

51 
X86ThªadRemovePªQ
(
X86Thªad
 *
£lf
);

	@mem-config.c

21 
	~<¨ch/comm⁄/¨ch.h
>

22 
	~<lib/utû/c⁄fig.h
>

23 
	~<lib/utû/debug.h
>

24 
	~<lib/utû/löked-li°.h
>

25 
	~<lib/utû/°rög.h
>

26 
	~<mem-sy°em/mem-sy°em.h
>

27 
	~<mem-sy°em/moduÀ.h
>

29 
	~"c‹e.h
"

30 
	~"˝u.h
"

31 
	~"mem-c⁄fig.h
"

32 
	~"thªad.h
"

35 
	$X86CpuMemC⁄figDeÁu…
(
Timög
 *
£lf
, 
c⁄fig_t
 *
c⁄fig
)

37 
£˘i⁄
[
MAX_STRING_SIZE
];

38 
°r
[
MAX_STRING_SIZE
];

40 
i
;

41 
j
;

44 
	`¢¥ötf
(
£˘i⁄
,  section, "CacheGeometry x86-geo-l1");

45 
	`c⁄fig_wrôe_öt
(
c⁄fig
, 
£˘i⁄
, "Sets", 16);

46 
	`c⁄fig_wrôe_öt
(
c⁄fig
, 
£˘i⁄
, "Assoc", 2);

47 
	`c⁄fig_wrôe_öt
(
c⁄fig
, 
£˘i⁄
, "BlockSize", 64);

48 
	`c⁄fig_wrôe_öt
(
c⁄fig
, 
£˘i⁄
, "Latency", 1);

49 
	`c⁄fig_wrôe_°rög
(
c⁄fig
, 
£˘i⁄
, "Policy", "LRU");

52 
	`¢¥ötf
(
£˘i⁄
,  section, "CacheGeometry x86-geo-l2");

53 
	`c⁄fig_wrôe_öt
(
c⁄fig
, 
£˘i⁄
, "Sets", 64);

54 
	`c⁄fig_wrôe_öt
(
c⁄fig
, 
£˘i⁄
, "Assoc", 4);

55 
	`c⁄fig_wrôe_öt
(
c⁄fig
, 
£˘i⁄
, "BlockSize", 64);

56 
	`c⁄fig_wrôe_öt
(
c⁄fig
, 
£˘i⁄
, "Latency", 10);

57 
	`c⁄fig_wrôe_°rög
(
c⁄fig
, 
£˘i⁄
, "Policy", "LRU");

60 
i
 = 0; i < 
x86_˝u_num_c‹es
; i++)

63 
	`¢¥ötf
(
£˘i⁄
,  se˘i⁄, "ModuÀ x86-l1-%d", 
i
);

64 
	`c⁄fig_wrôe_°rög
(
c⁄fig
, 
£˘i⁄
, "Type", "Cache");

65 
	`c⁄fig_wrôe_°rög
(
c⁄fig
, 
£˘i⁄
, "Geometry", "x86-geo-l1");

66 
	`c⁄fig_wrôe_°rög
(
c⁄fig
, 
£˘i⁄
, "LowNetwork", "x86-net-l1-l2");

67 
	`c⁄fig_wrôe_°rög
(
c⁄fig
, 
£˘i⁄
, "LowModules", "x86-l2");

70 
	`¢¥ötf
(
°r
,  så, "x86-l1-%d", 
i
);

71 
j
 = 0; j < 
x86_˝u_num_thªads
; j++)

73 
	`¢¥ötf
(
£˘i⁄
,  section, "Entry x86-core-%d-thread-%d",

74 
i
, 
j
);

75 
	`c⁄fig_wrôe_°rög
(
c⁄fig
, 
£˘i⁄
, "Arch", "x86");

76 
	`c⁄fig_wrôe_öt
(
c⁄fig
, 
£˘i⁄
, "C‹e", 
i
);

77 
	`c⁄fig_wrôe_öt
(
c⁄fig
, 
£˘i⁄
, "Thªad", 
j
);

78 
	`c⁄fig_wrôe_°rög
(
c⁄fig
, 
£˘i⁄
, "ModuÀ", 
°r
);

83 
	`¢¥ötf
(
£˘i⁄
,  section, "Module x86-l2");

84 
	`c⁄fig_wrôe_°rög
(
c⁄fig
, 
£˘i⁄
, "Type", "Cache");

85 
	`c⁄fig_wrôe_°rög
(
c⁄fig
, 
£˘i⁄
, "Geometry", "x86-geo-l2");

86 
	`c⁄fig_wrôe_°rög
(
c⁄fig
, 
£˘i⁄
, "HighNetwork", "x86-net-l1-l2");

87 
	`c⁄fig_wrôe_°rög
(
c⁄fig
, 
£˘i⁄
, "LowNetwork", "x86-net-l2-mm");

88 
	`c⁄fig_wrôe_°rög
(
c⁄fig
, 
£˘i⁄
, "LowModules", "x86-mm");

91 
	`¢¥ötf
(
£˘i⁄
,  section, "Module x86-mm");

92 
	`c⁄fig_wrôe_°rög
(
c⁄fig
, 
£˘i⁄
, "Type", "MainMemory");

93 
	`c⁄fig_wrôe_°rög
(
c⁄fig
, 
£˘i⁄
, "HighNetwork", "x86-net-l2-mm");

94 
	`c⁄fig_wrôe_öt
(
c⁄fig
, 
£˘i⁄
, "BlockSize", 64);

95 
	`c⁄fig_wrôe_öt
(
c⁄fig
, 
£˘i⁄
, "Latency", 100);

98 
	`¢¥ötf
(
£˘i⁄
,  section, "Network x86-net-l1-l2");

99 
	`c⁄fig_wrôe_öt
(
c⁄fig
, 
£˘i⁄
, "DefaultInputBufferSize", 144);

100 
	`c⁄fig_wrôe_öt
(
c⁄fig
, 
£˘i⁄
, "DefaultOutputBufferSize", 144);

101 
	`c⁄fig_wrôe_öt
(
c⁄fig
, 
£˘i⁄
, "DefaultBandwidth", 72);

104 
	`¢¥ötf
(
£˘i⁄
,  section, "Network x86-net-l2-mm");

105 
	`c⁄fig_wrôe_öt
(
c⁄fig
, 
£˘i⁄
, "DefaultInputBufferSize", 528);

106 
	`c⁄fig_wrôe_öt
(
c⁄fig
, 
£˘i⁄
, "DefaultOutputBufferSize", 528);

107 
	`c⁄fig_wrôe_öt
(
c⁄fig
, 
£˘i⁄
, "DefaultBandwidth", 264);

108 
	}
}

111 
	$X86CpuMemC⁄figP¨£E¡ry
(
Timög
 *
£lf
, 
c⁄fig_t
 *
c⁄fig
, *
£˘i⁄
)

113 
X86Cpu
 *
˝u
 = 
	`asX86Cpu
(
£lf
);

114 
X86C‹e
 *
c‹e
;

115 
X86Thªad
 *
thªad
;

117 *
fûe_«me
;

119 
c‹e_ödex
;

120 
thªad_ödex
;

122 
unifõd_¥e£¡
;

123 
d©a_ö°_¥e£¡
;

125 *
d©a_moduÀ_«me
;

126 *
ö°_moduÀ_«me
;

129 
fûe_«me
 = 
	`c⁄fig_gë_fûe_«me
(
c⁄fig
);

132 
	`c⁄fig_v¨_Ælow
(
c⁄fig
, 
£˘i⁄
, "DataModule");

133 
	`c⁄fig_v¨_Ælow
(
c⁄fig
, 
£˘i⁄
, "InstModule");

134 
	`c⁄fig_v¨_Ælow
(
c⁄fig
, 
£˘i⁄
, "Module");

137 
unifõd_¥e£¡
 = 
	`c⁄fig_v¨_exi°s
(
c⁄fig
, 
£˘i⁄
, "Module");

138 
d©a_ö°_¥e£¡
 = 
	`c⁄fig_v¨_exi°s
(
c⁄fig
, 
£˘i⁄
, "DataModule") &&

139 
	`c⁄fig_v¨_exi°s
(
c⁄fig
, 
£˘i⁄
, "InstModule");

140 i‡(!(
unifõd_¥e£¡
 ^ 
d©a_ö°_¥e£¡
))

141 
	`Áèl
("%s: section [%s]: invalid combination of modules.\n"

146 
fûe_«me
, 
£˘i⁄
);

149 
c‹e_ödex
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "Core", -1);

150 i‡(
c‹e_ödex
 < 0)

151 
	`Áèl
("%s: section [%s]: invalid or missing value for 'Core'",

152 
fûe_«me
, 
£˘i⁄
);

155 
thªad_ödex
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "Thread", -1);

156 i‡(
thªad_ödex
 < 0)

157 
	`Áèl
("%s: section [%s]: invalid or missing value for 'Thread'",

158 
fûe_«me
, 
£˘i⁄
);

161 i‡(
c‹e_ödex
 >
x86_˝u_num_c‹es
 || 
thªad_ödex
 >
x86_˝u_num_thªads
)

163 
	`w¨nög
("%s: section [%s] ignored,ÑeferringÅo x86 Core %d, Thread %d.\n"

166 
fûe_«me
, 
£˘i⁄
, 
c‹e_ödex
, 
thªad_ödex
);

171 
c‹e
 = 
˝u
->
c‹es
[
c‹e_ödex
];

172 
thªad
 = 
c‹e
->
thªads
[
thªad_ödex
];

173 i‡(
thªad
->
d©a_mod
 ||Åhªad->
ö°_mod
)

175 
	`as£π
(
thªad
->
d©a_mod
 &&Åhªad->
ö°_mod
);

176 
	`Áèl
("%s: section [%s]:Éntry from Core %d, Thread %dálreadyássigned.\n"

180 
fûe_«me
, 
£˘i⁄
, 
c‹e_ödex
, 
thªad_ödex
);

184 i‡(
d©a_ö°_¥e£¡
)

186 
d©a_moduÀ_«me
 = 
	`c⁄fig_ªad_°rög
(
c⁄fig
, 
£˘i⁄
, "D©aModuÀ", 
NULL
);

187 
ö°_moduÀ_«me
 = 
	`c⁄fig_ªad_°rög
(
c⁄fig
, 
£˘i⁄
, "In°ModuÀ", 
NULL
);

188 
	`as£π
(
d©a_moduÀ_«me
);

189 
	`as£π
(
ö°_moduÀ_«me
);

193 
d©a_moduÀ_«me
 = 
ö°_moduÀ_«me
 =

194 
	`c⁄fig_ªad_°rög
(
c⁄fig
, 
£˘i⁄
, "ModuÀ", 
NULL
);

195 
	`as£π
(
d©a_moduÀ_«me
);

199 
thªad
->
d©a_mod
 = 
	`mem_sy°em_gë_mod
(
d©a_moduÀ_«me
);

200 i‡(!
thªad
->
d©a_mod
)

201 
	`Áèl
("%s: section [%s]: '%s' isÇotá valid moduleÇame.\n"

204 
fûe_«me
, 
£˘i⁄
, 
d©a_moduÀ_«me
);

207 
thªad
->
ö°_mod
 = 
	`mem_sy°em_gë_mod
(
ö°_moduÀ_«me
);

208 i‡(!
thªad
->
ö°_mod
)

209 
	`Áèl
("%s: section [%s]: '%s' isÇotá valid moduleÇame.\n"

212 
fûe_«me
, 
£˘i⁄
, 
ö°_moduÀ_«me
);

215 
	`löked_li°_add
(
¨ch_x86
->
mem_íåy_mod_li°
, 
thªad
->
d©a_mod
);

216 i‡(
thªad
->
d©a_mod
 !thªad->
ö°_mod
)

217 
	`löked_li°_add
(
¨ch_x86
->
mem_íåy_mod_li°
, 
thªad
->
ö°_mod
);

220 
	`mem_debug
("\tx86 C‹ê%d, Thªad %d\n", 
c‹e_ödex
, 
thªad_ödex
);

221 
	`mem_debug
("\t\tE¡ry f‹ in°ru˘i⁄†-> %s\n", 
thªad
->
ö°_mod
->
«me
);

222 
	`mem_debug
("\t\tE¡ry f‹ d©®-> %s\n", 
thªad
->
d©a_mod
->
«me
);

223 
	`mem_debug
("\n");

224 
	}
}

227 
	$X86CpuMemC⁄figCheck
(
Timög
 *
£lf
, 
c⁄fig_t
 *
c⁄fig
)

229 
X86Cpu
 *
˝u
 = 
	`asX86Cpu
(
£lf
);

230 
X86C‹e
 *
c‹e
;

231 
X86Thªad
 *
thªad
;

233 
i
;

234 
j
;

236 *
fûe_«me
;

239 
fûe_«me
 = 
	`c⁄fig_gë_fûe_«me
(
c⁄fig
);

240 
i
 = 0; i < 
x86_˝u_num_c‹es
; i++)

242 
c‹e
 = 
˝u
->
c‹es
[
i
];

243 
j
 = 0; j < 
x86_˝u_num_thªads
; j++)

245 
thªad
 = 
c‹e
->
thªads
[
j
];

246 i‡(!
thªad
->
d©a_mod
 || !thªad->
ö°_mod
)

247 
	`Áèl
("%s: x86 Core %d, Thread %dÜacksá data/instructionÉntryÅo memory.\n"

250 
fûe_«me
, 
i
, 
j
);

253 
	}
}

	@mem-config.h

20 #i‚de‡
ARCH_X86_TIMING_MEM_CONFIG_H


21 
	#ARCH_X86_TIMING_MEM_CONFIG_H


	)

23 
	gc⁄fig_t
;

25 
X86CpuMemC⁄figDeÁu…
(
Timög
 *
£lf
, 
c⁄fig_t
 *
c⁄fig
);

26 
X86CpuMemC⁄figP¨£E¡ry
(
Timög
 *
£lf
, 
c⁄fig_t
 *
c⁄fig
, *
£˘i⁄
);

27 
X86CpuMemC⁄figCheck
(
Timög
 *
£lf
, 
c⁄fig_t
 *
c⁄fig
);

	@recover.c

21 
	~<¨ch/x86/emu/c⁄ãxt.h
>

22 
	~<¨ch/x86/emu/ªgs.h
>

23 
	~<lib/esim/åa˚.h
>

24 
	~<lib/utû/misc.h
>

26 
	~"c‹e.h
"

27 
	~"˝u.h
"

28 
	~"evít-queue.h
"

29 
	~"„tch-queue.h
"

30 
	~"ö°-queue.h
"

31 
	~"lﬂd-°‹e-queue.h
"

32 
	~"ªcovî.h
"

33 
	~"ªg-fûe.h
"

34 
	~"rob.h
"

35 
	~"thªad.h
"

36 
	~"åa˚-ˇche.h
"

37 
	~"u›-queue.h
"

44 
	$X86ThªadRecovî
(
X86Thªad
 *
£lf
)

46 
X86Cpu
 *
˝u
 = 
£lf
->cpu;

47 
X86C‹e
 *
c‹e
 = 
£lf
->core;

49 
x86_u›_t
 *
u›
;

53 
	`X86ThªadRecovîFëchQueue
(
£lf
);

54 
	`X86ThªadRecovîU›Queue
(
£lf
);

55 
	`X86ThªadRecovîIQ
(
£lf
);

56 
	`X86ThªadRecovîLSQ
(
£lf
);

57 
	`X86ThªadRecovîEvítQueue
(
£lf
);

64 
u›
 = 
	`X86ThªadGëROBTaû
(
£lf
);

65 i‡(!
u›
)

70 
	`as£π
(
u›
->
thªad
 =
£lf
);

71 i‡(!
u›
->
•ecmode
)

75 i‡(
u›
->
åa˚_ˇche
)

76 
£lf
->
åa˚_ˇche
->
num_squashed_uö°
++;

77 
£lf
->
num_squashed_uö°
++;

78 
c‹e
->
num_squashed_uö°
++;

79 
˝u
->
num_squashed_uö°
++;

82 i‡(!
u›
->
com∂ëed
)

83 
	`X86ThªadWrôeU›
(
£lf
, 
u›
);

84 
	`X86ThªadUndoU›
(
£lf
, 
u›
);

87 i‡(
	`x86_åacög
())

89 
	`x86_åa˚
("x86.inst id=%lld core=%d stg=\"sq\"\n",

90 
u›
->
id_ö_c‹e
, 
c‹e
->
id
);

91 
	`X86CpuAddToTø˚Li°
(
˝u
, 
u›
);

95 
	`X86ThªadRemoveROBTaû
(
£lf
);

99 i‡(
£lf
->
˘x
)

102 i‡(
	`X86C⁄ãxtGëSèã
(
£lf
->
˘x
, 
X86C⁄ãxtS≥cMode
))

103 
	`X86C⁄ãxtRecovî
(
£lf
->
˘x
);

106 
£lf
->
„tch_°Æl_u¡û
 = 
	`MAX
(self->fetch_stall_until,

107 
	`asTimög
(
˝u
)->
cy˛e
 + 
x86_˝u_ªcovî_≥«…y
 - 1);

108 
£lf
->
„tch_√ù
 = sñf->
˘x
->
ªgs
->
eù
;

110 
	}
}

	@recover.h

20 #i‚de‡
ARCH_X86_TIMING_RECOVER_H


21 
	#ARCH_X86_TIMING_RECOVER_H


	)

23 
	~<lib/utû/˛ass.h
>

29 
X86ThªadRecovî
(
X86Thªad
 *
£lf
);

	@reg-file.c

21 
	~<lib/mh™dÀ/mh™dÀ.h
>

22 
	~<lib/utû/c⁄fig.h
>

23 
	~<lib/utû/debug.h
>

24 
	~<lib/utû/löked-li°.h
>

26 
	~"c‹e.h
"

27 
	~"˝u.h
"

28 
	~"ªg-fûe.h
"

29 
	~"rob.h
"

30 
	~"thªad.h
"

38 
	$X86ThªadInôRegFûe
(
X86Thªad
 *
£lf
)

40 
x86_ªg_fûe_t
 *
ªg_fûe
;

42 
dï
;

43 
phªg
;

44 
Âhªg
;

47 
£lf
->
ªg_fûe
 =Ñeg_fûê
	`x86_ªg_fûe_¸óã
(
x86_ªg_fûe_öt_loˇl_size
,

48 
x86_ªg_fûe_Â_loˇl_size
, 
x86_ªg_fûe_xmm_loˇl_size
);

53 
Âhªg
 = -1;

54 
dï
 = 0; dï < 
x86_dï_öt_cou¡
; dep++)

56 i‡(
	`X86_DEP_IS_FLAG
(
dï
 + 
x86_dï_öt_fú°
))

58 
	`as£π
(
Âhªg
 >= 0);

59 
phªg
 = 
Âhªg
;

63 
phªg
 = 
	`X86ThªadReque°I¡Reg
(
£lf
);

64 
Âhªg
 = 
phªg
;

66 
ªg_fûe
->
öt_phªg
[
phªg
].
busy
++;

67 
ªg_fûe
->
öt_øt
[
dï
] = 
phªg
;

71 
dï
 = 0; dï < 
x86_dï_Â_cou¡
; dep++)

73 
phªg
 = 
	`X86ThªadReque°FPReg
(
£lf
);

74 
ªg_fûe
->
Â_phªg
[
phªg
].
busy
++;

75 
ªg_fûe
->
Â_øt
[
dï
] = 
phªg
;

79 
dï
 = 0; dï < 
x86_dï_xmm_cou¡
; dep++)

81 
phªg
 = 
	`X86ThªadReque°XMMReg
(
£lf
);

82 
ªg_fûe
->
xmm_phªg
[
phªg
].
busy
++;

83 
ªg_fûe
->
xmm_øt
[
dï
] = 
phªg
;

85 
	}
}

88 
	$X86ThªadFªeRegFûe
(
X86Thªad
 *
£lf
)

90 
	`x86_ªg_fûe_‰ì
(
£lf
->
ªg_fûe
);

91 
	}
}

94 
	$X86ThªadDumpRegFûe
(
X86Thªad
 *
£lf
, 
FILE
 *
f
)

96 
i
;

99 
	`Ârötf
(
f
, "I¡egîÑegi°î fûêöÅhªad %s\n", 
£lf
->
«me
);

100 
	`Ârötf
(
f
, "Format is [busy,Öending], * = free\n");

101 
i
 = 0; i < 
x86_ªg_fûe_öt_loˇl_size
; i++)

103 
	`Ârötf
(
f
, " %3d%c[%d-%d]", 
i
, 
£lf
->
ªg_fûe
->
öt_phªg
[i].
busy
 ? ' ' : '*',

104 
£lf
->
ªg_fûe
->
öt_phªg
[
i
].
busy
,

105 
£lf
->
ªg_fûe
->
öt_phªg
[
i
].
≥ndög
);

106 i‡(
i
 % 5 =4 && i !
x86_ªg_fûe_öt_loˇl_size
 - 1)

107 
	`Ârötf
(
f
, "\n");

110 
	`Ârötf
(
f
, "\nInteger Register Aliasing Table:\n");

111 
i
 = 
x86_dï_öt_fú°
; i <
x86_dï_öt_œ°
; i++)

113 
	`Ârötf
(
f
, " %2d->%-3d", 
i
, 
£lf
->
ªg_fûe
->
öt_øt
[ò- 
x86_dï_öt_fú°
]);

114 i‡((
i
 - 
x86_dï_öt_fú°
) % 8 == 7)

115 
	`Ârötf
(
f
, "\n");

118 
	`Ârötf
(
f
, "\n");

119 
	`Ârötf
(
f
, "int_free_phreg_count %d # Number of free integerÑegisters\n",

120 
£lf
->
ªg_fûe
->
öt_‰ì_phªg_cou¡
);

121 
	`Ârötf
(
f
, "\n");

124 
	`Ârötf
(
f
, "Flﬂtög-poöàªgi°î fûê©Åhªad %s\n", 
£lf
->
«me
);

125 
	`Ârötf
(
f
, "Format is [busy,Öending], * = free\n");

126 
i
 = 0; i < 
x86_ªg_fûe_Â_loˇl_size
; i++)

128 
	`Ârötf
(
f
, " %3d%c[%d-%d]", 
i
, 
£lf
->
ªg_fûe
->
Â_phªg
[i].
busy
 ? ' ' : '*',

129 
£lf
->
ªg_fûe
->
Â_phªg
[
i
].
busy
,

130 
£lf
->
ªg_fûe
->
Â_phªg
[
i
].
≥ndög
);

131 i‡(
i
 % 5 =4 && i !
x86_ªg_fûe_Â_loˇl_size
 - 1)

132 
	`Ârötf
(
f
, "\n");

135 
	`Ârötf
(
f
, "\nIteger Register Aliasing Table:\n");

136 
i
 = 
x86_dï_Â_fú°
; i <
x86_dï_Â_œ°
; i++)

138 
	`Ârötf
(
f
, " %2d->%-3d", 
i
, 
£lf
->
ªg_fûe
->
Â_øt
[ò- 
x86_dï_Â_fú°
]);

139 i‡((
i
 - 
x86_dï_Â_fú°
) % 8 == 7)

140 
	`Ârötf
(
f
, "\n");

143 
	`Ârötf
(
f
, "\n");

144 
	`Ârötf
(
f
, "fp_free_phreg_count %d # Number of free floating-pointÑegisters\n",

145 
£lf
->
ªg_fûe
->
Â_‰ì_phªg_cou¡
);

146 
	`Ârötf
(
f
, "\n");

149 
	`Ârötf
(
f
, "XMMÑegi°î fûê©Åhªad %s\n", 
£lf
->
«me
);

150 
	`Ârötf
(
f
, "Format is [busy,Öending], * = free\n");

151 
i
 = 0; i < 
x86_ªg_fûe_xmm_loˇl_size
; i++)

153 
	`Ârötf
(
f
, " %3d%c[%d-%d]", 
i
, 
£lf
->
ªg_fûe
->
xmm_phªg
[i].
busy
 ? ' ' : '*',

154 
£lf
->
ªg_fûe
->
xmm_phªg
[
i
].
busy
,

155 
£lf
->
ªg_fûe
->
xmm_phªg
[
i
].
≥ndög
);

156 i‡(
i
 % 5 =4 && i !
x86_ªg_fûe_xmm_loˇl_size
 - 1)

157 
	`Ârötf
(
f
, "\n");

160 
	`Ârötf
(
f
, "\nXMM Register Aliasing Table:\n");

161 
i
 = 
x86_dï_xmm_fú°
; i <
x86_dï_xmm_œ°
; i++)

163 
	`Ârötf
(
f
, " %2d->%-3d", 
i
, 
£lf
->
ªg_fûe
->
xmm_øt
[ò- 
x86_dï_xmm_fú°
]);

164 i‡((
i
 - 
x86_dï_xmm_fú°
) % 8 == 7)

165 
	`Ârötf
(
f
, "\n");

168 
	`Ârötf
(
f
, "\n");

169 
	`Ârötf
(
f
, "xmm_free_phreg_count %d # Number of free integerÑegisters\n",

170 
£lf
->
ªg_fûe
->
xmm_‰ì_phªg_cou¡
);

171 
	`Ârötf
(
f
, "\n");

172 
	}
}

175 
	$X86ThªadC™RíameU›
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
)

177 
X86C‹e
 *
c‹e
 = 
£lf
->core;

180 
	`as£π
(
u›
->
thªad
 =
£lf
);

181 i‡(
x86_ªg_fûe_köd
 =
x86_ªg_fûe_köd_¥iv©e
)

183 i‡(
£lf
->
ªg_fûe_öt_cou¡
 + 
u›
->
ph_öt_odï_cou¡
 > 
x86_ªg_fûe_öt_loˇl_size
)

185 i‡(
£lf
->
ªg_fûe_Â_cou¡
 + 
u›
->
ph_Â_odï_cou¡
 > 
x86_ªg_fûe_Â_loˇl_size
)

187 i‡(
£lf
->
ªg_fûe_xmm_cou¡
 + 
u›
->
ph_xmm_odï_cou¡
 > 
x86_ªg_fûe_xmm_loˇl_size
)

192 i‡(
c‹e
->
ªg_fûe_öt_cou¡
 + 
u›
->
ph_öt_odï_cou¡
 > 
x86_ªg_fûe_öt_loˇl_size
)

194 i‡(
c‹e
->
ªg_fûe_Â_cou¡
 + 
u›
->
ph_Â_odï_cou¡
 > 
x86_ªg_fûe_Â_loˇl_size
)

196 i‡(
c‹e
->
ªg_fûe_xmm_cou¡
 + 
u›
->
ph_xmm_odï_cou¡
 > 
x86_ªg_fûe_xmm_loˇl_size
)

202 
	}
}

206 
	$X86ThªadReque°I¡Reg
(
X86Thªad
 *
£lf
)

208 
X86C‹e
 *
c‹e
 = 
£lf
->core;

209 
x86_ªg_fûe_t
 *
ªg_fûe
 = 
£lf
->reg_file;

210 
phªg
;

213 
	`as£π
(
ªg_fûe
->
öt_‰ì_phªg_cou¡
 > 0);

214 
phªg
 = 
ªg_fûe
->
öt_‰ì_phªg
[ªg_fûe->
öt_‰ì_phªg_cou¡
 - 1];

215 
ªg_fûe
->
öt_‰ì_phªg_cou¡
--;

216 
c‹e
->
ªg_fûe_öt_cou¡
++;

217 
£lf
->
ªg_fûe_öt_cou¡
++;

218 
	`as£π
(!
ªg_fûe
->
öt_phªg
[
phªg
].
busy
);

219 
	`as£π
(!
ªg_fûe
->
öt_phªg
[
phªg
].
≥ndög
);

220  
phªg
;

221 
	}
}

225 
	$X86ThªadReque°FPReg
(
X86Thªad
 *
£lf
)

227 
X86C‹e
 *
c‹e
 = 
£lf
->core;

228 
x86_ªg_fûe_t
 *
ªg_fûe
 = 
£lf
->reg_file;

229 
phªg
;

232 
	`as£π
(
ªg_fûe
->
Â_‰ì_phªg_cou¡
 > 0);

233 
phªg
 = 
ªg_fûe
->
Â_‰ì_phªg
[ªg_fûe->
Â_‰ì_phªg_cou¡
 - 1];

234 
ªg_fûe
->
Â_‰ì_phªg_cou¡
--;

235 
c‹e
->
ªg_fûe_Â_cou¡
++;

236 
£lf
->
ªg_fûe_Â_cou¡
++;

237 
	`as£π
(!
ªg_fûe
->
Â_phªg
[
phªg
].
busy
);

238 
	`as£π
(!
ªg_fûe
->
Â_phªg
[
phªg
].
≥ndög
);

239  
phªg
;

240 
	}
}

244 
	$X86ThªadReque°XMMReg
(
X86Thªad
 *
£lf
)

246 
X86C‹e
 *
c‹e
 = 
£lf
->core;

247 
x86_ªg_fûe_t
 *
ªg_fûe
 = 
£lf
->reg_file;

248 
phªg
;

251 
	`as£π
(
ªg_fûe
->
xmm_‰ì_phªg_cou¡
 > 0);

252 
phªg
 = 
ªg_fûe
->
xmm_‰ì_phªg
[ªg_fûe->
xmm_‰ì_phªg_cou¡
 - 1];

253 
ªg_fûe
->
xmm_‰ì_phªg_cou¡
--;

254 
c‹e
->
ªg_fûe_xmm_cou¡
++;

255 
£lf
->
ªg_fûe_xmm_cou¡
++;

256 
	`as£π
(!
ªg_fûe
->
xmm_phªg
[
phªg
].
busy
);

257 
	`as£π
(!
ªg_fûe
->
xmm_phªg
[
phªg
].
≥ndög
);

258  
phªg
;

259 
	}
}

262 
	$X86ThªadRíameU›
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
)

264 
dï
;

265 
l‹eg
, 
°ªg
, 
phªg
, 
›hªg
;

266 
Êag_phªg
, 
Êag_cou¡
;

267 
x86_ªg_fûe_t
 *
ªg_fûe
 = 
£lf
->reg_file;

270 
	`as£π
(
u›
->
thªad
 =
£lf
);

273 i‡(
u›
->
uö°
->
›code
 =
x86_uö°_Â_p›
)

276 
ªg_fûe
->
Â_t›_of_°ack
 = (reg_file->fp_top_of_stack + 1) % 8;

278 i‡(
u›
->
uö°
->
›code
 =
x86_uö°_Â_push
)

281 
ªg_fûe
->
Â_t›_of_°ack
 = (reg_file->fp_top_of_stack + 7) % 8;

285 
dï
 = 0; dï < 
X86_UINST_MAX_IDEPS
; dep++)

287 
l‹eg
 = 
u›
->
uö°
->
idï
[
dï
];

288 i‡(
	`X86_DEP_IS_INT_REG
(
l‹eg
))

290 
phªg
 = 
ªg_fûe
->
öt_øt
[
l‹eg
 - 
x86_dï_öt_fú°
];

291 
u›
->
ph_idï
[
dï
] = 
phªg
;

292 
£lf
->
øt_öt_ªads
++;

294 i‡(
	`X86_DEP_IS_FP_REG
(
l‹eg
))

297 
°ªg
 = (
l‹eg
 - 
x86_dï_Â_fú°
 + 
ªg_fûe
->
Â_t›_of_°ack
) % 8 + x86_dep_fp_first;

298 
	`as£π
(
	`X86_DEP_IS_FP_REG
(
°ªg
));

301 
phªg
 = 
ªg_fûe
->
Â_øt
[
°ªg
 - 
x86_dï_Â_fú°
];

302 
u›
->
ph_idï
[
dï
] = 
phªg
;

303 
£lf
->
øt_Â_ªads
++;

305 i‡(
	`X86_DEP_IS_XMM_REG
(
l‹eg
))

307 
phªg
 = 
ªg_fûe
->
xmm_øt
[
l‹eg
 - 
x86_dï_xmm_fú°
];

308 
u›
->
ph_idï
[
dï
] = 
phªg
;

309 
£lf
->
øt_xmm_ªads
++;

313 
u›
->
ph_idï
[
dï
] = -1;

318 
Êag_phªg
 = -1;

319 
Êag_cou¡
 = 0;

320 
dï
 = 0; dï < 
X86_UINST_MAX_ODEPS
; dep++)

322 
l‹eg
 = 
u›
->
uö°
->
odï
[
dï
];

323 i‡(
	`X86_DEP_IS_FLAG
(
l‹eg
))

326 
Êag_cou¡
++;

328 i‡(
	`X86_DEP_IS_INT_REG
(
l‹eg
))

331 
phªg
 = 
	`X86ThªadReque°I¡Reg
(
£lf
);

332 
ªg_fûe
->
öt_phªg
[
phªg
].
busy
++;

333 
ªg_fûe
->
öt_phªg
[
phªg
].
≥ndög
 = 1;

334 
›hªg
 = 
ªg_fûe
->
öt_øt
[
l‹eg
 - 
x86_dï_öt_fú°
];

335 i‡(
Êag_phªg
 < 0)

336 
Êag_phªg
 = 
phªg
;

339 
u›
->
ph_odï
[
dï
] = 
phªg
;

340 
u›
->
ph_oodï
[
dï
] = 
›hªg
;

341 
ªg_fûe
->
öt_øt
[
l‹eg
 - 
x86_dï_öt_fú°
] = 
phªg
;

342 
£lf
->
øt_öt_wrôes
++;

344 i‡(
	`X86_DEP_IS_FP_REG
(
l‹eg
))

347 
°ªg
 = (
l‹eg
 - 
x86_dï_Â_fú°
 + 
ªg_fûe
->
Â_t›_of_°ack
) % 8 + x86_dep_fp_first;

348 
	`as£π
(
	`X86_DEP_IS_FP_REG
(
°ªg
));

351 
phªg
 = 
	`X86ThªadReque°FPReg
(
£lf
);

352 
ªg_fûe
->
Â_phªg
[
phªg
].
busy
++;

353 
ªg_fûe
->
Â_phªg
[
phªg
].
≥ndög
 = 1;

354 
›hªg
 = 
ªg_fûe
->
Â_øt
[
°ªg
 - 
x86_dï_Â_fú°
];

357 
u›
->
ph_odï
[
dï
] = 
phªg
;

358 
u›
->
ph_oodï
[
dï
] = 
›hªg
;

359 
ªg_fûe
->
Â_øt
[
°ªg
 - 
x86_dï_Â_fú°
] = 
phªg
;

360 
£lf
->
øt_Â_wrôes
++;

362 i‡(
	`X86_DEP_IS_XMM_REG
(
l‹eg
))

365 
phªg
 = 
	`X86ThªadReque°XMMReg
(
£lf
);

366 
ªg_fûe
->
xmm_phªg
[
phªg
].
busy
++;

367 
ªg_fûe
->
xmm_phªg
[
phªg
].
≥ndög
 = 1;

368 
›hªg
 = 
ªg_fûe
->
xmm_øt
[
l‹eg
 - 
x86_dï_xmm_fú°
];

371 
u›
->
ph_odï
[
dï
] = 
phªg
;

372 
u›
->
ph_oodï
[
dï
] = 
›hªg
;

373 
ªg_fûe
->
xmm_øt
[
l‹eg
 - 
x86_dï_xmm_fú°
] = 
phªg
;

374 
£lf
->
øt_xmm_wrôes
++;

379 
u›
->
ph_odï
[
dï
] = -1;

380 
u›
->
ph_oodï
[
dï
] = -1;

385 i‡(
Êag_cou¡
 > 0) {

386 i‡(
Êag_phªg
 < 0)

387 
Êag_phªg
 = 
	`X86ThªadReque°I¡Reg
(
£lf
);

388 
dï
 = 0; dï < 
X86_UINST_MAX_ODEPS
; dep++)

390 
l‹eg
 = 
u›
->
uö°
->
odï
[
dï
];

391 i‡(!
	`X86_DEP_IS_FLAG
(
l‹eg
))

393 
ªg_fûe
->
öt_phªg
[
Êag_phªg
].
busy
++;

394 
ªg_fûe
->
öt_phªg
[
Êag_phªg
].
≥ndög
 = 1;

395 
›hªg
 = 
ªg_fûe
->
öt_øt
[
l‹eg
 - 
x86_dï_öt_fú°
];

396 
u›
->
ph_oodï
[
dï
] = 
›hªg
;

397 
u›
->
ph_odï
[
dï
] = 
Êag_phªg
;

398 
ªg_fûe
->
öt_øt
[
l‹eg
 - 
x86_dï_öt_fú°
] = 
Êag_phªg
;

401 
	}
}

405 
	$X86ThªadIsU›Ródy
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
)

407 
x86_ªg_fûe_t
 *
ªg_fûe
 = 
£lf
->reg_file;

409 
l‹eg
;

410 
phªg
;

411 
dï
;

413 
	`as£π
(
u›
->
thªad
 =
£lf
);

414 
dï
 = 0; dï < 
X86_UINST_MAX_IDEPS
; dep++)

416 
l‹eg
 = 
u›
->
uö°
->
idï
[
dï
];

417 
phªg
 = 
u›
->
ph_idï
[
dï
];

418 i‡(
	`X86_DEP_IS_INT_REG
(
l‹eg
Ë&& 
ªg_fûe
->
öt_phªg
[
phªg
].
≥ndög
)

420 i‡(
	`X86_DEP_IS_FP_REG
(
l‹eg
Ë&& 
ªg_fûe
->
Â_phªg
[
phªg
].
≥ndög
)

422 i‡(
	`X86_DEP_IS_XMM_REG
(
l‹eg
Ë&& 
ªg_fûe
->
xmm_phªg
[
phªg
].
≥ndög
)

426 
	}
}

433 
	$X86ThªadIsU›Li°Ródy
(
X86Thªad
 *
£lf
, 
löked_li°_t
 *
u›_li°
)

435 
x86_u›_t
 *
u›
;

437 
	`LINKED_LIST_FOR_EACH
(
u›_li°
)

439 
u›
 = 
	`löked_li°_gë
(
u›_li°
);

440 i‡(
u›
->
ªady
 || !
	`X86ThªadIsU›Ródy
(
£lf
, uop))

442 
u›
->
ªady
 = 1;

444 
	}
}

447 
	$X86ThªadWrôeU›
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
)

449 
x86_ªg_fûe_t
 *
ªg_fûe
 = 
£lf
->reg_file;

451 
dï
;

452 
l‹eg
;

453 
phªg
;

455 
	`as£π
(
u›
->
thªad
 =
£lf
);

456 
dï
 = 0; dï < 
X86_UINST_MAX_ODEPS
; dep++)

458 
l‹eg
 = 
u›
->
uö°
->
odï
[
dï
];

459 
phªg
 = 
u›
->
ph_odï
[
dï
];

460 i‡(
	`X86_DEP_IS_INT_REG
(
l‹eg
))

461 
ªg_fûe
->
öt_phªg
[
phªg
].
≥ndög
 = 0;

462 i‡(
	`X86_DEP_IS_FP_REG
(
l‹eg
))

463 
ªg_fûe
->
Â_phªg
[
phªg
].
≥ndög
 = 0;

464 i‡(
	`X86_DEP_IS_XMM_REG
(
l‹eg
))

465 
ªg_fûe
->
xmm_phªg
[
phªg
].
≥ndög
 = 0;

467 
	}
}

470 
	$X86ThªadUndoU›
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
)

472 
X86C‹e
 *
c‹e
 = 
£lf
->core;

473 
x86_ªg_fûe_t
 *
ªg_fûe
 = 
£lf
->reg_file;

475 
dï
;

476 
l‹eg
;

477 
°ªg
;

478 
phªg
;

479 
›hªg
;

483 
	`as£π
(
u›
->
thªad
 =
£lf
);

484 
	`as£π
(
u›
->
•ecmode
);

485 
dï
 = 
X86_UINST_MAX_ODEPS
 - 1; dep >= 0; dep--)

487 
l‹eg
 = 
u›
->
uö°
->
odï
[
dï
];

488 
phªg
 = 
u›
->
ph_odï
[
dï
];

489 
›hªg
 = 
u›
->
ph_oodï
[
dï
];

490 i‡(
	`X86_DEP_IS_INT_REG
(
l‹eg
))

493 
	`as£π
(
ªg_fûe
->
öt_phªg
[
phªg
].
busy
 > 0);

494 
	`as£π
(!
ªg_fûe
->
öt_phªg
[
phªg
].
≥ndög
);

495 
ªg_fûe
->
öt_phªg
[
phªg
].
busy
--;

496 i‡(!
ªg_fûe
->
öt_phªg
[
phªg
].
busy
)

498 
	`as£π
(
ªg_fûe
->
öt_‰ì_phªg_cou¡
 < 
x86_ªg_fûe_öt_loˇl_size
);

499 
	`as£π
(
c‹e
->
ªg_fûe_öt_cou¡
 > 0 && 
£lf
->reg_file_int_count > 0);

500 
ªg_fûe
->
öt_‰ì_phªg
[ªg_fûe->
öt_‰ì_phªg_cou¡
] = 
phªg
;

501 
ªg_fûe
->
öt_‰ì_phªg_cou¡
++;

502 
c‹e
->
ªg_fûe_öt_cou¡
--;

503 
£lf
->
ªg_fûe_öt_cou¡
--;

507 
ªg_fûe
->
öt_øt
[
l‹eg
 - 
x86_dï_öt_fú°
] = 
›hªg
;

508 
	`as£π
(
ªg_fûe
->
öt_phªg
[
›hªg
].
busy
);

510 i‡(
	`X86_DEP_IS_FP_REG
(
l‹eg
))

513 
°ªg
 = (
l‹eg
 - 
x86_dï_Â_fú°
 + 
ªg_fûe
->
Â_t›_of_°ack
) % 8 + x86_dep_fp_first;

514 
	`as£π
(
	`X86_DEP_IS_FP_REG
(
°ªg
));

517 
	`as£π
(
ªg_fûe
->
Â_phªg
[
phªg
].
busy
 > 0);

518 
	`as£π
(!
ªg_fûe
->
Â_phªg
[
phªg
].
≥ndög
);

519 
ªg_fûe
->
Â_phªg
[
phªg
].
busy
--;

520 i‡(!
ªg_fûe
->
Â_phªg
[
phªg
].
busy
)

522 
	`as£π
(
ªg_fûe
->
Â_‰ì_phªg_cou¡
 < 
x86_ªg_fûe_Â_loˇl_size
);

523 
	`as£π
(
c‹e
->
ªg_fûe_Â_cou¡
 > 0 && 
£lf
->reg_file_fp_count > 0);

524 
ªg_fûe
->
Â_‰ì_phªg
[ªg_fûe->
Â_‰ì_phªg_cou¡
] = 
phªg
;

525 
ªg_fûe
->
Â_‰ì_phªg_cou¡
++;

526 
c‹e
->
ªg_fûe_Â_cou¡
--;

527 
£lf
->
ªg_fûe_Â_cou¡
--;

531 
ªg_fûe
->
Â_øt
[
°ªg
 - 
x86_dï_Â_fú°
] = 
›hªg
;

532 
	`as£π
(
ªg_fûe
->
Â_phªg
[
›hªg
].
busy
);

534 i‡(
	`X86_DEP_IS_XMM_REG
(
l‹eg
))

537 
	`as£π
(
ªg_fûe
->
xmm_phªg
[
phªg
].
busy
 > 0);

538 
	`as£π
(!
ªg_fûe
->
xmm_phªg
[
phªg
].
≥ndög
);

539 
ªg_fûe
->
xmm_phªg
[
phªg
].
busy
--;

540 i‡(!
ªg_fûe
->
xmm_phªg
[
phªg
].
busy
)

542 
	`as£π
(
ªg_fûe
->
xmm_‰ì_phªg_cou¡
 < 
x86_ªg_fûe_xmm_loˇl_size
);

543 
	`as£π
(
c‹e
->
ªg_fûe_xmm_cou¡
 > 0 && 
£lf
->reg_file_xmm_count > 0);

544 
ªg_fûe
->
xmm_‰ì_phªg
[ªg_fûe->
xmm_‰ì_phªg_cou¡
] = 
phªg
;

545 
ªg_fûe
->
xmm_‰ì_phªg_cou¡
++;

546 
c‹e
->
ªg_fûe_xmm_cou¡
--;

547 
£lf
->
ªg_fûe_xmm_cou¡
--;

551 
ªg_fûe
->
xmm_øt
[
l‹eg
 - 
x86_dï_xmm_fú°
] = 
›hªg
;

552 
	`as£π
(
ªg_fûe
->
xmm_phªg
[
›hªg
].
busy
);

557 
	`as£π
(
phªg
 == -1);

558 
	`as£π
(
›hªg
 == -1);

563 i‡(
u›
->
uö°
->
›code
 =
x86_uö°_Â_p›
)

566 
ªg_fûe
->
Â_t›_of_°ack
 = (reg_file->fp_top_of_stack + 7) % 8;

568 i‡(
u›
->
uö°
->
›code
 =
x86_uö°_Â_push
)

571 
ªg_fûe
->
Â_t›_of_°ack
 = (reg_file->fp_top_of_stack + 1) % 8;

573 
	}
}

576 
	$X86ThªadCommôU›
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
)

578 
X86C‹e
 *
c‹e
 = 
£lf
->core;

580 
x86_ªg_fûe_t
 *
ªg_fûe
 = 
£lf
->reg_file;

582 
dï
, 
l‹eg
, 
phªg
, 
›hªg
;

584 
	`as£π
(!
u›
->
•ecmode
);

585 
	`as£π
(
u›
->
thªad
 =
£lf
);

586 
dï
 = 0; dï < 
X86_UINST_MAX_ODEPS
; dep++)

588 
l‹eg
 = 
u›
->
uö°
->
odï
[
dï
];

589 
phªg
 = 
u›
->
ph_odï
[
dï
];

590 
›hªg
 = 
u›
->
ph_oodï
[
dï
];

592 i‡(
	`X86_DEP_IS_INT_REG
(
l‹eg
))

595 
	`as£π
(
ªg_fûe
->
öt_phªg
[
›hªg
].
busy
 > 0);

596 
ªg_fûe
->
öt_phªg
[
›hªg
].
busy
--;

597 i‡(!
ªg_fûe
->
öt_phªg
[
›hªg
].
busy
)

599 
	`as£π
(!
ªg_fûe
->
öt_phªg
[
›hªg
].
≥ndög
);

600 
	`as£π
(
ªg_fûe
->
öt_‰ì_phªg_cou¡
 < 
x86_ªg_fûe_öt_loˇl_size
);

601 
	`as£π
(
c‹e
->
ªg_fûe_öt_cou¡
 > 0 && 
£lf
->reg_file_int_count > 0);

602 
ªg_fûe
->
öt_‰ì_phªg
[ªg_fûe->
öt_‰ì_phªg_cou¡
] = 
›hªg
;

603 
ªg_fûe
->
öt_‰ì_phªg_cou¡
++;

604 
c‹e
->
ªg_fûe_öt_cou¡
--;

605 
£lf
->
ªg_fûe_öt_cou¡
--;

608 i‡(
	`X86_DEP_IS_FP_REG
(
l‹eg
))

611 
	`as£π
(
ªg_fûe
->
Â_phªg
[
›hªg
].
busy
 > 0);

612 
ªg_fûe
->
Â_phªg
[
›hªg
].
busy
--;

613 i‡(!
ªg_fûe
->
Â_phªg
[
›hªg
].
busy
)

615 
	`as£π
(!
ªg_fûe
->
Â_phªg
[
›hªg
].
≥ndög
);

616 
	`as£π
(
ªg_fûe
->
Â_‰ì_phªg_cou¡
 < 
x86_ªg_fûe_Â_loˇl_size
);

617 
	`as£π
(
c‹e
->
ªg_fûe_Â_cou¡
 > 0 && 
£lf
->reg_file_fp_count > 0);

618 
ªg_fûe
->
Â_‰ì_phªg
[ªg_fûe->
Â_‰ì_phªg_cou¡
] = 
›hªg
;

619 
ªg_fûe
->
Â_‰ì_phªg_cou¡
++;

620 
c‹e
->
ªg_fûe_Â_cou¡
--;

621 
£lf
->
ªg_fûe_Â_cou¡
--;

624 i‡(
	`X86_DEP_IS_XMM_REG
(
l‹eg
))

627 
	`as£π
(
ªg_fûe
->
xmm_phªg
[
›hªg
].
busy
 > 0);

628 
ªg_fûe
->
xmm_phªg
[
›hªg
].
busy
--;

629 i‡(!
ªg_fûe
->
xmm_phªg
[
›hªg
].
busy
)

631 
	`as£π
(!
ªg_fûe
->
xmm_phªg
[
›hªg
].
≥ndög
);

632 
	`as£π
(
ªg_fûe
->
xmm_‰ì_phªg_cou¡
 < 
x86_ªg_fûe_xmm_loˇl_size
);

633 
	`as£π
(
c‹e
->
ªg_fûe_xmm_cou¡
 > 0 && 
£lf
->reg_file_xmm_count > 0);

634 
ªg_fûe
->
xmm_‰ì_phªg
[ªg_fûe->
xmm_‰ì_phªg_cou¡
] = 
›hªg
;

635 
ªg_fûe
->
xmm_‰ì_phªg_cou¡
++;

636 
c‹e
->
ªg_fûe_xmm_cou¡
--;

637 
£lf
->
ªg_fûe_xmm_cou¡
--;

643 
	`as£π
(
phªg
 == -1);

644 
	`as£π
(
›hªg
 == -1);

647 
	}
}

650 
	$X86ThªadCheckRegFûe
(
X86Thªad
 *
£lf
)

652 
x86_ªg_fûe_t
 *
ªg_fûe
 = 
£lf
->reg_file;

653 
x86_u›_t
 *
u›
;

655 
l‹eg
;

656 
phªg
;

657 
›hªg
;

658 
dï
;

659 
i
;

662 
i
 = 0; i < 
ªg_fûe
->
öt_‰ì_phªg_cou¡
; i++)

664 
phªg
 = 
ªg_fûe
->
öt_‰ì_phªg
[
i
];

665 
	`as£π
(!
ªg_fûe
->
öt_phªg
[
phªg
].
busy
);

666 
	`as£π
(!
ªg_fûe
->
öt_phªg
[
phªg
].
≥ndög
);

668 
i
 = 0; i < 
ªg_fûe
->
Â_‰ì_phªg_cou¡
; i++)

670 
phªg
 = 
ªg_fûe
->
Â_‰ì_phªg
[
i
];

671 
	`as£π
(!
ªg_fûe
->
Â_phªg
[
phªg
].
busy
);

672 
	`as£π
(!
ªg_fûe
->
Â_phªg
[
phªg
].
≥ndög
);

674 
i
 = 0; i < 
ªg_fûe
->
xmm_‰ì_phªg_cou¡
; i++)

676 
phªg
 = 
ªg_fûe
->
xmm_‰ì_phªg
[
i
];

677 
	`as£π
(!
ªg_fûe
->
xmm_phªg
[
phªg
].
busy
);

678 
	`as£π
(!
ªg_fûe
->
xmm_phªg
[
phªg
].
≥ndög
);

682 
l‹eg
 = 
x86_dï_öt_fú°
;Ü‹eg <
x86_dï_öt_œ°
;Üoreg++)

684 
phªg
 = 
ªg_fûe
->
öt_øt
[
l‹eg
 - 
x86_dï_öt_fú°
];

685 
	`as£π
(
ªg_fûe
->
öt_phªg
[
phªg
].
busy
);

687 
l‹eg
 = 
x86_dï_Â_fú°
;Ü‹eg <
x86_dï_Â_œ°
;Üoreg++)

689 
phªg
 = 
ªg_fûe
->
Â_øt
[
l‹eg
 - 
x86_dï_Â_fú°
];

690 
	`as£π
(
ªg_fûe
->
Â_phªg
[
phªg
].
busy
);

692 
l‹eg
 = 
x86_dï_xmm_fú°
;Ü‹eg <
x86_dï_xmm_œ°
;Üoreg++)

694 
phªg
 = 
ªg_fûe
->
xmm_øt
[
l‹eg
 - 
x86_dï_xmm_fú°
];

695 
	`as£π
(
ªg_fûe
->
xmm_phªg
[
phªg
].
busy
);

700 
i
 = 0; i < 
£lf
->
rob_cou¡
; i++)

702 
u›
 = 
	`X86GëROBE¡ry
(
£lf
, 
i
);

703 
	`as£π
(
u›
);

704 
dï
 = 0; dï < 
X86_UINST_MAX_ODEPS
; dep++)

706 
l‹eg
 = 
u›
->
uö°
->
odï
[
dï
];

707 
phªg
 = 
u›
->
ph_odï
[
dï
];

708 
›hªg
 = 
u›
->
ph_oodï
[
dï
];

709 i‡(
	`X86_DEP_IS_INT_REG
(
l‹eg
))

711 
	`as£π
(
ªg_fûe
->
öt_phªg
[
phªg
].
busy
);

712 
	`as£π
(
ªg_fûe
->
öt_phªg
[
›hªg
].
busy
);

714 i‡(
	`X86_DEP_IS_FP_REG
(
l‹eg
))

716 
	`as£π
(
ªg_fûe
->
Â_phªg
[
phªg
].
busy
);

717 
	`as£π
(
ªg_fûe
->
Â_phªg
[
›hªg
].
busy
);

719 i‡(
	`X86_DEP_IS_XMM_REG
(
l‹eg
))

721 
	`as£π
(
ªg_fûe
->
xmm_phªg
[
phªg
].
busy
);

722 
	`as£π
(
ªg_fûe
->
xmm_phªg
[
›hªg
].
busy
);

726 
	`as£π
(
phªg
 == -1);

727 
	`as£π
(
›hªg
 == -1);

731 
	}
}

739 
x86_ªg_fûe_t
 *
	$x86_ªg_fûe_¸óã
(
öt_size
, 
Â_size
, 
xmm_size
)

741 
x86_ªg_fûe_t
 *
ªg_fûe
;

742 
phªg
;

745 
ªg_fûe
 = 
	`xˇŒoc
(1, (
x86_ªg_fûe_t
));

746 
ªg_fûe
->
öt_phªg_cou¡
 = 
öt_size
;

747 
ªg_fûe
->
öt_phªg
 = 
	`xˇŒoc
(
öt_size
, (
x86_phªg_t
));

750 
ªg_fûe
->
öt_‰ì_phªg_cou¡
 = 
öt_size
;

751 
ªg_fûe
->
öt_‰ì_phªg
 = 
	`xˇŒoc
(
öt_size
, ());

752 
phªg
 = 0;Öhªg < 
öt_size
;Öhreg++)

753 
ªg_fûe
->
öt_‰ì_phªg
[
phªg
] =Öhreg;

756 
ªg_fûe
->
Â_phªg_cou¡
 = 
Â_size
;

757 
ªg_fûe
->
Â_phªg
 = 
	`xˇŒoc
(
Â_size
, (
x86_phªg_t
));

760 
ªg_fûe
->
Â_‰ì_phªg_cou¡
 = 
Â_size
;

761 
ªg_fûe
->
Â_‰ì_phªg
 = 
	`xˇŒoc
(
Â_size
, ());

764 
phªg
 = 0;Öhªg < 
Â_size
;Öhreg++)

765 
ªg_fûe
->
Â_‰ì_phªg
[
phªg
] =Öhreg;

768 
ªg_fûe
->
xmm_phªg_cou¡
 = 
xmm_size
;

769 
ªg_fûe
->
xmm_phªg
 = 
	`xˇŒoc
(
xmm_size
, (
x86_phªg_t
));

772 
ªg_fûe
->
xmm_‰ì_phªg_cou¡
 = 
xmm_size
;

773 
ªg_fûe
->
xmm_‰ì_phªg
 = 
	`xˇŒoc
(
xmm_size
, ());

776 
phªg
 = 0;Öhªg < 
xmm_size
;Öhreg++)

777 
ªg_fûe
->
xmm_‰ì_phªg
[
phªg
] =Öhreg;

780  
ªg_fûe
;

781 
	}
}

784 
	$x86_ªg_fûe_‰ì
(
x86_ªg_fûe_t
 *
ªg_fûe
)

786 
	`‰ì
(
ªg_fûe
->
öt_phªg
);

787 
	`‰ì
(
ªg_fûe
->
öt_‰ì_phªg
);

788 
	`‰ì
(
ªg_fûe
->
Â_phªg
);

789 
	`‰ì
(
ªg_fûe
->
Â_‰ì_phªg
);

790 
	`‰ì
(
ªg_fûe
->
xmm_phªg
);

791 
	`‰ì
(
ªg_fûe
->
xmm_‰ì_phªg
);

792 
	`‰ì
(
ªg_fûe
);

793 
	}
}

802 *
	gx86_ªg_fûe_köd_m≠
[] = { "Shared", "Private" };

803 
x86_ªg_fûe_köd_t
 
	gx86_ªg_fûe_köd
 = 
x86_ªg_fûe_köd_¥iv©e
;

804 
	gx86_ªg_fûe_öt_size
 = 80;

805 
	gx86_ªg_fûe_Â_size
 = 40;

806 
	gx86_ªg_fûe_xmm_size
 = 40;

809 
	gx86_ªg_fûe_öt_loˇl_size
;

810 
	gx86_ªg_fûe_Â_loˇl_size
;

811 
	gx86_ªg_fûe_xmm_loˇl_size
;

814 
	$X86RódRegFûeC⁄fig
(
c⁄fig_t
 *
c⁄fig
)

816 *
£˘i⁄
;

818 
£˘i⁄
 = "Queues";

820 
x86_ªg_fûe_köd
 = 
	`c⁄fig_ªad_íum
(
c⁄fig
, 
£˘i⁄
, "RfKind",

821 
x86_ªg_fûe_köd_¥iv©e
, 
x86_ªg_fûe_köd_m≠
, 2);

822 
x86_ªg_fûe_öt_size
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "RfIntSize", 80);

823 
x86_ªg_fûe_Â_size
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "RfFpSize", 40);

824 
x86_ªg_fûe_xmm_size
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "RfXmmSize", 40);

826 i‡(
x86_ªg_fûe_öt_size
 < 
X86_REG_FILE_MIN_INT_SIZE
)

827 
	`Áèl
("rf_öt_sizêmu° bê©Üó° %d", 
X86_REG_FILE_MIN_INT_SIZE
);

828 i‡(
x86_ªg_fûe_Â_size
 < 
X86_REG_FILE_MIN_FP_SIZE
)

829 
	`Áèl
("rf_Â_sizêmu° bê©Üó° %d", 
X86_REG_FILE_MIN_FP_SIZE
);

830 i‡(
x86_ªg_fûe_xmm_size
 < 
X86_REG_FILE_MIN_XMM_SIZE
)

831 
	`Áèl
("rf_xmm_sizêmu° bê©Üó° %d", 
X86_REG_FILE_MIN_XMM_SIZE
);

833 i‡(
x86_ªg_fûe_köd
 =
x86_ªg_fûe_köd_¥iv©e
)

835 
x86_ªg_fûe_öt_loˇl_size
 = 
x86_ªg_fûe_öt_size
;

836 
x86_ªg_fûe_Â_loˇl_size
 = 
x86_ªg_fûe_Â_size
;

837 
x86_ªg_fûe_xmm_loˇl_size
 = 
x86_ªg_fûe_xmm_size
;

841 
x86_ªg_fûe_öt_loˇl_size
 = 
x86_ªg_fûe_öt_size
 * 
x86_˝u_num_thªads
;

842 
x86_ªg_fûe_Â_loˇl_size
 = 
x86_ªg_fûe_Â_size
 * 
x86_˝u_num_thªads
;

843 
x86_ªg_fûe_xmm_loˇl_size
 = 
x86_ªg_fûe_xmm_size
 * 
x86_˝u_num_thªads
;

845 
	}
}

	@reg-file.h

20 #i‚de‡
X86_ARCH_TIMING_REG_FILE_H


21 
	#X86_ARCH_TIMING_REG_FILE_H


	)

23 
	~<lib/utû/˛ass.h
>

25 
	~"u›.h
"

29 
	gc⁄fig_t
;

30 
	gx86_u›_t
;

37 
	#X86_REG_FILE_MIN_INT_SIZE
 (
x86_dï_öt_cou¡
 + 
X86_UINST_MAX_ODEPS
)

	)

38 
	#X86_REG_FILE_MIN_FP_SIZE
 (
x86_dï_Â_cou¡
 + 
X86_UINST_MAX_ODEPS
)

	)

39 
	#X86_REG_FILE_MIN_XMM_SIZE
 (
x86_dï_xmm_cou¡
 + 
X86_UINST_MAX_ODEPS
)

	)

41 *
x86_ªg_fûe_köd_m≠
[];

42 
	ex86_ªg_fûe_köd_t


44 
x86_ªg_fûe_köd_sh¨ed
 = 0,

45 
x86_ªg_fûe_köd_¥iv©e


46 } 
x86_ªg_fûe_köd
;

48 
x86_ªg_fûe_öt_size
;

49 
x86_ªg_fûe_Â_size
;

50 
x86_ªg_fûe_xmm_size
;

52 
x86_ªg_fûe_öt_loˇl_size
;

53 
x86_ªg_fûe_Â_loˇl_size
;

54 
x86_ªg_fûe_xmm_loˇl_size
;

63 
X86RódRegFûeC⁄fig
(
c⁄fig_t
 *
c⁄fig
);

71 
X86ThªadInôRegFûe
(
X86Thªad
 *
£lf
);

72 
X86ThªadFªeRegFûe
(
X86Thªad
 *
£lf
);

73 
X86ThªadDumpRegFûe
(
X86Thªad
 *
£lf
, 
FILE
 *
f
);

75 
X86ThªadReque°I¡Reg
(
X86Thªad
 *
£lf
);

76 
X86ThªadReque°FPReg
(
X86Thªad
 *
£lf
);

77 
X86ThªadReque°XMMReg
(
X86Thªad
 *
£lf
);

79 
X86ThªadC™RíameU›
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
);

80 
X86ThªadRíameU›
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
);

82 
X86ThªadIsU›Ródy
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
);

83 
X86ThªadIsU›Li°Ródy
(
X86Thªad
 *
£lf
, 
löked_li°_t
 *
u›_li°
);

85 
X86ThªadWrôeU›
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
);

86 
X86ThªadUndoU›
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
);

87 
X86ThªadCommôU›
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
);

89 
X86ThªadCheckRegFûe
(
X86Thªad
 *
£lf
);

98 
	sx86_phªg_t


100 
	m≥ndög
;

101 
	mbusy
;

104 
	sx86_ªg_fûe_t


107 
	möt_øt
[
x86_dï_öt_cou¡
];

108 
x86_phªg_t
 *
	möt_phªg
;

109 
	möt_phªg_cou¡
;

110 *
	möt_‰ì_phªg
;

111 
	möt_‰ì_phªg_cou¡
;

114 
	mÂ_t›_of_°ack
;

115 
	mÂ_øt
[
x86_dï_Â_cou¡
];

116 
x86_phªg_t
 *
	mÂ_phªg
;

117 
	mÂ_phªg_cou¡
;

118 *
	mÂ_‰ì_phªg
;

119 
	mÂ_‰ì_phªg_cou¡
;

122 
	mxmm_øt
[
x86_dï_xmm_cou¡
];

123 
x86_phªg_t
 *
	mxmm_phªg
;

124 
	mxmm_phªg_cou¡
;

125 *
	mxmm_‰ì_phªg
;

126 
	mxmm_‰ì_phªg_cou¡
;

129 
x86_ªg_fûe_t
 *
x86_ªg_fûe_¸óã
(
öt_size
, 
Â_size
, 
xmm_size
);

130 
x86_ªg_fûe_‰ì
(
x86_ªg_fûe_t
 *
ªg_fûe
);

	@rob.c

21 
	~<lib/utû/debug.h
>

22 
	~<lib/utû/li°.h
>

24 
	~"c‹e.h
"

25 
	~"˝u.h
"

26 
	~"rob.h
"

27 
	~"u›.h
"

28 
	~"thªad.h
"

34 *
	gx86_rob_köd_m≠
[] = { "Private", "Shared" };

35 
x86_rob_köd_t
 
	gx86_rob_köd
;

36 
	gx86_rob_size
;

43 
	gx86_rob_tŸÆ_size
 = 0;

52 
	$X86C‹eInôROB
(
X86C‹e
 *
£lf
)

54 
X86Thªad
 *
thªad
;

55 
i
;

57 
x86_rob_köd
)

60 
x86_rob_köd_¥iv©e
:

63 
i
 = 0; i < 
x86_˝u_num_thªads
; i++)

65 
thªad
 = 
£lf
->
thªads
[
i
];

66 
thªad
->
rob_À·_bound
 = 
i
 * 
x86_rob_size
;

67 
thªad
->
rob_right_bound
 = (
i
 + 1Ë* 
x86_rob_size
 - 1;

68 
thªad
->
rob_hód
 =Åhªad->
rob_À·_bound
;

69 
thªad
->
rob_èû
 =Åhªad->
rob_À·_bound
;

74 
x86_rob_köd_sh¨ed
:

79 
x86_rob_tŸÆ_size
 = 
x86_rob_size
 * 
x86_˝u_num_thªads
;

80 
£lf
->
rob
 = 
	`li°_¸óã_wôh_size
(
x86_rob_tŸÆ_size
);

81 
i
 = 0; i < 
x86_rob_tŸÆ_size
; i++)

82 
	`li°_add
(
£lf
->
rob
, 
NULL
);

83 
	}
}

86 
	$X86C‹eFªeROB
(
X86C‹e
 *
£lf
)

88 
i
;

89 
x86_u›_t
 *
u›
;

91 
	`as£π
(
	`li°_cou¡
(
£lf
->
rob
Ë=
x86_rob_tŸÆ_size
);

92 
i
 = 0; i < 
x86_rob_tŸÆ_size
; i++)

94 
u›
 = 
	`li°_gë
(
£lf
->
rob
, 
i
);

95 i‡(
u›
)

97 
u›
->
ö_rob
 = 0;

98 
	`x86_u›_‰ì_if_nŸ_queued
(
u›
);

101 
	`li°_‰ì
(
£lf
->
rob
);

102 
	}
}

105 
	$X86C‹eTrimROB
(
X86C‹e
 *
£lf
)

107 
idx
;

108 
x86_u›_t
 *
u›
;

111 
£lf
->
rob_cou¡
)

113 
u›
 = 
	`li°_gë
(
£lf
->
rob
, sñf->
rob_hód
);

114 i‡(
u›
)

116 
£lf
->
rob_hód
 = sñf->rob_hód =
x86_rob_tŸÆ_size
 - 1 ?

117 0 : 
£lf
->
rob_hód
 + 1;

118 
£lf
->
rob_cou¡
--;

122 
£lf
->
rob_cou¡
)

124 
idx
 = 
£lf
->
rob_èû
 ? sñf->rob_èû - 1 : 
x86_rob_tŸÆ_size
 - 1;

125 
u›
 = 
	`li°_gë
(
£lf
->
rob
, 
idx
);

126 i‡(
u›
)

128 
£lf
->
rob_èû
 = 
idx
;

129 
£lf
->
rob_cou¡
--;

131 
	}
}

134 
	$X86C‹eDumpROB
(
X86C‹e
 *
£lf
, 
FILE
 *
f
)

136 
X86Thªad
 *
thªad
;

137 
i
, 
j
;

138 
x86_u›_t
 *
u›
;

140 
x86_rob_köd
)

143 
x86_rob_köd_¥iv©e
:

145 
i
 = 0; i < 
x86_˝u_num_thªads
; i++)

147 
thªad
 = 
£lf
->
thªads
[
i
];

148 
	`Ârötf
(
f
, "Ñob forÅhread %s (entries %dÅo %d), count=%d, size=%d\n",

149 
thªad
->
«me
,Åhªad->
rob_À·_bound
,Åhªad->
rob_right_bound
,

150 
thªad
->
rob_cou¡
, 
x86_rob_size
);

151 
j
 = 
thªad
->
rob_À·_bound
; j <thªad->
rob_right_bound
; j++)

153 
u›
 = 
	`li°_gë
(
£lf
->
rob
, 
j
);

154 
	`Ârötf
(
f
, " %c%c ",

155 
j
 =
thªad
->
rob_hód
 ? 'H' : ' ',

156 
j
 =
thªad
->
rob_èû
 ? 'T' : ' ');

157 i‡(
u›
)

159 
	`x86_uö°_dump
(
u›
->
uö°
, 
f
);

160 
	`Ârötf
(
f
, "\n");

164 
	`Ârötf
(
f
, "-\n");

171 
x86_rob_köd_sh¨ed
:

173 
	`X86C‹eTrimROB
(
£lf
);

174 
j
 = 0; j < 
x86_rob_tŸÆ_size
; j++)

176 
u›
 = 
	`li°_gë
(
£lf
->
rob
, 
j
);

177 
	`Ârötf
(
f
, " %c%c ",

178 
j
 =
£lf
->
rob_hód
 ? 'H' : ' ',

179 
j
 =
£lf
->
rob_èû
 ? 'T' : ' ');

180 i‡(
u›
)

182 
	`x86_uö°_dump
(
u›
->
uö°
, 
f
);

183 
	`Ârötf
(
f
, "\n");

187 
	`Ârötf
(
f
, "-\n");

194 
	`∑nic
("%s: invÆid ROBÅy≥", 
__FUNCTION__
);

196 
	}
}

205 
	$X86ThªadC™DequeueFromROB
(
X86Thªad
 *
£lf
)

207 
X86C‹e
 *
c‹e
 = 
£lf
->core;

208 
x86_u›_t
 *
u›
;

210 
x86_rob_köd
)

212 
x86_rob_köd_¥iv©e
:

214 i‡(
£lf
->
rob_cou¡
 > 0)

219 
x86_rob_köd_sh¨ed
:

221 
	`X86C‹eTrimROB
(
c‹e
);

222 i‡(!
c‹e
->
rob_cou¡
)

225 
u›
 = 
	`li°_gë
(
c‹e
->
rob
, c‹e->
rob_hód
);

226 
	`as£π
(
	`x86_u›_exi°s
(
u›
));

227 i‡(
u›
->
thªad
 =
£lf
)

232 
	}
}

235 
x86_u›_t
 *
	$X86ThªadGëROBHód
(
X86Thªad
 *
£lf
)

237 
X86C‹e
 *
c‹e
 = 
£lf
->core;

238 
x86_u›_t
 *
u›
;

239 
idx
;

240 
i
;

242 
x86_rob_köd
)

244 
x86_rob_köd_¥iv©e
:

246 i‡(
£lf
->
rob_cou¡
 > 0)

248 
u›
 = 
	`li°_gë
(
c‹e
->
rob
, 
£lf
->
rob_hód
);

249  
u›
;

253 
x86_rob_köd_sh¨ed
:

255 
	`X86C‹eTrimROB
(
c‹e
);

256 i‡(!
£lf
->
rob_cou¡
)

257  
NULL
;

259 
i
 = 0; i < 
c‹e
->
rob_cou¡
; i++)

261 
idx
 = (
c‹e
->
rob_hód
 + 
i
Ë% 
x86_rob_tŸÆ_size
;

262 
u›
 = 
	`li°_gë
(
c‹e
->
rob
, 
idx
);

263 i‡(
u›
 && u›->
thªad
 =
£lf
)

264  
u›
;

266 
	`∑nic
("%s:Çÿhód found", 
__FUNCTION__
);

269  
NULL
;

270 
	}
}

273 
	$X86ThªadRemoveROBHód
(
X86Thªad
 *
£lf
)

275 
X86C‹e
 *
c‹e
 = 
£lf
->core;

276 
x86_u›_t
 *
u›
 = 
NULL
;

277 
idx
, 
i
;

279 
x86_rob_köd
)

281 
x86_rob_köd_¥iv©e
:

283 
	`as£π
(
£lf
->
rob_cou¡
 > 0);

284 
u›
 = 
	`li°_gë
(
c‹e
->
rob
, 
£lf
->
rob_hód
);

285 
	`as£π
(
	`x86_u›_exi°s
(
u›
));

286 
	`as£π
(
u›
->
thªad
 =
£lf
);

287 
	`li°_£t
(
c‹e
->
rob
, 
£lf
->
rob_hód
, 
NULL
);

288 
£lf
->
rob_hód
 = sñf->rob_hód =£lf->
rob_right_bound
 ?

289 
£lf
->
rob_À·_bound
 : sñf->
rob_hód
 + 1;

290 
£lf
->
rob_cou¡
--;

293 
x86_rob_köd_sh¨ed
:

294 
	`X86C‹eTrimROB
(
c‹e
);

295 
	`as£π
(
£lf
->
rob_cou¡
);

296 
i
 = 0; i < 
c‹e
->
rob_cou¡
; i++)

298 
idx
 = (
c‹e
->
rob_hód
 + 
i
Ë% 
x86_rob_tŸÆ_size
;

299 
u›
 = 
	`li°_gë
(
c‹e
->
rob
, 
idx
);

300 i‡(
u›
 && u›->
thªad
 =
£lf
)

302 
	`li°_£t
(
c‹e
->
rob
, 
idx
, 
NULL
);

303 
£lf
->
rob_cou¡
--;

311 
u›
->
ö_rob
 = 0;

312 
	`x86_u›_‰ì_if_nŸ_queued
(
u›
);

313 
	}
}

316 
x86_u›_t
 *
	$X86ThªadGëROBTaû
(
X86Thªad
 *
£lf
)

318 
X86C‹e
 *
c‹e
 = 
£lf
->core;

319 
x86_u›_t
 *
u›
;

320 
idx
, 
i
;

322 
x86_rob_köd
)

324 
x86_rob_köd_¥iv©e
:

326 i‡(
£lf
->
rob_cou¡
 > 0)

328 
idx
 = 
£lf
->
rob_èû
 =£lf->
rob_À·_bound
 ?

329 
£lf
->
rob_right_bound
 : sñf->
rob_èû
 - 1;

330 
u›
 = 
	`li°_gë
(
c‹e
->
rob
, 
idx
);

331  
u›
;

335 
x86_rob_köd_sh¨ed
:

337 
	`X86C‹eTrimROB
(
c‹e
);

338 i‡(!
£lf
->
rob_cou¡
)

339  
NULL
;

340 
i
 = 
c‹e
->
rob_cou¡
 - 1; i >= 0; i--)

342 
idx
 = (
c‹e
->
rob_hód
 + 
i
Ë% 
x86_rob_tŸÆ_size
;

343 
u›
 = 
	`li°_gë
(
c‹e
->
rob
, 
idx
);

344 i‡(
u›
 && u›->
thªad
 =
£lf
)

345  
u›
;

347 
	`∑nic
("rob_tail:ÇoÅail found");

350  
NULL
;

351 
	}
}

354 
x86_u›_t
 *
	$X86GëROBE¡ry
(
X86Thªad
 *
£lf
, 
ödex
)

356 
X86C‹e
 *
c‹e
 = 
£lf
->core;

357 
x86_u›_t
 *
u›
;

360 i‡(
ödex
 < 0 || index >
£lf
->
rob_cou¡
)

361  
NULL
;

363 
x86_rob_köd
)

365 
x86_rob_köd_¥iv©e
:

366 
ödex
 +
£lf
->
rob_hód
;

367 i‡(
ödex
 > 
£lf
->
rob_right_bound
)

368 
ödex
 = index - 
£lf
->
rob_right_bound
 + sñf->
rob_À·_bound
 - 1;

369 
u›
 = 
	`li°_gë
(
c‹e
->
rob
, 
ödex
);

370 
	`as£π
(
u›
);

371  
u›
;

373 
x86_rob_köd_sh¨ed
:

374 
	`X86C‹eTrimROB
(
c‹e
);

375 
ödex
 = (
c‹e
->
rob_hód
 + indexË% 
x86_rob_tŸÆ_size
;

376 
u›
 = 
	`li°_gë
(
c‹e
->
rob
, 
ödex
);

377 
	`as£π
(
u›
);

378  
u›
;

380  
NULL
;

381 
	}
}

384 
	$X86ThªadRemoveROBTaû
(
X86Thªad
 *
£lf
)

386 
X86C‹e
 *
c‹e
 = 
£lf
->core;

387 
x86_u›_t
 *
u›
 = 
NULL
;

388 
idx
, 
i
;

390 
x86_rob_köd
)

393 
x86_rob_köd_¥iv©e
:

395 
	`as£π
(
£lf
->
rob_cou¡
 > 0);

396 
idx
 = 
£lf
->
rob_èû
 =£lf->
rob_À·_bound
 ?

397 
£lf
->
rob_right_bound
 : sñf->
rob_èû
 - 1;

398 
u›
 = 
	`li°_gë
(
c‹e
->
rob
, 
idx
);

399 
	`as£π
(
	`x86_u›_exi°s
(
u›
));

400 
	`as£π
(
u›
->
thªad
 =
£lf
);

401 
	`li°_£t
(
c‹e
->
rob
, 
idx
, 
NULL
);

402 
£lf
->
rob_èû
 = 
idx
;

403 
£lf
->
rob_cou¡
--;

406 
x86_rob_köd_sh¨ed
:

408 
	`X86C‹eTrimROB
(
c‹e
);

409 
	`as£π
(
£lf
->
rob_cou¡
);

410 
i
 = 
c‹e
->
rob_cou¡
 - 1; i >= 0; i--)

412 
idx
 = (
c‹e
->
rob_hód
 + 
i
Ë% 
x86_rob_tŸÆ_size
;

413 
u›
 = 
	`li°_gë
(
c‹e
->
rob
, 
idx
);

414 i‡(
u›
 && u›->
thªad
 =
£lf
)

416 
	`li°_£t
(
c‹e
->
rob
, 
idx
, 
NULL
);

417 
£lf
->
rob_cou¡
--;

425 
u›
->
ö_rob
 = 0;

426 
	`x86_u›_‰ì_if_nŸ_queued
(
u›
);

427 
	}
}

436 
	$X86C‹eC™EnqueueInROB
(
X86C‹e
 *
£lf
, 
x86_u›_t
 *
u›
)

438 
X86Thªad
 *
thªad
;

440 
x86_rob_köd
)

443 
x86_rob_köd_¥iv©e
:

445 
thªad
 = 
u›
->thread;

446 i‡(
thªad
->
rob_cou¡
 < 
x86_rob_size
)

450 
x86_rob_köd_sh¨ed
:

452 
	`X86C‹eTrimROB
(
£lf
);

453 i‡(
£lf
->
rob_cou¡
 < 
x86_rob_tŸÆ_size
)

459 
	}
}

462 
	$X86C‹eEnqueueInROB
(
X86C‹e
 *
£lf
, 
x86_u›_t
 *
u›
)

464 
X86Thªad
 *
thªad
;

466 
thªad
 = 
u›
->thread;

467 
x86_rob_köd
)

470 
x86_rob_köd_¥iv©e
:

472 
	`as£π
(
thªad
->
rob_cou¡
 < 
x86_rob_size
);

473 
	`as£π
(!
	`li°_gë
(
£lf
->
rob
, 
thªad
->
rob_èû
));

474 
	`li°_£t
(
£lf
->
rob
, 
thªad
->
rob_èû
, 
u›
);

475 
thªad
->
rob_èû
 =Åhªad->rob_èû =thªad->
rob_right_bound
 ?

476 
thªad
->
rob_À·_bound
 :Åhªad->
rob_èû
 + 1;

477 
thªad
->
rob_cou¡
++;

480 
x86_rob_köd_sh¨ed
:

482 
	`X86C‹eTrimROB
(
£lf
);

483 
	`as£π
(
£lf
->
rob_cou¡
 < 
x86_rob_tŸÆ_size
);

484 
	`as£π
(!
	`li°_gë
(
£lf
->
rob
, sñf->
rob_èû
));

485 
	`li°_£t
(
£lf
->
rob
, sñf->
rob_èû
, 
u›
);

486 
£lf
->
rob_èû
 = sñf->rob_èû =
x86_rob_tŸÆ_size
 - 1 ?

487 0 : 
£lf
->
rob_èû
 + 1;

488 
£lf
->
rob_cou¡
++;

489 
thªad
->
rob_cou¡
++;

494 
u›
->
ö_rob
 = 1;

495 
	}
}

	@rob.h

20 #i‚de‡
X86_ARCH_TIMING_ROB_H


21 
	#X86_ARCH_TIMING_ROB_H


	)

23 
	~<lib/utû/˛ass.h
>

29 *
x86_rob_köd_m≠
[];

30 
	ex86_rob_köd_t


32 
x86_rob_köd_¥iv©e
 = 0,

33 
x86_rob_köd_sh¨ed


34 } 
x86_rob_köd
;

35 
x86_rob_size
;

43 
X86C‹eInôROB
(
X86C‹e
 *
£lf
);

44 
X86C‹eFªeROB
(
X86C‹e
 *
£lf
);

46 
X86C‹eDumpROB
(
X86C‹e
 *
£lf
, 
FILE
 *
f
);

47 
X86C‹eC™EnqueueInROB
(
X86C‹e
 *
£lf
, 
x86_u›_t
 *
u›
);

48 
X86C‹eEnqueueInROB
(
X86C‹e
 *
£lf
, 
x86_u›_t
 *
u›
);

55 
X86ThªadC™DequeueFromROB
(
X86Thªad
 *
£lf
);

56 
x86_u›_t
 *
X86ThªadGëROBHód
(
X86Thªad
 *
£lf
);

57 
X86ThªadRemoveROBHód
(
X86Thªad
 *
£lf
);

58 
x86_u›_t
 *
X86ThªadGëROBTaû
(
X86Thªad
 *
£lf
);

59 
X86ThªadRemoveROBTaû
(
X86Thªad
 *
£lf
);

60 
x86_u›_t
 *
X86GëROBE¡ry
(
X86Thªad
 *
£lf
, 
ödex
);

	@sched.c

21 
	~<¨ch/x86/emu/c⁄ãxt.h
>

22 
	~<¨ch/x86/emu/emu.h
>

23 
	~<¨ch/x86/emu/ªgs.h
>

24 
	~<lib/esim/åa˚.h
>

25 
	~<lib/utû/bô-m≠.h
>

26 
	~<lib/utû/debug.h
>

27 
	~<lib/utû/misc.h
>

29 
	~"c‹e.h
"

30 
	~"˝u.h
"

31 
	~"sched.h
"

32 
	~"thªad.h
"

101 
	$X86ThªadUnm≠C⁄ãxt
(
X86Thªad
 *
£lf
, 
X86C⁄ãxt
 *
˘x
)

103 
X86Cpu
 *
˝u
 = 
£lf
->cpu;

105 
	`as£π
(
˘x
);

106 
	`as£π
(
	`DOUBLE_LINKED_LIST_MEMBER
(
£lf
, 
m≠≥d
, 
˘x
));

107 
	`as£π
(
	`X86C⁄ãxtGëSèã
(
˘x
, 
X86C⁄ãxtM≠≥d
));

108 
	`as£π
(!
	`X86C⁄ãxtGëSèã
(
˘x
, 
X86C⁄ãxtAŒoc
));

111 
	`X86C⁄ãxtCÀ¨Sèã
(
˘x
, 
X86C⁄ãxtM≠≥d
);

114 
	`DOUBLE_LINKED_LIST_REMOVE
(
£lf
, 
m≠≥d
, 
˘x
);

117 
	`X86C⁄ãxtDebug
("#%lld ctx %d unmapped fromÅhread %s\n",

118 
	`asTimög
(
˝u
)->
cy˛e
, 
˘x
->
pid
, 
£lf
->
«me
);

121 i‡(
	`X86C⁄ãxtGëSèã
(
˘x
, 
X86C⁄ãxtFöished
))

124 
	`x86_åa˚
("x86.íd_˘x ctx=%d\n", 
˘x
->
pid
);

127 
	`dñëe
(
˘x
);

129 
	}
}

132 
	$X86ThªadEvi˘C⁄ãxtSig«l
(
X86Thªad
 *
£lf
, 
X86C⁄ãxt
 *
c⁄ãxt
)

134 
	`as£π
(
c⁄ãxt
);

135 
	`as£π
(
£lf
->
˘x
 =
c⁄ãxt
);

136 
	`as£π
(
	`X86C⁄ãxtGëSèã
(
c⁄ãxt
, 
X86C⁄ãxtAŒoc
));

137 
	`as£π
(
	`X86C⁄ãxtGëSèã
(
c⁄ãxt
, 
X86C⁄ãxtM≠≥d
));

138 
	`as£π
(
£lf
->
˘x
 =
c⁄ãxt
);

139 
	`as£π
(
	`DOUBLE_LINKED_LIST_MEMBER
(
£lf
, 
m≠≥d
, 
c⁄ãxt
));

140 
	`as£π
(!
c⁄ãxt
->
evi˘_sig«l
);

143 
c⁄ãxt
->
evi˘_sig«l
 = 1;

144 
	`X86C⁄ãxtDebug
("#%lld ctx %d signaled forÉviction fromÅhread %s\n",

145 
	`asTimög
(
£lf
)->
cy˛e
, 
c⁄ãxt
->
pid
, sñf->
«me
);

149 i‡(
	`X86ThªadIsPùñöeEm±y
(
£lf
))

150 
	`X86ThªadEvi˘C⁄ãxt
(
£lf
, 
c⁄ãxt
);

152 
	}
}

155 
	$X86ThªadEvi˘C⁄ãxt
(
X86Thªad
 *
£lf
, 
X86C⁄ãxt
 *
c⁄ãxt
)

157 
X86C‹e
 *
c‹e
 = 
£lf
->core;

158 
X86Cpu
 *
˝u
 = 
£lf
->cpu;

160 
	`as£π
(
c⁄ãxt
);

161 
	`as£π
(
£lf
->
˘x
 =
c⁄ãxt
);

162 
	`as£π
(
	`X86C⁄ãxtGëSèã
(
c⁄ãxt
, 
X86C⁄ãxtAŒoc
));

163 
	`as£π
(
	`X86C⁄ãxtGëSèã
(
c⁄ãxt
, 
X86C⁄ãxtM≠≥d
));

164 
	`as£π
(!
	`X86C⁄ãxtGëSèã
(
c⁄ãxt
, 
X86C⁄ãxtS≥cMode
));

165 
	`as£π
(!
£lf
->
rob_cou¡
);

166 
	`as£π
(
c⁄ãxt
->
evi˘_sig«l
);

169 
£lf
->
˘x
 = 
NULL
;

170 
£lf
->
„tch_√ù
 = 0;

173 
	`X86C⁄ãxtCÀ¨Sèã
(
c⁄ãxt
, 
X86C⁄ãxtAŒoc
);

174 
c⁄ãxt
->
evi˘_cy˛e
 = 
	`asTimög
(
˝u
)->
cy˛e
;

175 
c⁄ãxt
->
evi˘_sig«l
 = 0;

178 
	`X86C⁄ãxtDebug
("#%lld ctx %dÉvicted fromÅhread %s\n",

179 
	`asTimög
(
˝u
)->
cy˛e
, 
c⁄ãxt
->
pid
, 
£lf
->
«me
);

182 
	`x86_åa˚
("x86.unmap_ctx ctx=%d core=%dÅhread=%d\n",

183 
c⁄ãxt
->
pid
, 
c‹e
->
id
, 
£lf
->
id_ö_c‹e
);

184 
	}
}

187 
	$X86ThªadScheduÀ
(
X86Thªad
 *
£lf
)

189 
X86Cpu
 *
˝u
 = 
£lf
->cpu;

190 
X86C⁄ãxt
 *
˘x
;

191 
X86C⁄ãxt
 *
tmp_˘x
;

193 
node
;

196 
node
 = 
£lf
->
id_ö_˝u
;

197 
˘x
 = 
£lf
->ctx;

198 i‡(
˘x
)

200 
	`as£π
(
	`X86C⁄ãxtGëSèã
(
˘x
, 
X86C⁄ãxtAŒoc
));

201 
	`as£π
(
	`X86C⁄ãxtGëSèã
(
˘x
, 
X86C⁄ãxtM≠≥d
));

204 i‡(!
˘x
->
evi˘_sig«l
 && !
	`X86C⁄ãxtGëSèã
(˘x, 
X86C⁄ãxtRu¬ög
))

205 
	`X86ThªadEvi˘C⁄ãxtSig«l
(
£lf
, 
˘x
);

208 i‡(!
˘x
->
evi˘_sig«l
 && !
	`bô_m≠_gë
(˘x->
afföôy
, 
node
, 1))

209 
	`X86ThªadEvi˘C⁄ãxtSig«l
(
£lf
, 
˘x
);

212 i‡(!
˘x
->
evi˘_sig«l
 && 
	`asTimög
(
˝u
)->
cy˛e
 >˘x->
Æloc_cy˛e


213 + 
x86_˝u_c⁄ãxt_qu™tum
)

215 
found
 = 0;

218 
	`DOUBLE_LINKED_LIST_FOR_EACH
(
£lf
, 
m≠≥d
, 
tmp_˘x
)

220 i‡(
tmp_˘x
 !
˘x
 && 
	`X86C⁄ãxtGëSèã
(tmp_ctx,

221 
X86C⁄ãxtRu¬ög
))

223 
found
 = 1;

234 i‡(
found
)

235 
	`X86ThªadEvi˘C⁄ãxtSig«l
(
£lf
, 
˘x
);

237 
˘x
->
Æloc_cy˛e
 = 
	`asTimög
(
˝u
)->
cy˛e
;

242 
	`DOUBLE_LINKED_LIST_FOR_EACH
(
£lf
, 
m≠≥d
, 
˘x
)

245 i‡(
˘x
 =
£lf
->ctx)

250 i‡(!
	`bô_m≠_gë
(
˘x
->
afföôy
, 
node
, 1) ||

251 
	`X86C⁄ãxtGëSèã
(
˘x
, 
X86C⁄ãxtFöished
))

252 
	`X86ThªadUnm≠C⁄ãxt
(
£lf
, 
˘x
);

256 i‡(!
£lf
->
˘x
)

260 
˘x
 = 
NULL
;

261 
	`DOUBLE_LINKED_LIST_FOR_EACH
(
£lf
, 
m≠≥d
, 
tmp_˘x
)

264 i‡(!
	`bô_m≠_gë
(
tmp_˘x
->
afföôy
, 
node
, 1))

268 i‡(!
	`X86C⁄ãxtGëSèã
(
tmp_˘x
, 
X86C⁄ãxtRu¬ög
))

272 i‡(!
˘x
 || ctx->
evi˘_cy˛e
 > 
tmp_˘x
->evict_cycle)

273 
˘x
 = 
tmp_˘x
;

277 i‡(
˘x
)

278 
	`X86CpuAŒoˇãC⁄ãxt
(
˝u
, 
˘x
);

280 
	}
}

291 
	$X86CpuAŒoˇãC⁄ãxt
(
X86Cpu
 *
£lf
, 
X86C⁄ãxt
 *
˘x
)

293 
c‹e_ödex
 = 
˘x
->core_index;

294 
thªad_ödex
 = 
˘x
->thread_index;

296 
X86C‹e
 *
c‹e
;

297 
X86Thªad
 *
thªad
;

299 
c‹e
 = 
£lf
->
c‹es
[
c‹e_ödex
];

300 
thªad
 = 
c‹e
->
thªads
[
thªad_ödex
];

302 
	`as£π
(!
thªad
->
˘x
);

303 
	`as£π
(
	`X86C⁄ãxtGëSèã
(
˘x
, 
X86C⁄ãxtM≠≥d
));

304 
	`as£π
(!
	`X86C⁄ãxtGëSèã
(
˘x
, 
X86C⁄ãxtAŒoc
));

305 
	`as£π
(!
˘x
->
evi˘_sig«l
);

308 
˘x
->
Æloc_cy˛e
 = 
	`asTimög
(
£lf
)->
cy˛e
;

309 
	`X86C⁄ãxtSëSèã
(
˘x
, 
X86C⁄ãxtAŒoc
);

312 
thªad
->
˘x
 = ctx;

313 
thªad
->
„tch_√ù
 = 
˘x
->
ªgs
->
eù
;

316 
	`X86C⁄ãxtDebug
("#%lld ctx %d inÅhread %sállocated\n",

317 
	`asTimög
(
£lf
)->
cy˛e
, 
˘x
->
pid
, 
thªad
->
«me
);

320 
	`x86_åa˚
("x86.map_ctx ctx=%d core=%dÅhread=%dÖpid=%d\n",

321 
˘x
->
pid
, 
c‹e_ödex
, 
thªad_ödex
,

322 
˘x
->
∑ª¡
 ? ctx->∑ª¡->
pid
 : 0);

323 
	}
}

326 
	$X86CpuM≠C⁄ãxt
(
X86Cpu
 *
£lf
, 
X86C⁄ãxt
 *
˘x
)

328 
mö_c‹e
;

329 
mö_thªad
;

331 
c‹e
;

332 
thªad
;

333 
node
;

335 
	`as£π
(!
	`X86C⁄ãxtGëSèã
(
˘x
, 
X86C⁄ãxtAŒoc
));

336 
	`as£π
(!
	`X86C⁄ãxtGëSèã
(
˘x
, 
X86C⁄ãxtM≠≥d
));

337 
	`as£π
(!
˘x
->
evi˘_sig«l
);

341 
mö_c‹e
 = -1;

342 
mö_thªad
 = -1;

343 
node
 = 0;

344 
c‹e
 = 0; c‹ê< 
x86_˝u_num_c‹es
; core++)

346 
thªad
 = 0;Åhªad < 
x86_˝u_num_thªads
;Åhread++)

349 
node
 = 
c‹e
 * 
x86_˝u_num_thªads
 + 
thªad
;

350 i‡(!
	`bô_m≠_gë
(
˘x
->
afföôy
, 
node
, 1))

354 i‡(
mö_c‹e
 < 0 ||

355 
£lf
->
c‹es
[
c‹e
]->
thªads
[
thªad
]

356 ->
m≠≥d_li°_cou¡
 <

357 
£lf
->
c‹es
[
mö_c‹e
]->
thªads
[
mö_thªad
]

358 ->
m≠≥d_li°_cou¡
)

360 
mö_c‹e
 = 
c‹e
;

361 
mö_thªad
 = 
thªad
;

367 
c‹e
 = 
mö_c‹e
;

368 
thªad
 = 
mö_thªad
;

369 i‡(
c‹e
 < 0 || 
thªad
 < 0)

370 
	`∑nic
("%s:Çÿnodêwôháfföôy found", 
__FUNCTION__
);

373 
˘x
->
c‹e_ödex
 = 
c‹e
;

374 
˘x
->
thªad_ödex
 = 
thªad
;

375 
	`X86C⁄ãxtSëSèã
(
˘x
, 
X86C⁄ãxtM≠≥d
);

378 
	`DOUBLE_LINKED_LIST_INSERT_TAIL
(
£lf
->
c‹es
[
c‹e
]->
thªads
[
thªad
],

379 
m≠≥d
, 
˘x
);

382 
	`X86C⁄ãxtDebug
("#%lld ctx %d mappedÅoÇode %d/%d\n",

383 
	`asTimög
(
£lf
)->
cy˛e
, 
˘x
->
pid
, 
c‹e
, 
thªad
);

384 
	}
}

387 
	$X86CpuUpd©eMöAŒocCy˛e
(
X86Cpu
 *
£lf
)

389 
X86C⁄ãxt
 *
˘x
;

391 
i
;

392 
j
;

394 
£lf
->
mö_Æloc_cy˛e
 = 
	`asTimög
(£lf)->
cy˛e
;

395 
i
 = 0; i < 
x86_˝u_num_c‹es
; i++)

397 
j
 = 0; j < 
x86_˝u_num_thªads
; j++)

399 
˘x
 = 
£lf
->
c‹es
[
i
]->
thªads
[
j
]->ctx;

400 i‡(
˘x
 && !˘x->
evi˘_sig«l
 &&

401 
˘x
->
Æloc_cy˛e
 < 
£lf
->
mö_Æloc_cy˛e
)

402 
£lf
->
mö_Æloc_cy˛e
 = 
˘x
->
Æloc_cy˛e
;

405 
	}
}

408 
	$X86CpuScheduÀ
(
X86Cpu
 *
£lf
)

410 
X86Emu
 *
emu
 = 
£lf
->emu;

411 
X86C⁄ãxt
 *
˘x
;

413 
qu™tum_expúed
;

415 
i
;

416 
j
;

419 
qu™tum_expúed
 = 
	`asTimög
(
£lf
)->
cy˛e
 >£lf->
mö_Æloc_cy˛e
 +

420 
x86_˝u_c⁄ãxt_qu™tum
;

425 i‡(!
qu™tum_expúed
 && !
emu
->
scheduÀ_sig«l
)

430 
emu
->
scheduÀ_sig«l
 = 0;

431 
	`X86C⁄ãxtDebug
("#%Œd scheduÀ\n", 
	`asTimög
(
£lf
)->
cy˛e
);

436 
	`DOUBLE_LINKED_LIST_FOR_EACH
(
emu
, 
ru¬ög
, 
˘x
)

437 i‡(!
	`X86C⁄ãxtGëSèã
(
˘x
, 
X86C⁄ãxtM≠≥d
))

438 
	`X86CpuM≠C⁄ãxt
(
£lf
, 
˘x
);

441 
i
 = 0; i < 
x86_˝u_num_c‹es
; i++)

442 
j
 = 0; j < 
x86_˝u_num_thªads
; j++)

443 
	`X86ThªadScheduÀ
(
£lf
->
c‹es
[
i
]->
thªads
[
j
]);

447 
	`X86CpuUpd©eMöAŒocCy˛e
(
£lf
);

448 
	}
}

	@sched.h

20 #i‚de‡
ARCH_X86_TIMING_SCHED_H


21 
	#ARCH_X86_TIMING_SCHED_H


	)

33 
X86ThªadUnm≠C⁄ãxt
(
X86Thªad
 *
£lf
, 
X86C⁄ãxt
 *
˘x
);

38 
X86ThªadEvi˘C⁄ãxtSig«l
(
X86Thªad
 *
£lf
, 
X86C⁄ãxt
 *
c⁄ãxt
);

42 
X86ThªadEvi˘C⁄ãxt
(
X86Thªad
 *
£lf
, 
X86C⁄ãxt
 *
c⁄ãxt
);

45 
X86ThªadScheduÀ
(
X86Thªad
 *
£lf
);

57 
X86CpuAŒoˇãC⁄ãxt
(
X86Cpu
 *
£lf
, 
X86C⁄ãxt
 *
˘x
);

61 
X86CpuM≠C⁄ãxt
(
X86Cpu
 *
£lf
, 
X86C⁄ãxt
 *
˘x
);

69 
X86CpuUpd©eMöAŒocCy˛e
(
X86Cpu
 *
£lf
);

74 
X86CpuScheduÀ
(
X86Cpu
 *
£lf
);

	@thread.c

20 
	~<lib/mh™dÀ/mh™dÀ.h
>

21 
	~<lib/utû/li°.h
>

22 
	~<lib/utû/°rög.h
>

24 
	~"b¥ed.h
"

25 
	~"c‹e.h
"

26 
	~"„tch-queue.h
"

27 
	~"ö°-queue.h
"

28 
	~"lﬂd-°‹e-queue.h
"

29 
	~"ªg-fûe.h
"

30 
	~"thªad.h
"

31 
	~"åa˚-ˇche.h
"

32 
	~"u›-queue.h
"

39 
CLASS_IMPLEMENTATION
(
X86Thªad
);

41 
	$X86ThªadCª©e
(
X86Thªad
 *
£lf
, 
X86C‹e
 *
c‹e
)

44 
£lf
->
c‹e
 = core;

45 
£lf
->
˝u
 = 
c‹e
->cpu;

48 
	`X86ThªadInôU›Queue
(
£lf
);

49 
	`X86ThªadInôLSQ
(
£lf
);

50 
	`X86ThªadInôIQ
(
£lf
);

51 
	`X86ThªadInôRegFûe
(
£lf
);

52 
	`X86ThªadInôFëchQueue
(
£lf
);

53 
	`X86ThªadInôBønchPªd
(
£lf
);

54 
	`X86ThªadInôTø˚Cache
(
£lf
);

55 
	}
}

58 
	$X86ThªadDe°roy
(
X86Thªad
 *
£lf
)

61 
	`X86ThªadFªeU›Queue
(
£lf
);

62 
	`X86ThªadFªeLSQ
(
£lf
);

63 
	`X86ThªadFªeIQ
(
£lf
);

64 
	`X86ThªadFªeRegFûe
(
£lf
);

65 
	`X86ThªadFªeFëchQueue
(
£lf
);

66 
	`X86ThªadFªeBønchPªd
(
£lf
);

67 
	`X86ThªadFªeTø˚Cache
(
£lf
);

70 
£lf
->
«me
 = 
	`°r_‰ì
(self->name);

71 
	}
}

74 
	$X86ThªadSëName
(
X86Thªad
 *
£lf
, *
«me
)

76 
£lf
->
«me
 = 
	`°r_£t
(self->name,Çame);

77 
	}
}

80 
	$X86ThªadIsPùñöeEm±y
(
X86Thªad
 *
£lf
)

82  !
£lf
->
rob_cou¡
 && !£lf->
„tch_queue
->
cou¡
 &&

83 !
£lf
->
u›_queue
->
cou¡
;

84 
	}
}

	@thread.h

20 #i‚de‡
X86_ARCH_TIMING_THREAD_H


21 
	#X86_ARCH_TIMING_THREAD_H


	)

23 
	~<¨ch/x86/emu/uö°.h
>

24 
	~<lib/utû/˛ass.h
>

29 
	sx86_ö°_∑âîn_t


32 
	mcompuã_ty≥
;

33 
	mmem‹y_ty≥
;

34 
	mˇche_miss
;

35 
	mˇche_hôs
;

38 
	muö°_öt_cou¡
;

39 
	muö°_logic_cou¡
;

40 
	muö°_Â_cou¡
;

41 
	muö°_mem_cou¡
;

42 
	muö°_˘æ_cou¡
;

43 
	muö°_tŸÆ
;

46 
	sx86_ö°_¥ed_t


48 *
	m«me
;

51 
	mnum_uö°_¨øy
[
x86_uö°_›code_cou¡
];

54 
	#MAX_PATTERN_ITER_COUNT
 32

	)

55 
x86_ö°_∑âîn_t
 
	m∑âîn_hi°‹y
[
MAX_PATTERN_ITER_COUNT
];

56 
	#THESHOLD_PATTERN_ITER_COUNT
 3

	)

57 
	mcuº_∑âîn_ödex
;

58 
	mtŸÆ_∑âîn_¥o˚s£d
;

59 
	mru¬ög_avg_ö°_≥r_∑âîn
;

61 
	m√xt_¥ed_mem_ö°_di°™˚
;

64 
	mac˚s£s
;

65 
	mhôs
;

74 
	$CLASS_BEGIN
(
X86Thªad
, 
Obje˘
)

77 
X86C‹e
 *
c‹e
;

78 
X86Cpu
 *
˝u
;

81 
id_ö_c‹e
;

82 
id_ö_˝u
;

85 *
«me
;

89 
X86C⁄ãxt
 *
˘x
;

92 
X86C⁄ãxt
 *
m≠≥d_li°_hód
;

93 
X86C⁄ãxt
 *
m≠≥d_li°_èû
;

94 
m≠≥d_li°_cou¡
;

95 
m≠≥d_li°_max
;

98 
rob_cou¡
;

99 
rob_À·_bound
;

100 
rob_right_bound
;

101 
rob_hód
;

102 
rob_èû
;

105 
iq_cou¡
;

106 
lsq_cou¡
;

107 
ªg_fûe_öt_cou¡
;

108 
ªg_fûe_Â_cou¡
;

109 
ªg_fûe_xmm_cou¡
;

112 
li°_t
 *
„tch_queue
;

113 
li°_t
 *
u›_queue
;

114 
löked_li°_t
 *
iq
;

115 
löked_li°_t
 *
lq
;

116 
löked_li°_t
 *
sq
;

117 
löked_li°_t
 *
¥eq
;

118 
x86_b¥ed_t
 *
b¥ed
;

119 
x86_åa˚_ˇche_t
 *
åa˚_ˇche
;

120 
x86_ªg_fûe_t
 *
ªg_fûe
;

123 
x86_ö°_¥ed_t
 
ùªd
;

126 
„tch_eù
, 
„tch_√ù
;

127 
„tchq_occ
;

128 
åa˚_ˇche_queue_occ
;

129 
„tch_block
;

130 
„tch_addªss
;

131 
„tch_ac˚ss
;

132 
„tch_°Æl_u¡û
;

135 
mod_t
 *
d©a_mod
;

136 
mod_t
 *
ö°_mod
;

139 
œ°_commô_cy˛e
;

142 
num_„tched_uö°
;

143 
num_di•©ched_uö°_¨øy
[
x86_uö°_›code_cou¡
];

144 
num_issued_uö°_¨øy
[
x86_uö°_›code_cou¡
];

145 
num_commôãd_uö°_¨øy
[
x86_uö°_›code_cou¡
];

146 
num_squashed_uö°
;

147 
num_bønch_uö°
;

148 
num_mi•ªd_bønch_uö°
;

151 
rob_occu∑ncy
;

152 
rob_fuŒ
;

153 
rob_ªads
;

154 
rob_wrôes
;

156 
iq_occu∑ncy
;

157 
iq_fuŒ
;

158 
iq_ªads
;

159 
iq_wrôes
;

160 
iq_wakeup_ac˚s£s
;

162 
lsq_occu∑ncy
;

163 
lsq_fuŒ
;

164 
lsq_ªads
;

165 
lsq_wrôes
;

166 
lsq_wakeup_ac˚s£s
;

168 
ªg_fûe_öt_occu∑ncy
;

169 
ªg_fûe_öt_fuŒ
;

170 
ªg_fûe_öt_ªads
;

171 
ªg_fûe_öt_wrôes
;

173 
ªg_fûe_Â_occu∑ncy
;

174 
ªg_fûe_Â_fuŒ
;

175 
ªg_fûe_Â_ªads
;

176 
ªg_fûe_Â_wrôes
;

178 
ªg_fûe_xmm_occu∑ncy
;

179 
ªg_fûe_xmm_fuŒ
;

180 
ªg_fûe_xmm_ªads
;

181 
ªg_fûe_xmm_wrôes
;

183 
øt_öt_ªads
;

184 
øt_öt_wrôes
;

185 
øt_Â_ªads
;

186 
øt_Â_wrôes
;

187 
øt_xmm_ªads
;

188 
øt_xmm_wrôes
;

190 
btb_ªads
;

191 
btb_wrôes
;

193 
	$CLASS_END
(
X86Thªad
)

196 
	`X86ThªadCª©e
(
X86Thªad
 *
£lf
, 
X86C‹e
 *
c‹e
);

197 
	`X86ThªadDe°roy
(
X86Thªad
 *
£lf
);

199 
	`X86ThªadSëName
(
X86Thªad
 *
£lf
, *
«me
);

201 
	`X86ThªadIsPùñöeEm±y
(
X86Thªad
 *
£lf
);

	@trace-cache.c

21 
	~<¨ch/x86/emu/c⁄ãxt.h
>

22 
	~<lib/mh™dÀ/mh™dÀ.h
>

23 
	~<lib/utû/c⁄fig.h
>

24 
	~<lib/utû/debug.h
>

25 
	~<lib/utû/misc.h
>

26 
	~<lib/utû/°rög.h
>

27 
	~<mem-sy°em/mem‹y.h
>

29 
	~"c‹e.h
"

30 
	~"˝u.h
"

31 
	~"åa˚-ˇche.h
"

32 
	~"u›.h
"

33 
	~"thªad.h
"

41 
	$X86ThªadInôTø˚Cache
(
X86Thªad
 *
£lf
)

43 
X86C‹e
 *
c‹e
 = 
£lf
->core;

44 
«me
[
MAX_STRING_SIZE
];

47 i‡(!
x86_åa˚_ˇche_¥e£¡
)

51 
	`¢¥ötf
(
«me
, Çame,"Core[%d].Thread[%d].TraceCache",

52 
c‹e
->
id
, 
£lf
->
id_ö_c‹e
);

53 
£lf
->
åa˚_ˇche
 = 
	`x86_åa˚_ˇche_¸óã
(
«me
);

54 
	}
}

57 
	$X86ThªadFªeTø˚Cache
(
X86Thªad
 *
£lf
)

60 i‡(!
x86_åa˚_ˇche_¥e£¡
)

64 
	`x86_åa˚_ˇche_‰ì
(
£lf
->
åa˚_ˇche
);

65 
	}
}

68 
	$X86ThªadDumpTø˚CacheRï‹t
(
X86Thªad
 *
£lf
, 
FILE
 *
f
)

70 
x86_åa˚_ˇche_t
 *
åa˚_ˇche
 = 
£lf
->trace_cache;

72 
	`Ârötf
(
f
, "; Trace cache -Öarameters\n");

73 
	`Ârötf
(
f
, "Tø˚Cache.Së†%d\n", 
x86_åa˚_ˇche_num_£ts
);

74 
	`Ârötf
(
f
, "Tø˚Cache.Asso¯%d\n", 
x86_åa˚_ˇche_assoc
);

75 
	`Ârötf
(
f
, "Tø˚Cache.Tø˚Sizê%d\n", 
x86_åa˚_ˇche_åa˚_size
);

76 
	`Ârötf
(
f
, "Tø˚Cache.BønchMax = %d\n", 
x86_åa˚_ˇche_bønch_max
);

77 
	`Ârötf
(
f
, "Tø˚Cache.QueueSizê%d\n", 
x86_åa˚_ˇche_queue_size
);

78 
	`Ârötf
(
f
, "\n");

80 
	`Ârötf
(
f
, "; Trace cache - statistics\n");

81 
	`Ârötf
(
f
, "Tø˚Cache.Ac˚s£†%Œd\n", 
åa˚_ˇche
->
ac˚s£s
);

82 
	`Ârötf
(
f
, "Tø˚Cache.Hô†%Œd\n", 
åa˚_ˇche
->
hôs
);

83 
	`Ârötf
(
f
, "Tø˚Cache.HôR©iÿ%.4g\n", 
åa˚_ˇche
->
ac˚s£s
 ? ()

84 
åa˚_ˇche
->
hôs
 /Åø˚_ˇche->
ac˚s£s
 : 0.0);

85 
	`Ârötf
(
f
, "Tø˚Cache.Fëched = %Œd\n", 
åa˚_ˇche
->
num_„tched_uö°
);

86 
	`Ârötf
(
f
, "Tø˚Cache.Di•©ched = %Œd\n", 
åa˚_ˇche
->
num_di•©ched_uö°
);

87 
	`Ârötf
(
f
, "Tø˚Cache.Issued = %Œd\n", 
åa˚_ˇche
->
num_issued_uö°
);

88 
	`Ârötf
(
f
, "Tø˚Cache.Commôãd = %Œd\n", 
åa˚_ˇche
->
num_commôãd_uö°
);

89 
	`Ârötf
(
f
, "Tø˚Cache.Squashed = %Œd\n", 
åa˚_ˇche
->
num_squashed_uö°
);

90 
	`Ârötf
(
f
, "TraceCache.TraceLength = %.2f\n",

91 
åa˚_ˇche
->
åa˚_Àngth_cou¡
 ? (Ëåa˚_ˇche->
åa˚_Àngth_acc
 /

92 
åa˚_ˇche
->
åa˚_Àngth_cou¡
 : 0);

93 
	`Ârötf
(
f
, "\n");

94 
	}
}

98 
	$x86_åa˚_ˇche_¥ed_dump
(
¥ed
, 
num
, 
FILE
 *
f
)

100 
i
;

101 *
comma
;

103 
comma
 = "";

104 
	`Ârötf
(
f
, "(");

105 
i
 = 0; i < 
num
; i++)

107 
	`Ârötf
(
f
, "%s%c", 
comma
, 
¥ed
 & (1 << 
i
) ? 'T' : 'n');

108 
comma
 = "-";

110 
	`Ârötf
(
f
, ")");

111 
	}
}

115 
	$X86Thø˚DumpTø˚CacheE¡ry
(
X86Thªad
 *
£lf
,

116 
x86_åa˚_ˇche_íåy_t
 *
íåy
, 
FILE
 *
f
)

118 
mem_t
 *
mem
;

119 *
comma
;

120 
i
;

123 
	`as£π
(
£lf
->
˘x
 && sñf->˘x->
mem
);

124 
mem
 = 
£lf
->
˘x
->mem;

127 
	`Ârötf
(
f
, "èg = 0x%x, ", 
íåy
->
èg
);

130 
	`Ârötf
(
f
, "branches = ");

131 
	`x86_åa˚_ˇche_¥ed_dump
(
íåy
->
bønch_Êags
,É¡ry->
bønch_cou¡
, 
f
);

132 
	`Ârötf
(
f
, "\n");

135 
	`Ârötf
(
f
, "ÁŒ_through = 0x%x, ", 
íåy
->
ÁŒ_through
);

136 
	`Ârötf
(
f
, "èrgë = 0x%x\n", 
íåy
->
èrgë
);

139 
	`Ârötf
(
f
, "u›†%d, ", 
íåy
->
u›_cou¡
);

140 
	`Ârötf
(
f
, "mops = {");

141 
comma
 = "";

142 
i
 = 0; i < 
íåy
->
m›_cou¡
; i++)

144 
m›_«me
[
MAX_STRING_SIZE
];

145 *
m›_«me_íd
;

146 
m›_byãs
[20];

148 
addr
;

150 
mem_ß„
;

151 
m›_«me_Àngth
;

153 
x86_ö°_t
 
ö°
;

156 
mem_ß„
 = 
mem
->
ß„
;

157 
mem
->
ß„
 = 0;

160 
addr
 = 
íåy
->
m›_¨øy
[
i
];

161 
	`mem_ªad
(
mem
, 
addr
,  
m›_byãs
, mop_bytes);

164 
	`x86_ö°_decode
(&
ö°
, 
addr
, 
m›_byãs
);

167 
m›_«me_íd
 = 
	`ödex
(
ö°
.
f‹m©
, '_');

168 
m›_«me_Àngth
 = 
m›_«me_íd
 ? m›_«me_íd - 
ö°
.
f‹m©
 : 
	`°æí
(inst.format);

169 
	`°r_sub°r
(
m›_«me
,  m›_«me, 
ö°
.
f‹m©
, 0, 
m›_«me_Àngth
);

170 
	`Ârötf
(
f
, "%s%s", 
comma
, 
m›_«me
);

171 
comma
 = ", ";

174 
mem
->
ß„
 = 
mem_ß„
;

176 
	`Ârötf
(
f
, "}\n");

177 
	}
}

181 
	$X86ThªadFlushTø˚Cache
(
X86Thªad
 *
£lf
)

183 
x86_åa˚_ˇche_t
 *
åa˚_ˇche
 = 
£lf
->trace_cache;

184 
x86_åa˚_ˇche_íåy_t
 *
íåy
;

185 
x86_åa˚_ˇche_íåy_t
 *
found_íåy
;

186 
x86_åa˚_ˇche_íåy_t
 *
åa˚
 = 
åa˚_ˇche
->
ãmp
;

188 
£t
;

189 
way
;

190 
found_way
;

193 i‡(!
åa˚
->
u›_cou¡
)

199 
	`as£π
(
åa˚
->
èg
);

200 i‡(
åa˚
->
èrgë
)

202 
	`as£π
(
åa˚
->
bønch_cou¡
);

203 
åa˚
->
bønch_cou¡
--;

204 
åa˚
->
bønch_mask
 &~(1 <<Åø˚->
bønch_cou¡
);

205 
åa˚
->
bønch_Êags
 &~(1 <<Åø˚->
bønch_cou¡
);

210 
found_íåy
 = 
NULL
;

211 
found_way
 = -1;

212 
£t
 = 
åa˚
->
èg
 % 
x86_åa˚_ˇche_num_£ts
;

213 
way
 = 0; way < 
x86_åa˚_ˇche_assoc
; way++)

218 
íåy
 = 
	`X86_TRACE_CACHE_ENTRY
(
£t
, 
way
);

219 i‡(!
íåy
->
èg
)

221 
found_íåy
 = 
íåy
;

222 
found_way
 = 
way
;

227 i‡(
íåy
->
èg
 =
åa˚
->èg &&É¡ry->
bønch_mask
 ==Årace->branch_mask

228 && 
íåy
->
bønch_Êags
 =
åa˚
->branch_flags)

230 
found_íåy
 = 
íåy
;

231 
found_way
 = 
way
;

237 i‡(!
found_íåy
)

239 
way
 = 0; way < 
x86_åa˚_ˇche_assoc
; way++)

241 
íåy
 = 
	`X86_TRACE_CACHE_ENTRY
(
£t
, 
way
);

242 
íåy
->
cou¡î
--;

243 i‡(
íåy
->
cou¡î
 < 0)

245 
íåy
->
cou¡î
 = 
x86_åa˚_ˇche_assoc
 - 1;

246 
found_íåy
 = 
íåy
;

247 
found_way
 = 
way
;

254 
	`as£π
(
found_íåy
);

255 
	`as£π
(
found_way
 >= 0);

256 
åa˚
->
cou¡î
 = 
found_íåy
->counter;

257 
	`mem˝y
(
found_íåy
, 
åa˚
, 
X86_TRACE_CACHE_ENTRY_SIZE
);

258 
	`mem£t
(
åa˚_ˇche
->
ãmp
, 0, 
X86_TRACE_CACHE_ENTRY_SIZE
);

261 i‡(
	`x86_åa˚_ˇche_debuggög
())

263 
FILE
 *
f
;

265 
f
 = 
	`debug_fûe
(
x86_åa˚_ˇche_debug_ˇãg‹y
);

266 
	`Ârötf
(
f
, "** CommitÅrace **\n");

267 
	`Ârötf
(
f
, "Së = %d, Way = %d\n", 
£t
, 
found_way
);

268 
	`X86Thø˚DumpTø˚CacheE¡ry
(
£lf
, 
found_íåy
, 
f
);

269 
	`Ârötf
(
f
, "\n");

273 
åa˚_ˇche
->
åa˚_Àngth_acc
 +
found_íåy
->
u›_cou¡
;

274 
åa˚_ˇche
->
åa˚_Àngth_cou¡
++;

275 
	}
}

278 
	$X86ThªadRec‹dU›InTø˚Cache
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
)

280 
x86_åa˚_ˇche_t
 *
åa˚_ˇche
 = 
£lf
->trace_cache;

281 
x86_åa˚_ˇche_íåy_t
 *
åa˚
 = 
åa˚_ˇche
->
ãmp
;

282 
èkí
;

285 i‡(
u›
->
m›_ödex
)

289 
	`as£π
(!
u›
->
•ecmode
);

290 
	`as£π
(
u›
->
eù
);

291 
	`as£π
(
u›
->
id
 =u›->
m›_id
);

292 i‡(
åa˚
->
u›_cou¡
 + 
u›
->
m›_cou¡
 > 
x86_åa˚_ˇche_åa˚_size
)

293 
	`X86ThªadFlushTø˚Cache
(
£lf
);

297 i‡(
u›
->
m›_cou¡
 > 
x86_åa˚_ˇche_åa˚_size
)

301 i‡(!
åa˚
->
u›_cou¡
)

302 
åa˚
->
èg
 = 
u›
->
eù
;

305 
åa˚
->
m›_¨øy
[åa˚->
m›_cou¡
] = 
u›
->
eù
;

306 
åa˚
->
m›_cou¡
++;

307 
åa˚
->
u›_cou¡
 +
u›
->
m›_cou¡
;

308 
åa˚
->
èrgë
 = 0;

309 
åa˚
->
ÁŒ_through
 = 
u›
->
eù
 + u›->
m›_size
;

313 i‡(
u›
->
Êags
 & 
X86_UINST_CTRL
)

315 
èkí
 = 
u›
->
√ù
 !u›->
eù
 + u›->
m›_size
;

316 
åa˚
->
bønch_mask
 |1 <<Åø˚->
bønch_cou¡
;

317 
åa˚
->
bønch_Êags
 |
èkí
 <<Åø˚->
bønch_cou¡
;

318 
åa˚
->
bønch_cou¡
++;

319 
åa˚
->
èrgë
 = 
u›
->
èrgë_√ù
;

320 i‡(
åa˚
->
bønch_cou¡
 =
x86_åa˚_ˇche_bønch_max
)

321 
	`X86ThªadFlushTø˚Cache
(
£lf
);

323 
	}
}

326 
	$X86ThªadLookupTø˚Cache
(
X86Thªad
 *
£lf
, 
eù
, 
¥ed
,

327 *
±r_m›_cou¡
, **
±r_m›_¨øy
, *
±r_√ù
)

329 
x86_åa˚_ˇche_t
 *
åa˚_ˇche
 = 
£lf
->trace_cache;

330 
x86_åa˚_ˇche_íåy_t
 *
íåy
;

331 
x86_åa˚_ˇche_íåy_t
 *
found_íåy
;

333 
√ù
;

335 
£t
;

336 
way
;

337 
èkí
;

339 
FILE
 *
f
;

342 i‡(
	`x86_åa˚_ˇche_debuggög
())

344 
f
 = 
	`debug_fûe
(
x86_åa˚_ˇche_debug_ˇãg‹y
);

345 
	`Ârötf
(
f
, "** Lookup **\n");

346 
	`Ârötf
(
f
, "eù = 0x%x,Öªd = ", 
eù
);

347 
	`x86_åa˚_ˇche_¥ed_dump
(
¥ed
, 
x86_åa˚_ˇche_bønch_max
, 
f
);

348 
	`Ârötf
(
f
, "\n");

352 
found_íåy
 = 
NULL
;

353 
£t
 = 
eù
 % 
x86_åa˚_ˇche_num_£ts
;

354 
way
 = 0; way < 
x86_åa˚_ˇche_assoc
; way++)

356 
íåy
 = 
	`X86_TRACE_CACHE_ENTRY
(
£t
, 
way
);

357 i‡(
íåy
->
èg
 =
eù
 && ((
¥ed
 &É¡ry->
bønch_mask
Ë=íåy->
bønch_Êags
))

359 
found_íåy
 = 
íåy
;

365 
åa˚_ˇche
->
ac˚s£s
++;

366 i‡(
found_íåy
)

367 
åa˚_ˇche
->
hôs
++;

370 i‡(!
found_íåy
)

372 
	`x86_åa˚_ˇche_debug
("Miss\n");

373 
	`x86_åa˚_ˇche_debug
("\n");

380 
èkí
 = 
found_íåy
->
èrgë
 && (
¥ed
 & (1 << found_íåy->
bønch_cou¡
));

381 
√ù
 = 
èkí
 ? 
found_íåy
->
èrgë
 : found_íåy->
ÁŒ_through
;

384 i‡(
	`x86_åa˚_ˇche_debuggög
())

386 
f
 = 
	`debug_fûe
(
x86_åa˚_ˇche_debug_ˇãg‹y
);

387 
	`Ârötf
(
f
, "Hô - Së = %d, Way = %d\n", 
£t
, 
way
);

388 
	`X86Thø˚DumpTø˚CacheE¡ry
(
£lf
, 
found_íåy
, 
f
);

389 
	`Ârötf
(
f
, "Nexàåa˚Öªdi˘i⁄ = %c\n", 
èkí
 ? 'T' : 'n');

390 
	`Ârötf
(
f
, "Nexà„tcháddªs†0x%x\n", 
√ù
);

391 
	`Ârötf
(
f
, "\n");

395 
	`PTR_ASSIGN
(
±r_m›_cou¡
, 
found_íåy
->
m›_cou¡
);

396 
	`PTR_ASSIGN
(
±r_m›_¨øy
, 
found_íåy
->
m›_¨øy
);

397 
	`PTR_ASSIGN
(
±r_√ù
, 
√ù
);

401 
	}
}

410 
x86_åa˚_ˇche_t
 *
	$x86_åa˚_ˇche_¸óã
(*
«me
)

412 
x86_åa˚_ˇche_t
 *
åa˚_ˇche
;

413 
x86_åa˚_ˇche_íåy_t
 *
íåy
;

415 
£t
;

416 
way
;

419 
åa˚_ˇche
 = 
	`xˇŒoc
(1, (
x86_åa˚_ˇche_t
));

420 
åa˚_ˇche
->
«me
 = 
	`x°rdup
(name);

421 
åa˚_ˇche
->
íåy
 = 
	`xˇŒoc
(
x86_åa˚_ˇche_num_£ts
 * 
x86_åa˚_ˇche_assoc
,

422 
X86_TRACE_CACHE_ENTRY_SIZE
);

423 
åa˚_ˇche
->
ãmp
 = 
	`xˇŒoc
(1, 
X86_TRACE_CACHE_ENTRY_SIZE
);

426 
£t
 = 0; së < 
x86_åa˚_ˇche_num_£ts
; set++)

428 
way
 = 0; way < 
x86_åa˚_ˇche_assoc
; way++)

430 
íåy
 = 
	`X86_TRACE_CACHE_ENTRY
(
£t
, 
way
);

431 
íåy
->
cou¡î
 = 
way
;

436  
åa˚_ˇche
;

437 
	}
}

440 
	$x86_åa˚_ˇche_‰ì
(
x86_åa˚_ˇche_t
 *
åa˚_ˇche
)

442 
	`‰ì
(
åa˚_ˇche
->
«me
);

443 
	`‰ì
(
åa˚_ˇche
->
íåy
);

444 
	`‰ì
(
åa˚_ˇche
->
ãmp
);

445 
	`‰ì
(
åa˚_ˇche
);

446 
	}
}

456 
	gx86_åa˚_ˇche_debug_ˇãg‹y
;

459 
	gx86_åa˚_ˇche_¥e£¡
;

460 
	gx86_åa˚_ˇche_num_£ts
;

461 
	gx86_åa˚_ˇche_assoc
;

462 
	gx86_åa˚_ˇche_åa˚_size
;

463 
	gx86_åa˚_ˇche_bønch_max
;

464 
	gx86_åa˚_ˇche_queue_size
;

467 
	$X86RódTø˚CacheC⁄fig
(
c⁄fig_t
 *
c⁄fig
)

469 *
£˘i⁄
;

470 *
fûe_«me
;

473 
£˘i⁄
 = "TraceCache";

474 
fûe_«me
 = 
	`c⁄fig_gë_fûe_«me
(
c⁄fig
);

477 
x86_åa˚_ˇche_¥e£¡
 = 
	`c⁄fig_ªad_boﬁ
(
c⁄fig
, 
£˘i⁄
, "Present", 0);

478 
x86_åa˚_ˇche_num_£ts
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "Sets", 64);

479 
x86_åa˚_ˇche_assoc
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "Assoc", 4);

480 
x86_åa˚_ˇche_åa˚_size
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "TraceSize", 16);

481 
x86_åa˚_ˇche_bønch_max
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "BranchMax", 3);

482 
x86_åa˚_ˇche_queue_size
 = 
	`c⁄fig_ªad_öt
(
c⁄fig
, 
£˘i⁄
, "QueueSize", 32);

485 i‡((
x86_åa˚_ˇche_num_£ts
 & (x86_trace_cache_num_sets - 1)) || !x86_trace_cache_num_sets)

486 
	`Áèl
("%s: %s: 'Sets' must beáÖower of 2 greaterÅhan 0",

487 
fûe_«me
, 
£˘i⁄
);

488 i‡((
x86_åa˚_ˇche_assoc
 & (x86_trace_cache_assoc - 1)) || !x86_trace_cache_assoc)

489 
	`Áèl
("%s: %s: 'Assoc' must beáÖower of 2 greaterÅhan 0",

490 
fûe_«me
, 
£˘i⁄
);

491 i‡(!
x86_åa˚_ˇche_åa˚_size
)

492 
	`Áèl
("%s: %s: Invalid value for 'TraceSize'",

493 
fûe_«me
, 
£˘i⁄
);

494 i‡(!
x86_åa˚_ˇche_bønch_max
)

495 
	`Áèl
("%s: %s: Invalid value for 'BranchMax'",

496 
fûe_«me
, 
£˘i⁄
);

497 i‡(
x86_åa˚_ˇche_bønch_max
 > 
x86_åa˚_ˇche_åa˚_size
)

498 
	`Áèl
("%s: %s: 'BranchMax' must beÉqual orÜessÅhan 'TraceSize'",

499 
fûe_«me
, 
£˘i⁄
);

500 i‡(
x86_åa˚_ˇche_bønch_max
 > 31)

501 
	`Áèl
("%s: %s: Maximum value for 'BranchMax' is 31",

502 
fûe_«me
, 
£˘i⁄
);

503 
	}
}

	@trace-cache.h

20 #i‚de‡
X86_ARCH_TIMING_TRACE_CACHE_H


21 
	#X86_ARCH_TIMING_TRACE_CACHE_H


	)

23 
	~<lib/utû/˛ass.h
>

27 
	gc⁄fig_t
;

35 
X86ThªadInôTø˚Cache
(
X86Thªad
 *
£lf
);

36 
X86ThªadFªeTø˚Cache
(
X86Thªad
 *
£lf
);

38 
X86ThªadDumpTø˚CacheRï‹t
(
X86Thªad
 *
£lf
, 
FILE
 *
f
);

40 
X86ThªadRec‹dU›InTø˚Cache
(
X86Thªad
 *
£lf
, 
x86_u›_t
 *
u›
);

41 
X86ThªadLookupTø˚Cache
(
X86Thªad
 *
£lf
, 
eù
, 
¥ed
,

42 *
±r_m›_cou¡
, **
±r_m›_¨øy
, *
±r_√ù
);

51 
x86_åa˚_ˇche_t
 *
x86_åa˚_ˇche_¸óã
(*
«me
);

52 
x86_åa˚_ˇche_‰ì
(
x86_åa˚_ˇche_t
 *
åa˚_ˇche
);

54 
	#X86_TRACE_CACHE_ENTRY_SIZE
 \

55 ((
x86_åa˚_ˇche_íåy_t
) + \

56 (Ë* 
x86_åa˚_ˇche_åa˚_size
)

	)

57 
	#X86_TRACE_CACHE_ENTRY
(
SET
, 
WAY
) \

58 ((
x86_åa˚_ˇche_íåy_t
 *Ë(((*Ë
åa˚_ˇche
->
íåy
) + \

59 
X86_TRACE_CACHE_ENTRY_SIZE
 * ((
SET
Ë* 
x86_åa˚_ˇche_assoc
 + (
WAY
))))

	)

61 
	sx86_åa˚_ˇche_íåy_t


64 
	mcou¡î
;

67 
	mèg
;

70 
	mu›_cou¡
;

71 
	mm›_cou¡
;

77 
	mbønch_cou¡
;

80 
	mbønch_mask
;

85 
	mbønch_Êags
;

89 
	mÁŒ_through
;

92 
	mèrgë
;

99 
	mm›_¨øy
[0];

102 
	sx86_åa˚_ˇche_t


104 *
	m«me
;

107 
x86_åa˚_ˇche_íåy_t
 *
	míåy
;

111 
x86_åa˚_ˇche_íåy_t
 *
	mãmp
;

114 
	mac˚s£s
;

115 
	mhôs
;

116 
	mnum_„tched_uö°
;

117 
	mnum_di•©ched_uö°
;

118 
	mnum_issued_uö°
;

119 
	mnum_commôãd_uö°
;

120 
	mnum_squashed_uö°
;

121 
	måa˚_Àngth_acc
;

122 
	måa˚_Àngth_cou¡
;

133 
	#x86_åa˚_ˇche_debuggög
(Ë
	`debug_°©us
(
x86_åa˚_ˇche_debug_ˇãg‹y
)

	)

134 
	#x86_åa˚_ˇche_debug
(...Ë
	`debug
(
x86_åa˚_ˇche_debug_ˇãg‹y
, 
__VA_ARGS__
)

	)

135 
x86_åa˚_ˇche_debug_ˇãg‹y
;

137 
x86_åa˚_ˇche_¥e£¡
;

138 
x86_åa˚_ˇche_num_£ts
;

139 
x86_åa˚_ˇche_assoc
;

140 
x86_åa˚_ˇche_åa˚_size
;

141 
x86_åa˚_ˇche_bønch_max
;

142 
x86_åa˚_ˇche_queue_size
;

145 
X86RódTø˚CacheC⁄fig
(
c⁄fig_t
 *
c⁄fig
);

	@uop-queue.c

21 
	~<lib/esim/åa˚.h
>

22 
	~<lib/utû/li°.h
>

24 
	~"c‹e.h
"

25 
	~"˝u.h
"

26 
	~"u›.h
"

27 
	~"u›-queue.h
"

28 
	~"thªad.h
"

31 
	gx86_u›_queue_size
;

34 
	$X86ThªadInôU›Queue
(
X86Thªad
 *
£lf
)

36 
£lf
->
u›_queue
 = 
	`li°_¸óã_wôh_size
(
x86_u›_queue_size
);

37 
	}
}

40 
	$X86ThªadFªeU›Queue
(
X86Thªad
 *
£lf
)

42 
li°_t
 *
u›_queue
;

43 
x86_u›_t
 *
u›
;

45 
u›_queue
 = 
£lf
->uop_queue;

46 
	`li°_cou¡
(
u›_queue
))

48 
u›
 = 
	`li°_ªmove_©
(
u›_queue
, 0);

49 
u›
->
ö_u›_queue
 = 0;

50 
	`x86_u›_‰ì_if_nŸ_queued
(
u›
);

52 
	`li°_‰ì
(
u›_queue
);

53 
	}
}

56 
	$X86ThªadRecovîU›Queue
(
X86Thªad
 *
£lf
)

58 
X86C‹e
 *
c‹e
 = 
£lf
->core;

59 
X86Cpu
 *
˝u
 = 
£lf
->cpu;

61 
li°_t
 *
u›_queue
 = 
£lf
->uop_queue;

62 
x86_u›_t
 *
u›
;

64 
	`li°_cou¡
(
u›_queue
))

66 
u›
 = 
	`li°_gë
(
u›_queue
, 
	`li°_cou¡
(uop_queue) - 1);

67 
	`as£π
(
u›
->
thªad
 =
£lf
);

68 i‡(!
u›
->
•ecmode
)

70 
	`li°_ªmove_©
(
u›_queue
, 
	`li°_cou¡
(uop_queue) - 1);

71 
u›
->
ö_u›_queue
 = 0;

74 i‡(
	`x86_åacög
())

76 
	`x86_åa˚
("x86.inst id=%lld core=%d stg=\"sq\"\n",

77 
u›
->
id_ö_c‹e
, 
c‹e
->
id
);

78 
	`X86CpuAddToTø˚Li°
(
˝u
, 
u›
);

82 
	`x86_u›_‰ì_if_nŸ_queued
(
u›
);

84 
	}
}

	@uop-queue.h

20 #i‚de‡
X86_ARCH_TIMING_UOP_QUEUE_H


21 
	#X86_ARCH_TIMING_UOP_QUEUE_H


	)

26 
x86_u›_queue_size
;

34 
X86ThªadInôU›Queue
(
X86Thªad
 *
£lf
);

35 
X86ThªadFªeU›Queue
(
X86Thªad
 *
£lf
);

36 
X86ThªadRecovîU›Queue
(
X86Thªad
 *
£lf
);

	@uop.c

20 
	~<lib/mh™dÀ/mh™dÀ.h
>

21 
	~<lib/utû/li°.h
>

22 
	~<lib/utû/löked-li°.h
>

24 
	~"u›.h
"

27 
	#UOP_MAGIC
 0x10101010U

	)

30 
x86_u›_t
 *
	$x86_u›_¸óã
()

32 
x86_u›_t
 *
u›
;

35 
u›
 = 
	`xˇŒoc
(1, (
x86_u›_t
));

36 
u›
->
magic
 = 
UOP_MAGIC
;

39  
u›
;

40 
	}
}

43 
	$x86_u›_‰ì_if_nŸ_queued
(
x86_u›_t
 *
u›
)

46 i‡(
u›
->
ö_„tch_queue
 || u›->
ö_u›_queue
 || u›->
ö_iq
 ||

47 
u›
->
ö_lq
 || u›->
ö_sq
 || u›->
ö_¥eq
 ||

48 
u›
->
ö_rob
 || u›->
ö_evít_queue
 ||

49 
u›
->
ö_u›_åa˚_li°
)

55 
u›
->
magic
 = 0;

56 
	`x86_uö°_‰ì
(
u›
->
uö°
);

57 
	`‰ì
(
u›
);

58 
	}
}

61 
	$x86_u›_dump
(
x86_u›_t
 *
u›
, 
FILE
 *
f
)

64 
	`Ârötf
(
f
, "id=%Œd, ", 
u›
->
id
);

65 
	`Ârötf
(
f
, "eù=0x%x, ", 
u›
->
eù
);

66 
	`Ârötf
(
f
, "•ec_mode=%c, ", 
u›
->
•ecmode
 ? 't' : 'f');

67 
	`Ârötf
(
f
, "åa˚_ˇche=%c, ", 
u›
->
åa˚_ˇche
 ? 't' : 'f');

70 
	`Ârötf
(
f
, "uinst='");

71 
	`x86_uö°_dump
(
u›
->
uö°
, 
f
);

72 
	`Ârötf
(
f
, "'");

73 
	}
}

78 
	$x86_u›_exi°s
(
x86_u›_t
 *
u›
)

80  
u›
->
magic
 =
UOP_MAGIC
;

81 
	}
}

89 
	$x86_u›_cou¡_dïs
(
x86_u›_t
 *
u›
)

91 
dï
;

92 
l‹eg
;

94 
öt_cou¡
;

95 
Â_cou¡
;

96 
Êag_cou¡
;

97 
xmm_cou¡
;

100 
u›
->
idï_cou¡
 = 0;

101 
u›
->
odï_cou¡
 = 0;

102 
u›
->
ph_öt_idï_cou¡
 = 0;

103 
u›
->
ph_Â_idï_cou¡
 = 0;

104 
u›
->
ph_xmm_idï_cou¡
 = 0;

105 
u›
->
ph_öt_odï_cou¡
 = 0;

106 
u›
->
ph_Â_odï_cou¡
 = 0;

107 
u›
->
ph_xmm_odï_cou¡
 = 0;

110 
öt_cou¡
 = 
Â_cou¡
 = 
Êag_cou¡
 = 
xmm_cou¡
 = 0;

111 
dï
 = 0; dï < 
X86_UINST_MAX_ODEPS
; dep++)

113 
l‹eg
 = 
u›
->
uö°
->
odï
[
dï
];

114 i‡(
	`X86_DEP_IS_FLAG
(
l‹eg
))

115 
Êag_cou¡
++;

116 i‡(
	`X86_DEP_IS_INT_REG
(
l‹eg
))

117 
öt_cou¡
++;

118 i‡(
	`X86_DEP_IS_FP_REG
(
l‹eg
))

119 
Â_cou¡
++;

120 i‡(
	`X86_DEP_IS_XMM_REG
(
l‹eg
))

121 
xmm_cou¡
++;

123 
u›
->
odï_cou¡
 = 
Êag_cou¡
 + 
öt_cou¡
 + 
Â_cou¡
 + 
xmm_cou¡
;

124 
u›
->
ph_öt_odï_cou¡
 = 
Êag_cou¡
 && !
öt_cou¡
 ? 1 : int_count;

125 
u›
->
ph_Â_odï_cou¡
 = 
Â_cou¡
;

126 
u›
->
ph_xmm_odï_cou¡
 = 
xmm_cou¡
;

129 
öt_cou¡
 = 
Â_cou¡
 = 
Êag_cou¡
 = 
xmm_cou¡
 = 0;

130 
dï
 = 0; dï < 
X86_UINST_MAX_IDEPS
; dep++)

132 
l‹eg
 = 
u›
->
uö°
->
idï
[
dï
];

133 i‡(
	`X86_DEP_IS_FLAG
(
l‹eg
))

134 
Êag_cou¡
++;

135 i‡(
	`X86_DEP_IS_INT_REG
(
l‹eg
))

136 
öt_cou¡
++;

137 i‡(
	`X86_DEP_IS_FP_REG
(
l‹eg
))

138 
Â_cou¡
++;

139 i‡(
	`X86_DEP_IS_XMM_REG
(
l‹eg
))

140 
xmm_cou¡
++;

142 
u›
->
idï_cou¡
 = 
Êag_cou¡
 + 
öt_cou¡
 + 
Â_cou¡
 + 
xmm_cou¡
;

143 
u›
->
ph_öt_idï_cou¡
 = 
Êag_cou¡
 + 
öt_cou¡
;

144 
u›
->
ph_Â_idï_cou¡
 = 
Â_cou¡
;

145 
u›
->
ph_xmm_idï_cou¡
 = 
xmm_cou¡
;

146 
	}
}

149 
	$x86_u›_li°_dump
(
li°_t
 *
li°
, 
FILE
 *
f
)

151 
x86_u›_t
 *
u›
;

152 
i
;

154 
i
 = 0; i < 
	`li°_cou¡
(
li°
); i++)

156 
	`Ârötf
(
f
, "%3d. ", 
i
);

157 
u›
 = 
	`li°_gë
(
li°
, 
i
);

158 
	`x86_u›_dump
(
u›
, 
f
);

159 
	`Ârötf
(
f
, "\n");

161 
	}
}

164 
	$x86_u›_löked_li°_dump
(
löked_li°_t
 *
u›_li°
, 
FILE
 *
f
)

166 
x86_u›_t
 *
u›
;

168 
	`löked_li°_hód
(
u›_li°
);

169 !
	`löked_li°_is_íd
(
u›_li°
))

171 
u›
 = 
	`löked_li°_gë
(
u›_li°
);

172 
	`Ârötf
(
f
, "%3d. ", 
	`löked_li°_cuºít
(
u›_li°
));

173 
	`x86_uö°_dump
(
u›
->
uö°
, 
f
);

174 
	`Ârötf
(
f
, "\n");

175 
	`löked_li°_√xt
(
u›_li°
);

177 
	}
}

	@uop.h

20 #i‚de‡
X86_ARCH_TIMING_UOP_H


21 
	#X86_ARCH_TIMING_UOP_H


	)

23 
	~<¨ch/x86/emu/uö°.h
>

24 
	~<lib/utû/˛ass.h
>

32 
	sx86_u›_t


35 
x86_uö°_t
 *
	muö°
;

36 
x86_uö°_Êag_t
 
	mÊags
;

39 
	mmagic
;

40 
	mid
;

41 
	mid_ö_c‹e
;

44 
X86C⁄ãxt
 *
	m˘x
;

45 
X86Thªad
 *
	mthªad
;

48 
	meù
;

49 
	m√ù
;

50 
	m¥ed_√ù
;

51 
	mèrgë_√ù
;

52 
	m•ecmode
;

53 
	m„tch_addªss
;

54 
	m„tch_ac˚ss
;

55 
	måa˚_ˇche
;

58 
	mm›_«me
[40];

59 
	mm›_ödex
;

60 
	mm›_cou¡
;

61 
	mm›_size
;

62 
	mm›_id
;

65 
	midï_cou¡
;

66 
	modï_cou¡
;

69 
	mph_öt_idï_cou¡
, 
	mph_Â_idï_cou¡
, 
	mph_xmm_idï_cou¡
;

70 
	mph_öt_odï_cou¡
, 
	mph_Â_odï_cou¡
, 
	mph_xmm_odï_cou¡
;

71 
	mph_idï
[
X86_UINST_MAX_IDEPS
];

72 
	mph_odï
[
X86_UINST_MAX_ODEPS
];

73 
	mph_oodï
[
X86_UINST_MAX_ODEPS
];

76 
	mö_„tch_queue
 : 1;

77 
	mö_u›_queue
 : 1;

78 
	mö_iq
 : 1;

79 
	mö_lq
 : 1;

80 
	mö_sq
 : 1;

81 
	mö_¥eq
 : 1;

82 
	mö_evít_queue
 : 1;

83 
	mö_rob
 : 1;

84 
	mö_u›_åa˚_li°
 : 1;

87 
	mªady
;

88 
	missued
;

89 
	mcom∂ëed
;

92 
	mphy_addr
;

95 
	mwhí
;

96 
	missue_åy_whí
;

97 
	missue_whí
;

100 
	m¥ed
;

101 
	mbimod_ödex
, 
	mbimod_¥ed
;

102 
	mtwﬁevñ_bht_ödex
, 
	mtwﬁevñ_pht_row
, 
	mtwﬁevñ_pht_cﬁ
, 
	mtwﬁevñ_¥ed
;

103 
	mchoi˚_ödex
, 
	mchoi˚_¥ed
;

106 
x86_u›_t
 *
x86_u›_¸óã
();

107 
x86_u›_‰ì_if_nŸ_queued
(
x86_u›_t
 *
u›
);

108 
x86_u›_dump
(
x86_u›_t
 *
u›
, 
FILE
 *
f
);

110 
x86_u›_exi°s
(
x86_u›_t
 *
u›
);

111 
x86_u›_cou¡_dïs
(
x86_u›_t
 *
u›
);

113 
	glöked_li°_t
;

114 
x86_u›_li°_dump
(
li°_t
 *
u›_li°
, 
FILE
 *
f
);

115 
x86_u›_löked_li°_dump
(
löked_li°_t
 *
u›_li°
, 
FILE
 *
f
);

	@writeback.c

21 
	~<lib/esim/åa˚.h
>

22 
	~<lib/utû/löked-li°.h
>

24 
	~"c‹e.h
"

25 
	~"˝u.h
"

26 
	~"ªcovî.h
"

27 
	~"ªg-fûe.h
"

28 
	~"thªad.h
"

29 
	~"wrôeback.h
"

37 
	$X86C‹eWrôeback
(
X86C‹e
 *
£lf
)

39 
X86Cpu
 *
˝u
 = 
£lf
->cpu;

40 
X86Thªad
 *
thªad
;

42 
x86_u›_t
 *
u›
;

44 
ªcovî
 = 0;

49 
	`löked_li°_hód
(
£lf
->
evít_queue
);

50 
u›
 = 
	`löked_li°_gë
(
£lf
->
evít_queue
);

51 i‡(!
u›
)

56 i‡(
u›
->
Êags
 & 
X86_UINST_MEM
)

57 
u›
->
whí
 = 
	`asTimög
(
˝u
)->
cy˛e
;

58 i‡(
u›
->
whí
 > 
	`asTimög
(
˝u
)->
cy˛e
)

62 
	`as£π
(
	`x86_u›_exi°s
(
u›
));

63 
	`as£π
(
u›
->
whí
 =
	`asTimög
(
˝u
)->
cy˛e
);

64 
	`as£π
(
u›
->
thªad
->
c‹e
 =
£lf
);

65 
	`as£π
(
u›
->
ªady
);

66 
	`as£π
(!
u›
->
com∂ëed
);

69 
	`löked_li°_ªmove
(
£lf
->
evít_queue
);

70 
u›
->
ö_evít_queue
 = 0;

71 
thªad
 = 
u›
->thread;

75 i‡(
x86_˝u_ªcovî_köd
 =
x86_˝u_ªcovî_köd_wrôeback
 &&

76 (
u›
->
Êags
 & 
X86_UINST_CTRL
Ë&& !u›->
•ecmode
 &&

77 
u›
->
√ù
 !u›->
¥ed_√ù
)

78 
ªcovî
 = 1;

83 i‡(
u›
->
ö_rob
)

84 
	`x86_åa˚
("x86.inst id=%lld core=%d stg=\"wb\"\n",

85 
u›
->
id_ö_c‹e
, 
£lf
->
id
);

88 
u›
->
com∂ëed
 = 1;

89 
	`X86ThªadWrôeU›
(
thªad
, 
u›
);

90 
£lf
->
ªg_fûe_öt_wrôes
 +
u›
->
ph_öt_odï_cou¡
;

91 
£lf
->
ªg_fûe_Â_wrôes
 +
u›
->
ph_Â_odï_cou¡
;

92 
£lf
->
iq_wakeup_ac˚s£s
++;

93 
thªad
->
ªg_fûe_öt_wrôes
 +
u›
->
ph_öt_odï_cou¡
;

94 
thªad
->
ªg_fûe_Â_wrôes
 +
u›
->
ph_Â_odï_cou¡
;

95 
thªad
->
iq_wakeup_ac˚s£s
++;

96 
	`x86_u›_‰ì_if_nŸ_queued
(
u›
);

100 i‡(
ªcovî
)

101 
	`X86ThªadRecovî
(
thªad
);

103 
	}
}

112 
	$X86CpuWrôeback
(
X86Cpu
 *
£lf
)

114 
i
;

116 
£lf
->
°age
 = "writeback";

117 
i
 = 0; i < 
x86_˝u_num_c‹es
; i++)

118 
	`X86C‹eWrôeback
(
£lf
->
c‹es
[
i
]);

119 
	}
}

	@writeback.h

20 #i‚de‡
ARCH_X86_TIMING_WRITEBACK_H


21 
	#ARCH_X86_TIMING_WRITEBACK_H


	)

23 
	~<lib/utû/˛ass.h
>

30 
X86C‹eWrôeback
(
X86C‹e
 *
£lf
);

38 
X86CpuWrôeback
(
X86Cpu
 *
£lf
);

	@
1
.
1
/usr/include
46
464
bpred.c
bpred.h
commit.c
commit.h
core.c
core.h
cpu.c
cpu.h
decode.c
decode.h
dispatch.c
dispatch.h
event-queue.c
event-queue.h
fetch-queue.c
fetch-queue.h
fetch.c
fetch.h
fu.c
fu.h
inst-queue.c
inst-queue.h
issue.c
issue.h
load-store-queue.c
load-store-queue.h
mem-config.c
mem-config.h
recover.c
recover.h
reg-file.c
reg-file.h
rob.c
rob.h
sched.c
sched.h
thread.c
thread.h
trace-cache.c
trace-cache.h
uop-queue.c
uop-queue.h
uop.c
uop.h
writeback.c
writeback.h
